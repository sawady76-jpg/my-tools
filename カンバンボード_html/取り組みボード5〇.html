<!doctype html>
<html lang="ja"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>å—ç™ºæ³¨èª² å–ã‚Šçµ„ã¿ä¸€è¦§ï¼ˆSupabaseãƒ»ãƒ­ã‚°ä»˜ããƒ»DnDå¯¾å¿œï¼‰</title>
<style>
:root{ --bg:#0a0f1f; --panel:#0e1430; --line:rgba(255,255,255,.08); --text:#e6eeff; --sub:#9bb3ff; --radius:12px; --gap:12px }
*{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
body{margin:0;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--line);background:#0e1430}
input,button,textarea{border:1px solid var(--line);border-radius:10px;background:#0e1430;color:var(--text);padding:8px 10px}
button{cursor:pointer}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
main{padding:14px}
.board{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);min-height:50vh}
.col{background:#111636;border:1px solid var(--line);border-radius:12px;display:flex;flex-direction:column;min-height:30vh}
.col-header{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
.cards{display:flex;flex-direction:column;gap:10px;padding:10px;flex:1}
.card{background:#141b44;border:1px solid var(--line);border-radius:12px;padding:10px}
.log{white-space:pre-wrap;background:#0a0f1f;border:1px solid var(--line);padding:10px;border-radius:10px;color:#b8c7ff}
.drag-over{outline:2px dashed #6ef3ff; outline-offset: -6px;}
</style></head>
<body>
<header>
  <div>ğŸ§­ å—ç™ºæ³¨èª²ï¼ˆå…±åŒãƒ»ãƒ­ã‚°ä»˜ããƒ»DnDï¼‰</div>
  <label>ãƒœãƒ¼ãƒ‰å</label><input id="boardId" placeholder="ä¾‹: kmnext-board" />
  <button id="btnJoin">å…¥å®¤</button>
  <span id="statusBadge" class="pill">æœªæ¥ç¶š</span>
  <button id="btnTest">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
  <button id="btnExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <input type="file" id="fileImport" accept="application/json" hidden />
  <button id="btnImport">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <div style="flex-basis:100%"></div>
  <section id="global-add" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start">
    <input id="gTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šè¦‹ç©ãƒ†ãƒ³ãƒ—ãƒ¬è¦‹ç›´ã—/å±±ç”°ï¼‰" style="flex:2;min-width:220px" />
    <input id="gOwner" placeholder="æ‹…å½“è€…ï¼ˆç©ºæ¬„å¯ï¼‰" style="flex:1;min-width:140px" />
    <textarea id="gDesc" rows="2" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰" style="flex:3;min-width:260px"></textarea>
    <button id="gAddBtn">ï¼‹ è¿½åŠ ï¼ˆè¨ˆç”»åˆ—ï¼‰</button>
  </section>
</header>
<main>
  <div id="log" class="log"></div>
  <section id="board" class="board"></section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
<script>
/*** Supabase æ¥ç¶šè¨­å®š ***/
const { createClient } = window.supabase;
const SUPABASE_URL = "https://yrkaznkuztyjxhfpiyjl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlya2F6bmt1enR5anhoZnBpeWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1Njk3ODksImV4cCI6MjA3MTE0NTc4OX0.47EkcDXeJ7E6iYhrR2tXGuuatEXqZxkiaxbpAkiXe4k";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const STATUSES = [
  { id:"plan", name:"è¨ˆç”»" }, { id:"do", name:"å®Ÿè¡Œ" }, { id:"check", name:"çµæœãƒã‚§ãƒƒã‚¯" }, { id:"act", name:"æŒ¯ã‚Šè¿”ã‚Š" }
];

const boardEl = document.getElementById('board');
const boardIdInput = document.getElementById('boardId');
const btnJoin = document.getElementById('btnJoin');
const statusBadge = document.getElementById('statusBadge');
const btnTest = document.getElementById('btnTest');
const logEl = document.getElementById('log');
const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');
const fileImport = document.getElementById('fileImport');

let currentBoardId = localStorage.getItem('kanban_board_id') || "";
boardIdInput.value = currentBoardId;

const log = (m)=>{ logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`; };
const clearLog = ()=>{ logEl.textContent=''; };

function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;' }[m])); }

function renderColumns(){
  boardEl.innerHTML = '';
  STATUSES.forEach(s=>{
    const col = document.createElement('div');
    col.className='col';
    col.innerHTML = `<div class="col-header"><div>${s.name}</div><span>${s.id}</span></div><div class="cards" data-status="${s.id}"></div>`;
    boardEl.appendChild(col);
  });
  enableDnD(); // â† DnDæœ‰åŠ¹åŒ–
}
function paint(cards){
  boardEl.querySelectorAll('.cards').forEach(z=> z.innerHTML='');
  const b = Object.fromEntries(STATUSES.map(s=>[s.id,[]]));
  for(const c of cards) (b[c.status]||b.plan).push(c);
  for(const k in b) b[k].sort((a,b)=> (a.pos??0)-(b.pos??0));
  for(const s of STATUSES){
    const zone = boardEl.querySelector(`.cards[data-status="${s.id}"]`);
    for(const c of b[s.id]){
      const el = document.createElement('div');
      el.className='card'; el.dataset.id=c.id;
      el.draggable = true;                        // DnDå¯èƒ½
      el.innerHTML = `<div style="font-weight:700">${escapeHtml(c.title||'ï¼ˆç„¡é¡Œï¼‰')}</div>
        <div style="margin-top:6px;color:#a8b6ff;white-space:pre-wrap">${escapeHtml(c.descr||'')}</div>
        <small>ğŸ‘¤ ${escapeHtml(c.owner||'æœªå‰²å½“')}</small>
        <small style="display:block;margin-top:6px;opacity:.7">#${String(c.id).slice(-5)}ãƒ»${s.name}</small>`;
      zone.appendChild(el);
    }
  }
}

function enableDnD(){
  let dragCard = null;
  boardEl.addEventListener('dragstart', e=>{
    const card = e.target.closest('.card'); if(!card) return;
    dragCard = card;
    e.dataTransfer.setData('text/plain', card.dataset.id);
    setTimeout(()=> card.style.opacity='.55',0);
  });
  boardEl.addEventListener('dragend', ()=>{
    if(dragCard){ dragCard.style.opacity='1'; dragCard=null; }
  });
  boardEl.querySelectorAll('.cards').forEach(zone=>{
    zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', ()=> zone.classList.remove('drag-over'));
    zone.addEventListener('drop', async e=>{
      e.preventDefault(); zone.classList.remove('drag-over');
      const id = e.dataTransfer.getData('text/plain');
      const newStatus = zone.dataset.status;
      await moveCard(id, newStatus);
    });
  });
}

async function fetchAll(){
  try{
    const { data, error } = await sb.from('kanban_cards').select('*').eq('board_id', currentBoardId);
    if(error){ log(`âŒ SELECTå¤±æ•—: ${error.message}`); statusBadge.textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; return []; }
    statusBadge.textContent = `æ¥ç¶šä¸­ï¼š${currentBoardId}`;
    return data||[];
  }catch(e){ log(`âŒ ä¾‹å¤–: ${e.message}`); return []; }
}
async function addCardDefault({title, descr, owner}){
  try{
    const { data: rows } = await sb.from('kanban_cards').select('pos').eq('board_id', currentBoardId).eq('status','plan');
    const nextPos = (rows||[]).reduce((m,r)=>Math.max(m, r.pos||0), 0) + 1;
    const { error } = await sb.from('kanban_cards').insert([{ board_id: currentBoardId, status:'plan', title, descr, owner, pos: nextPos }]);
    if(error){ log(`âŒ è¿½åŠ å¤±æ•—: ${error.message}`); alert('è¿½åŠ ã«å¤±æ•—ï¼ˆãƒ­ã‚°å‚ç…§ï¼‰'); }
    else { log('âœ… è¿½åŠ OK'); }
  }catch(e){ log(`âŒ ä¾‹å¤–: ${e.message}`); }
}
async function moveCard(id, newStatus){
  const { data: rows } = await sb.from('kanban_cards').select('pos').eq('board_id', currentBoardId).eq('status', newStatus);
  const nextPos = (rows||[]).reduce((m,r)=>Math.max(m, r.pos||0), 0) + 1;
  await sb.from('kanban_cards').update({ status: newStatus, pos: nextPos }).eq('id', id).eq('board_id', currentBoardId);
}
async function subscribeBoard(boardId){
  try{
    if (window._ch) { await window._ch.unsubscribe(); window._ch=null; }
    window._ch = sb.channel('kanban-'+boardId)
      .on('postgres_changes',{ event:'*', schema:'public', table:'kanban_cards', filter:`board_id=eq.${boardId}` },
        async ()=>{ const rows = await fetchAll(); paint(rows); })
      .subscribe(async (status)=>{
        log(`ğŸ”Œ Realtime: ${status}`);
        statusBadge.textContent = (status==='SUBSCRIBED') ? `æ¥ç¶šä¸­ï¼š${boardId}` : `æ¥ç¶š: ${status}`;
        if(status==='SUBSCRIBED'){ renderColumns(); const rows = await fetchAll(); paint(rows); }
      });
  }catch(e){ log(`âŒ Realtimeä¾‹å¤–: ${e.message}`); }
}

// æ¥ç¶šãƒ†ã‚¹ãƒˆ
btnTest.onclick = async ()=>{
  clearLog();
  log('ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
  try{
    const { error } = await sb.from('kanban_cards').select('id').limit(1);
    if(error){ log(`âŒ SELECTã‚¨ãƒ©ãƒ¼: ${error.message}`); alert('æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—ï¼ˆãƒ­ã‚°å‚ç…§ï¼‰'); }
    else { log('âœ… SELECTæˆåŠŸï¼ˆæ¥ç¶šOKï¼‰'); alert('æ¥ç¶šOKã€‚æ¬¡ã«ã€Œå…¥å®¤ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); }
  }catch(e){ log(`âŒ ä¾‹å¤–: ${e.message}`); alert('æ¥ç¶šãƒ†ã‚¹ãƒˆä¾‹å¤–ï¼ˆãƒ­ã‚°å‚ç…§ï¼‰'); }
};

// å…¥å®¤
btnJoin.onclick = ()=>{
  const id = (boardIdInput.value||'').trim();
  if(!id){ alert('ãƒœãƒ¼ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  currentBoardId = id;
  localStorage.setItem('kanban_board_id', currentBoardId);
  log(`ğŸšª å…¥å®¤: ${currentBoardId}`);
  subscribeBoard(currentBoardId);
};

// è¿½åŠ 
document.getElementById('gAddBtn').onclick = async ()=>{
  const title = (document.getElementById('gTitle').value||'').trim();
  let owner = (document.getElementById('gOwner').value||'').trim();
  const descr = (document.getElementById('gDesc').value||'').trim();
  if(!title) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(title.includes('/') && !owner){ const parts = title.split('/'); owner = parts.pop().trim(); }
  await addCardDefault({ title, descr, owner });
};

renderColumns(); // åˆå›ã¯å…¥å®¤ã—ãªã„
</script>
</body></html>
