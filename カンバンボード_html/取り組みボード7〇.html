<!doctype html>
<html lang="ja"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>å—ç™ºæ³¨èª² å–ã‚Šçµ„ã¿ä¸€è¦§ï¼ˆå‰Šé™¤å³æ™‚åæ˜ ï¼‹åˆ—åˆ¥ã‚½ãƒ¼ãƒˆï¼‰</title>
<style>
:root{ --bg:#0a0f1f; --panel:#0e1430; --line:rgba(255,255,255,.08); --text:#e6eeff; --sub:#9bb3ff; --radius:12px; --gap:12px }
*{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
body{margin:0;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:5;display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:10px 14px;border-bottom:1px solid var(--line);background:#0e1430}
input,button,textarea{border:1px solid var(--line);border-radius:10px;background:#0e1430;color:var(--text);padding:8px 10px}
button{cursor:pointer}
button.ghost{background:transparent;border:1px solid var(--line)}
.pill{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
main{padding:14px}
.board{display:grid;grid-template-columns:repeat(4,1fr);gap:var(--gap);min-height:50vh}
.col{background:#111636;border:1px solid var(--line);border-radius:12px;display:flex;flex-direction:column;min-height:30vh}
.col-header{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
.col-tools{display:flex;gap:6px;align-items:center}
.cards{display:flex;flex-direction:column;gap:10px;padding:10px;flex:1}
.card{background:#141b44;border:1px solid var(--line);border-radius:12px;padding:10px}
.card small{color:#a8b6ff}
.log{white-space:pre-wrap;background:#0a0f1f;border:1px solid var(--line);padding:10px;border-radius:10px;color:#b8c7ff}
.drag-over{outline:2px dashed #6ef3ff; outline-offset: -6px;}
.actions{display:flex;gap:6px}
.badge{font-size:11px;border:1px solid var(--line);border-radius:999px;padding:2px 6px;opacity:.8}
</style></head>
<body>
<header>
  <div>ğŸ§­ å—ç™ºæ³¨èª²ï¼ˆå…±åŒãƒ»DnDãƒ»ç·¨é›†/å‰Šé™¤ãƒ»åˆ—åˆ¥ã‚½ãƒ¼ãƒˆï¼‰</div>
  <label>ãƒœãƒ¼ãƒ‰å</label><input id="boardId" placeholder="ä¾‹: kmnext-board" />
  <button id="btnJoin">å…¥å®¤</button>
  <span id="statusBadge" class="pill">æœªæ¥ç¶š</span>
  <button id="btnTest" class="ghost">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
  <button id="btnExport" class="ghost">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  <input type="file" id="fileImport" accept="application/json" hidden />
  <button id="btnImport" class="ghost">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
  <div style="flex-basis:100%"></div>
  <section id="global-add" style="display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start">
    <input id="gTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä¾‹ï¼šè¦‹ç©ãƒ†ãƒ³ãƒ—ãƒ¬è¦‹ç›´ã—/å±±ç”°ï¼‰" style="flex:2;min-width:220px" />
    <input id="gOwner" placeholder="æ‹…å½“è€…ï¼ˆç©ºæ¬„å¯ï¼‰" style="flex:1;min-width:140px" />
    <textarea id="gDesc" rows="2" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰" style="flex:3;min-width:260px"></textarea>
    <button id="gAddBtn" class="ghost">ï¼‹ è¿½åŠ ï¼ˆè¨ˆç”»åˆ—ï¼‰</button>
  </section>
</header>
<main>
  <div id="log" class="log"></div>
  <section id="board" class="board"></section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
<script>
/*** Supabase æ¥ç¶šè¨­å®š ***/
const { createClient } = window.supabase;
const SUPABASE_URL = "https://yrkaznkuztyjxhfpiyjl.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlya2F6bmt1enR5anhoZnBpeWpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1Njk3ODksImV4cCI6MjA3MTE0NTc4OX0.47EkcDXeJ7E6iYhrR2tXGuuatEXqZxkiaxbpAkiXe4k";
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const STATUSES = [
  { id:"plan", name:"è¨ˆç”»" }, { id:"do", name:"å®Ÿè¡Œ" }, { id:"check", name:"çµæœãƒã‚§ãƒƒã‚¯" }, { id:"act", name:"æŒ¯ã‚Šè¿”ã‚Š" }
];

const SORT_STATE = { plan:null, do:null, check:null, act:null }; // null| 'asc' | 'desc' ï¼ˆåˆ—ã”ã¨ï¼‰
let _cards = []; // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå‰Šé™¤å³æ™‚åæ˜ /ä¸¦ã³æ›¿ãˆç”¨ï¼‰

const boardEl = document.getElementById('board');
const boardIdInput = document.getElementById('boardId');
const btnJoin = document.getElementById('btnJoin');
const statusBadge = document.getElementById('statusBadge');
const btnTest = document.getElementById('btnTest');
const logEl = document.getElementById('log');
const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');
const fileImport = document.getElementById('fileImport');

let currentBoardId = localStorage.getItem('kanban_board_id') || "";
boardIdInput.value = currentBoardId;

const log = (m)=>{ logEl.textContent += `[${new Date().toLocaleTimeString()}] ${m}\n`; };
const clearLog = ()=>{ logEl.textContent=''; };

function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;' }[m])); }
function fmtTime(ts){ if(!ts) return ""; try{ const d = new Date(ts); return d.toLocaleString(); }catch{ return String(ts); } }

/* ========== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========== */
function renderColumns(){
  boardEl.innerHTML = '';
  STATUSES.forEach(s=>{
    const col = document.createElement('div');
    col.className='col';
    col.innerHTML = `
      <div class="col-header">
        <div>${s.name} <span class="badge">${s.id}</span></div>
        <div class="col-tools" data-status="${s.id}">
          <span style="opacity:.75;font-size:12px">ä¸¦ã³æ›¿ãˆï¼š</span>
          <button class="ghost sort-btn" data-sort="toggle" title="ã‚¿ã‚¤ãƒˆãƒ«ã§æ˜‡é †/é™é †/é€šå¸¸ã‚’åˆ‡æ›¿">â€”</button>
          <span class="badge sort-label">é€šå¸¸</span>
        </div>
      </div>
      <div class="cards" data-status="${s.id}"></div>`;
    boardEl.appendChild(col);
  });
  // ã‚½ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  document.querySelectorAll('.col-tools').forEach(tool=>{
    const st = tool.dataset.status;
    const btn = tool.querySelector('.sort-btn');
    const label = tool.querySelector('.sort-label');
    btn.addEventListener('click', ()=>{
      // null -> asc -> desc -> null
      SORT_STATE[st] = (SORT_STATE[st]==null) ? 'asc' : (SORT_STATE[st]==='asc' ? 'desc' : null);
      label.textContent = SORT_STATE[st]==='asc' ? 'æ˜‡é †' : SORT_STATE[st]==='desc' ? 'é™é †' : 'é€šå¸¸';
      paint(_cards); // ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å†æç”»
    });
  });
  enableDnD(); // DnDæœ‰åŠ¹åŒ–
}

/* ========== æç”»ï¼ˆã‚½ãƒ¼ãƒˆå¯¾å¿œï¼‰ ========== */
function paint(cards){
  _cards = Array.isArray(cards) ? cards.slice() : [];
  boardEl.querySelectorAll('.cards').forEach(z=> z.innerHTML='');

  const buckets = Object.fromEntries(STATUSES.map(s=>[s.id, []]));
  for(const c of _cards) (buckets[c.status] || buckets.plan).push(c);

  for(const s of STATUSES){
    const order = SORT_STATE[s.id]; // null|asc|desc
    const arr = buckets[s.id];

    arr.sort((a,b)=>{
      if(order===null){
        // æ—¢å®šï¼šposï¼ˆå¾“æ¥ã®è¦‹ãŸç›®ã‚’å„ªå…ˆï¼‰
        const pa = a.pos ?? 0, pb = b.pos ?? 0;
        return pa - pb;
      }else{
        const ta = (a.title||'').toLocaleLowerCase();
        const tb = (b.title||'').toLocaleLowerCase();
        if(ta<tb) return order==='asc' ? -1 : 1;
        if(ta>tb) return order==='asc' ? 1 : -1;
        // ã‚¿ã‚¤ãƒˆãƒ«åŒå€¤ãªã‚‰posã§å®‰å®šåŒ–
        const pa = a.pos ?? 0, pb = b.pos ?? 0;
        return pa - pb;
      }
    });

    const zone = document.querySelector(`.cards[data-status="${s.id}"]`);
    for(const c of arr){
      const el = document.createElement('div');
      el.className='card'; el.dataset.id=c.id;
      el.draggable = true;
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:flex-start">
          <div class="field-title" style="font-weight:700;line-height:1.3">${escapeHtml(c.title||'ï¼ˆç„¡é¡Œï¼‰')}</div>
          <div class="actions">
            <button class="ghost" data-act="edit" title="ç·¨é›†">ç·¨é›†</button>
            <button class="ghost" data-act="del" title="å‰Šé™¤">å‰Šé™¤</button>
          </div>
        </div>
        <div class="field-descr" style="margin-top:6px;white-space:pre-wrap">${escapeHtml(c.descr||'')}</div>
        <small style="display:block;margin-top:6px">ğŸ‘¤ <span class="field-owner">${escapeHtml(c.owner||'æœªå‰²å½“')}</span></small>
        <small style="display:block;margin-top:6px;opacity:.7">#${String(c.id).slice(-5)}ãƒ»${s.name}ãƒ»æœ€çµ‚æ›´æ–°: <span class="field-updated">${fmtTime(c.updated_at)||'-'}</span></small>
      `;
      // å‰Šé™¤ï¼ˆå³æ™‚åæ˜ ï¼‹DBï¼‰
      el.querySelector('[data-act="del"]').addEventListener('click', async ()=>{
        if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        // æ¥½è¦³çš„ã«å³æ™‚åæ˜ 
        el.remove();
        _cards = _cards.filter(x=> x.id !== c.id);
        const { error } = await sb.from('kanban_cards').delete().eq('id', c.id).eq('board_id', currentBoardId);
        if(error){
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          // å¤±æ•—ã—ãŸã‚‰å†å–å¾—ã§å¾©å…ƒ
          const rows = await fetchAll(true); paint(rows);
        }
      });
      // ç·¨é›†ï¼ˆãƒœã‚¿ãƒ³â†’ã‚¿ã‚¤ãƒˆãƒ«ç·¨é›†ï¼‰
      el.querySelector('[data-act="edit"]').addEventListener('click', ()=>{
        const t = el.querySelector('.field-title');
        if(t) t.dispatchEvent(new Event('dblclick'));
      });
      // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†
      makeEditable(el.querySelector('.field-title'), ()=>c.title||'', v=> updateCard(c.id,{ title:v||'ï¼ˆç„¡é¡Œï¼‰' }), false);
      makeEditable(el.querySelector('.field-descr'), ()=>c.descr||'', v=> updateCard(c.id,{ descr:v||'' }), true);
      makeEditable(el.querySelector('.field-owner'), ()=>c.owner||'', v=> updateCard(c.id,{ owner:v||'' }), false);

      zone.appendChild(el);
    }
  }
}

/* ========== ç·¨é›†UI ========== */
function makeEditable(el, getter, setter, multiline=false){
  if(!el) return;
  el.style.cursor = 'text';
  el.addEventListener('dblclick', ()=>{
    const editor = multiline ? document.createElement('textarea') : document.createElement('input');
    editor.value = getter();
    editor.style.width = '100%'; editor.style.font='inherit'; editor.style.color='inherit';
    editor.style.background='rgba(255,255,255,.08)'; editor.style.border='1px solid var(--line)';
    editor.style.borderRadius='8px'; editor.style.padding='6px 8px';
    const prev = el.innerHTML;
    el.innerHTML=''; el.appendChild(editor); editor.focus(); if(!multiline) editor.select();
    const commit = async ()=>{ const v = multiline?editor.value:editor.value.trim(); await setter(v); };
    const cancel = ()=>{ el.innerHTML = prev; };
    editor.addEventListener('keydown', (e)=>{ if(!multiline && e.key==='Enter'){ e.preventDefault(); commit(); } if(e.key==='Escape'){ e.preventDefault(); cancel(); }});
    editor.addEventListener('blur', ()=>{ commit(); }, { once:true });
  });
}

/* ========== DnD ========== */
function enableDnD(){
  let dragCard = null;
  boardEl.addEventListener('dragstart', e=>{
    const card = e.target.closest('.card'); if(!card) return;
    dragCard = card;
    e.dataTransfer.setData('text/plain', card.dataset.id);
    setTimeout(()=> card.style.opacity='.55',0);
  });
  boardEl.addEventListener('dragend', ()=>{ if(dragCard){ dragCard.style.opacity='1'; dragCard=null; } });
  boardEl.querySelectorAll('.cards').forEach(zone=>{
    zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.classList.add('drag-over'); });
    zone.addEventListener('dragleave', ()=> zone.classList.remove('drag-over'));
    zone.addEventListener('drop', async e=>{
      e.preventDefault(); zone.classList.remove('drag-over');
      const id = e.dataTransfer.getData('text/plain');
      const newStatus = zone.dataset.status;
      await moveCard(id, newStatus);
    });
  });
}

/* ========== DB I/O ========== */
async function fetchAll(silent=false){
  try{
    const { data, error } = await sb.from('kanban_cards').select('*').eq('board_id', currentBoardId);
    if(error){ if(!silent) log(`âŒ SELECTå¤±æ•—: ${error.message}`); statusBadge.textContent='èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼'; return []; }
    statusBadge.textContent = `æ¥ç¶šä¸­ï¼š${currentBoardId}`;
    _cards = data||[];
    return _cards;
  }catch(e){ if(!silent) log(`âŒ ä¾‹å¤–: ${e.message}`); return []; }
}
async function addCardDefault({title, descr, owner}){
  try{
    const { data: rows } = await sb.from('kanban_cards').select('pos').eq('board_id', currentBoardId).eq('status','plan');
    const nextPos = (rows||[]).reduce((m,r)=>Math.max(m, r.pos||0), 0) + 1;
    const { error } = await sb.from('kanban_cards').insert([{ board_id: currentBoardId, status:'plan', title, descr, owner, pos: nextPos }]);
    if(error){ log(`âŒ è¿½åŠ å¤±æ•—: ${error.message}`); alert('è¿½åŠ ã«å¤±æ•—ï¼ˆãƒ­ã‚°å‚ç…§ï¼‰'); }
    else { log('âœ… è¿½åŠ OK'); }
  }catch(e){ log(`âŒ ä¾‹å¤–: ${e.message}`); }
}
async function updateCard(id, patch){
  // DBå´ãƒˆãƒªã‚¬ã§ updated_at ãŒè‡ªå‹•æ›´æ–°
  const { error } = await sb.from('kanban_cards').update({ ...patch }).eq('id', id).eq('board_id', currentBoardId);
  if(error){ log(`âŒ æ›´æ–°å¤±æ•—: ${error.message}`); }
}
async function moveCard(id, newStatus){
  const { data: rows } = await sb.from('kanban_cards').select('pos').eq('board_id', currentBoardId).eq('status', newStatus);
  const nextPos = (rows||[]).reduce((m,r)=>Math.max(m, r.pos||0), 0) + 1;
  await sb.from('kanban_cards').update({ status: newStatus, pos: nextPos }).eq('id', id).eq('board_id', currentBoardId);
}

/* ========== Realtime ========== */
async function subscribeBoard(boardId){
  try{
    if (window._ch) { await window._ch.unsubscribe(); window._ch=null; }
    window._ch = sb.channel('kanban-'+boardId)
      .on('postgres_changes',{ event:'*', schema:'public', table:'kanban_cards', filter:`board_id=eq.${boardId}` },
        async ()=>{ const rows = await fetchAll(true); paint(rows); })
      .subscribe(async (status)=>{
        log(`ğŸ”Œ Realtime: ${status}`);
        statusBadge.textContent = (status==='SUBSCRIBED') ? `æ¥ç¶šä¸­ï¼š${boardId}` : `æ¥ç¶š: ${status}`;
        if(status==='SUBSCRIBED'){ renderColumns(); const rows = await fetchAll(true); paint(rows); }
      });
  }catch(e){ log(`âŒ Realtimeä¾‹å¤–: ${e.message}`); }
}

/* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
// æ¥ç¶šãƒ†ã‚¹ãƒˆ
btnTest.onclick = async ()=>{
  clearLog(); log('ğŸ§ª æ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
  try{
    const { error } = await sb.from('kanban_cards').select('id').limit(1);
    if(error){ log(`âŒ SELECTã‚¨ãƒ©ãƒ¼: ${error.message}`); alert('æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—ï¼ˆãƒ­ã‚°å‚ç…§ï¼‰'); }
    else { log('âœ… SELECTæˆåŠŸï¼ˆæ¥ç¶šOKï¼‰'); alert('æ¥ç¶šOKã€‚æ¬¡ã«ã€Œå…¥å®¤ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); }
  }catch(e){ log(`âŒ ä¾‹å¤–: ${e.message}`); alert('æ¥ç¶šãƒ†ã‚¹ãƒˆä¾‹å¤–ï¼ˆãƒ­ã‚°å‚ç…§ï¼‰'); }
};
// å…¥å®¤
btnJoin.onclick = ()=>{
  const id = (boardIdInput.value||'').trim();
  if(!id){ alert('ãƒœãƒ¼ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  currentBoardId = id;
  localStorage.setItem('kanban_board_id', currentBoardId);
  log(`ğŸšª å…¥å®¤: ${currentBoardId}`);
  subscribeBoard(currentBoardId);
};
// è¿½åŠ 
document.getElementById('gAddBtn').onclick = async ()=>{
  const title = (document.getElementById('gTitle').value||'').trim();
  let owner = (document.getElementById('gOwner').value||'').trim();
  const descr = (document.getElementById('gDesc').value||'').trim();
  if(!title) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  if(title.includes('/') && !owner){ const parts = title.split('/'); owner = parts.pop().trim(); }
  await addCardDefault({ title, descr, owner });
};

renderColumns(); // åˆå›ã¯å…¥å®¤ã—ãªã„
</script>
</body></html>
