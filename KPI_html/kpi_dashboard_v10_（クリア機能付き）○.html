<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI Dashboard v10ï¼ˆæ¯”ç‡è¿½åŠ ãƒ»å°å‹ã‚°ãƒ©ãƒ•ï¼‹PNGä¿å­˜ï¼‹è²¼ã‚Šä»˜ã‘å–è¾¼ï¼‹å…¨ã‚¯ãƒªã‚¢ï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", "Meiryo", sans-serif; margin:16px;}
    h1{margin:8px 0 12px}
    section{margin:18px 0}
    .charts{display:grid;grid-template-columns:repeat(2, minmax(320px, 1fr));gap:16px}
    .panel{border:1px solid #ddd;border-radius:10px;padding:10px}
    .panel h3{margin:0 0 8px;display:flex;justify-content:space-between;align-items:center;font-size:16px;gap:8px}
    .btn{font-size:12px;padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}
    .btn.danger{border-color:#e03131;color:#e03131}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #ccc;padding:4px 6px;text-align:right}
    th:first-child,td:first-child{text-align:left}
    input[type=number]{width:100%;box-sizing:border-box}
    textarea{width:100%;height:120px;box-sizing:border-box}
    .muted{color:#666;font-size:12px}
    .controls{display:flex;gap:8px;align-items:center}
    #testLog{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;max-height:200px;overflow:auto}
  </style>
</head>
<body>
  <h1>å—ç™ºæ³¨èª² KPI ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <section class="panel">
    <h3>
      <span>è²¼ã‚Šä»˜ã‘ã¦å–è¾¼</span>
      <span class="controls">
        <label style="font-size:12px;display:flex;gap:4px;align-items:center"><input type="checkbox" id="replaceMode"> è²¼ã‚Šä»˜ã‘æœˆã§ç½®ãæ›ãˆï¼ˆæ—§æœˆã‚’å‰Šé™¤ï¼‰</label>
        <button class="btn" id="btnImport">â¬ å–è¾¼</button>
        <button class="btn danger" id="btnClear" title="ã™ã¹ã¦ã®æœˆã¨æ•°å€¤ã‚’ç©ºã«ã—ã¾ã™">ğŸ§¹ å…¨ã‚¯ãƒªã‚¢</button>
      </span>
    </h3>
    <div>1è¡Œç›®ã€Œæœˆã€ã€2è¡Œç›®ä»¥é™ã€Œæ®‹æ¥­æ™‚é–“ / å—æ³¨ä»¶æ•° / ç€ä¿¡æ•°/æ—¥ / å—ä¿¡æ•°/æ—¥ / å¿œç­”ç‡ / å—ç™ºæ³¨èª²å‡¦ç†æ¯”ç‡ã€ã€‚<br>Excelç­‰ã‹ã‚‰ãã®ã¾ã¾ <b>ã‚¿ãƒ–åŒºåˆ‡ã‚Š</b> ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆç©ºæ¬„OKï¼‰ã€‚åŒã˜æœˆã¯ä¸Šæ›¸ãã€æ–°ã—ã„æœˆã¯å³ç«¯ã«è¿½åŠ ã—ã¾ã™ã€‚</div>
    <textarea id="pasteArea" placeholder="æœˆ\tJan-25\tFeb-25\t...\næ®‹æ¥­æ™‚é–“\t12.7\t12.7\t...\nå—æ³¨ä»¶æ•°\t23216\t22600\t...\nç€ä¿¡æ•°/æ—¥\t\t2208\t...\nå—ä¿¡æ•°/æ—¥\t2195\t2103\t...\nå¿œç­”ç‡\t95.3\t96.4\t...\nå—ç™ºæ³¨èª²å‡¦ç†æ¯”ç‡\t74.2\t75.3\t..."></textarea>
    <div class="muted">â€»ã€ŒğŸ§¹ å…¨ã‚¯ãƒªã‚¢ã€ã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ï¼ˆå†å–è¾¼ã§å¾©å…ƒå¯èƒ½ï¼‰ã€‚</div>
  </section>

  <section class="panel">
    <h3>ã‚°ãƒ©ãƒ•</h3>
    <div class="charts">
      <div class="panel">
        <h3><span>æ®‹æ¥­æ™‚é–“ï¼ˆå·¦è»¸ãƒ»hï¼‰Ã— å—æ³¨ä»¶æ•°ï¼ˆå³è»¸ãƒ»ä»¶ï¼‰</span>
          <button class="btn" data-png="chart_ov_orders">ğŸ–¼ PNG</button>
        </h3>
        <canvas id="chart_ov_orders" width="480" height="220"></canvas>
      </div>
      <div class="panel">
        <h3><span>ç€ä¿¡ / æ—¥ ï¼† å—ä¿¡ / æ—¥ï¼ˆåŒä¸€ã‚°ãƒ©ãƒ•ï¼‰</span>
          <button class="btn" data-png="chart_in_recv">ğŸ–¼ PNG</button>
        </h3>
        <canvas id="chart_in_recv" width="480" height="220"></canvas>
      </div>
      
      <div class="panel">
        <h3><span>å¿œç­”ç‡</span>
          <button class="btn" data-png="chart_rate">ğŸ–¼ PNG</button>
        </h3>
        <canvas id="chart_rate" width="480" height="220"></canvas>
      </div>
      <div class="panel">
        <h3><span>å—ç™ºæ³¨èª²å‡¦ç†æ¯”ç‡</span>
          <button class="btn" data-png="chart_ratio">ğŸ–¼ PNG</button>
        </h3>
        <canvas id="chart_ratio" width="480" height="220"></canvas>
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«</h3>
    <div id="tableWrap"></div>
  </section>

  <section class="panel">
    <h3>ãƒ†ã‚¹ãƒˆ</h3>
    <div class="controls">
      <button class="btn" id="btnRunTests">ğŸ§ª Run tests</button>
      <div class="muted">ï¼ˆçµæœã¯ä¸‹ã«è¡¨ç¤º & ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›ï¼‰</div>
    </div>
    <pre id="testLog"></pre>
  </section>

  <script>
    // ===== åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆv9ã¨åŒã˜ã‚µãƒ³ãƒ—ãƒ«ã‚’åˆæœŸè¡¨ç¤ºï¼‰ =====
    let months=['Jan-25','Feb-25','Mar-25','Apr-25','May-25','Jun-25','Jul-25','Aug-25'];
    let data={
      overtime:[12.7,12.7,11.5,12.7,11.5,13.2,13.9,9.1],
      orders:[23216,22600,22811,23489,23101,24224,26981,18883],
      inbound:[null,2208,2037,2022,1994,2196,2197,2089],
      received:[2195,2103,1830,1918,1776,2077,2078,1974],
      answerRT:[95.3,96.4,94.6,94.9,94.6,94.6,94.6,94.48],
      ratio:[74.2,75.3,74.1,74.5,76.5,75.8,77.4,77.3]
    };

    // ===== å–è¾¼ï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰ =====
    function parsePasted(text){
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(s=>s.trim()!=='');
      const rows = lines.map(line=> line.split('\t'));
      if(rows.length<2) return;
      const newMonths = rows[0].slice(1).map(s=>String(s||'').trim()).filter(Boolean);
      const map={'æ®‹æ¥­æ™‚é–“':'overtime','å—æ³¨ä»¶æ•°':'orders','ç€ä¿¡æ•°/æ—¥':'inbound','å—ä¿¡æ•°/æ—¥':'received','å¿œç­”ç‡':'answerRT','å—ç™ºæ³¨èª²å‡¦ç†æ¯”ç‡':'ratio'};
      const next={overtime:[],orders:[],inbound:[],received:[],answerRT:[],ratio:[]};
      for(const r of rows.slice(1)){
        const key=map[(r[0]||'').trim()]; if(!key) continue;
        next[key]=r.slice(1).map(x=>{
          const t=String(x??'').trim().replace(/,/g,'');
          if(t==='') return null;
          const n=Number(t); return Number.isFinite(n)?n:null;
        });
      }
      // å³ã«æ‹¡å¼µï¼åŒåã¯ä¸Šæ›¸ã
      const idx=new Map(months.map((m,i)=>[m,i]));
      for(let i=0;i<newMonths.length;i++){
        const m=newMonths[i];
        if(idx.has(m)){
          const k=idx.get(m);
          ['overtime','orders','inbound','received','answerRT','ratio'].forEach(s=>data[s][k]=next[s][i]??null);
        }else{
          months.push(m);
          ['overtime','orders','inbound','received','answerRT','ratio'].forEach(s=>data[s].push(next[s][i]??null));
        }
      }
    }

    document.getElementById('btnImport').addEventListener('click',()=>{
      const raw=document.getElementById('pasteArea').value;
      if(!raw.trim()) { alert('è²¼ã‚Šä»˜ã‘ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™'); return; }

      if(document.getElementById('replaceMode')?.checked){
        clearAll();
      }

      const monthAbbr=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      function normMonth(s){
        const _r=String(s||'').trim(); if(!_r) return '';
        let m = _r.match(/^(\d{4})\s*å¹´\s*(\d{1,2})\s*æœˆ$/);
        if(m){ const y=+m[1], mo=+m[2]; return monthAbbr[mo-1] + '-' + String(y).slice(-2); }
        m = _r.match(/^(\d{4})[\/\.-](\d{1,2})$/);
        if(m){ const y=+m[1], mo=+m[2]; return monthAbbr[mo-1] + '-' + String(y).slice(-2); }
        m = _r.match(/^(\d{1,2})[\/\.-](\d{2,4})$/);
        if(m){ let mo=+m[1]; let y=+m[2]; if(y<100) y=2000+y; return monthAbbr[mo-1] + '-' + String(y).slice(-2); }
        m = _r.match(/^(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d{2})$/);
        if(m) return _r;
        return _r;
      }
      // ï¼…è¨˜å·ã®é™¤å» & æœˆåã®æ­£è¦åŒ–ï¼ˆ1è¡Œç›®ï¼‰
      const lines=raw.replace(/%/g,'').replace(/ï¼…/g,'').split(/\r?\n/);
      if(lines.length){
        const head=lines[0].split('\t');
        for(let i=1;i<head.length;i++){ head[i]=normMonth(head[i]); }
        lines[0]=head.join('\t');
      }
      const t=lines.join('\n'); // â† ã“ã“ãŒåŸå› ã ã£ãŸï¼ˆæ”¹è¡Œã®å…¥ã‚Œå­ã‚’ä¿®æ­£ï¼‰

      parsePasted(t); buildTable(); renderCharts();
    });

    // ===== å…¨ã‚¯ãƒªã‚¢ =====
    function clearAll(){
      months = [];
      data = {overtime:[],orders:[],inbound:[],received:[],answerRT:[],ratio:[]};
      document.getElementById('pasteArea').value='';
      buildTable();
      renderCharts();
    }

    document.getElementById('btnClear').addEventListener('click',()=>{
      if(confirm('è²¼ã‚Šä»˜ã‘å–è¾¼ãƒ‡ãƒ¼ã‚¿ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚°ãƒ©ãƒ•ã‚’ã™ã¹ã¦ç©ºã«ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')){
        clearAll();
      }
    });

    // ===== ãƒ†ãƒ¼ãƒ–ãƒ« =====
    function buildTable(){
      const wrap=document.getElementById('tableWrap'); wrap.innerHTML='';
      const tbl=document.createElement('table');
      const thead=document.createElement('thead');
      const trh=document.createElement('tr');
      const th0=document.createElement('th'); th0.textContent='KPI/æœˆ'; trh.appendChild(th0);
      for(const m of months){ const th=document.createElement('th'); th.textContent=m; trh.appendChild(th); }
      thead.appendChild(trh); tbl.appendChild(thead);
      const tbody=document.createElement('tbody');
      const defs=[["æ®‹æ¥­æ™‚é–“","overtime"],["å—æ³¨ä»¶æ•°","orders"],["ç€ä¿¡æ•° / æ—¥","inbound"],["å—ä¿¡æ•° / æ—¥","received"],["å¿œç­”ç‡","answerRT"],["å—ç™ºæ³¨èª²å‡¦ç†æ¯”ç‡","ratio"]];
      for(const [label,key] of defs){
        const tr=document.createElement('tr');
        const th=document.createElement('th'); th.textContent=label; tr.appendChild(th);
        for(let i=0;i<months.length;i++){
          const td=document.createElement('td');
          const inp=document.createElement('input'); inp.type='number'; inp.step='any';
          const v=data[key][i]; inp.value = (v==null||isNaN(v))? '' : String(v);
          inp.addEventListener('input',()=>{ data[key][i]=inp.value===''?null:Number(inp.value); renderCharts(); });
          td.appendChild(inp); tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
      // æœˆãŒ0ä»¶ã®ã¨ãã®æ¡ˆå†…
      if(months.length===0){
        const tr=document.createElement('tr');
        const td=document.createElement('td'); td.colSpan=1; td.innerHTML='<span class="muted">â€» ç¾åœ¨ãƒ‡ãƒ¼ã‚¿ã¯ç©ºã§ã™ã€‚ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã‚¿ãƒ–åŒºåˆ‡ã‚Šã§è²¼ã‚Šä»˜ã‘ã¦ã€Œå–è¾¼ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>';
        tr.appendChild(td); tbody.appendChild(tr);
      }
      tbl.appendChild(tbody); wrap.appendChild(tbl);
    }

    // ===== ã‚°ãƒ©ãƒ• =====
    let charts=[];
    function renderCharts(){
      charts.forEach(c=>c?.destroy()); charts=[];
      const labels=months.map(m=>m);
      const lineCommon={tension:.35,borderWidth:2,pointRadius:3,pointHoverRadius:5,fill:false};

      charts.push(new Chart(document.getElementById('chart_ov_orders').getContext('2d'),{
        type:'line',
        data:{labels, datasets:[
          {label:'æ®‹æ¥­æ™‚é–“ï¼ˆhï¼‰',data:data.overtime,yAxisID:'yL',borderColor:'#2b8a3e',...lineCommon},
          {label:'å—æ³¨ä»¶æ•°ï¼ˆä»¶ï¼‰',data:data.orders,yAxisID:'yR',borderColor:'#1c7ed6',...lineCommon},
        ]},
        options:{responsive:false,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
          scales:{yL:{type:'linear',position:'left'},yR:{type:'linear',position:'right'}}}
      }));

      charts.push(new Chart(document.getElementById('chart_in_recv').getContext('2d'),{
        type:'line',
        data:{labels,datasets:[
          {label:'ç€ä¿¡/æ—¥',data:data.inbound,borderColor:'#f59f00',...lineCommon},
          {label:'å—ä¿¡/æ—¥',data:data.received,borderColor:'#e03131',...lineCommon}
        ]},
        options:{responsive:false,maintainAspectRatio:false}
      }));

      

      

      charts.push(new Chart(document.getElementById('chart_rate').getContext('2d'),{
        type:'line',
        data:{labels,datasets:[{label:'å¿œç­”ç‡',data:data.answerRT,borderColor:'#495057',...lineCommon}]},
        options:{responsive:false,maintainAspectRatio:false,scales:{y:{suggestedMin:80,suggestedMax:100}}}
      }));

      charts.push(new Chart(document.getElementById('chart_ratio').getContext('2d'),{
        type:'line',
        data:{labels,datasets:[{label:'å—ç™ºæ³¨èª²å‡¦ç†æ¯”ç‡(%)',data:data.ratio,borderColor:'#0ca678',...lineCommon}]},
        options:{responsive:false,maintainAspectRatio:false,scales:{y:{suggestedMin:60,suggestedMax:100}}}
      }));
    }

    // ===== PNGä¿å­˜ï¼ˆæ—¢å­˜ï¼‰ =====
    document.addEventListener('click', (e)=>{
      const btn=e.target.closest('button[data-png]'); if(!btn) return;
      const id=btn.getAttribute('data-png');
      const canvas=document.getElementById(id);
      const link=document.createElement('a');
      link.download = id + '.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // ===== ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ =====
    function log(msg){
      const pre=document.getElementById('testLog');
      pre.textContent += (typeof msg==='string'? msg : JSON.stringify(msg)) + "\n";
      console.log(msg);
    }
    function expect(cond, desc){
      if(cond){ log('âœ… ' + desc); }
      else{ log('âŒ ' + desc); }
    }
    document.getElementById('btnRunTests').addEventListener('click',()=>{
      // reset
      clearAll();

      // 1) æ—¥æœ¬èªæœˆ & ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆé™¤å»
      const raw1=[
        'æœˆ\t2025å¹´1æœˆ\t2025å¹´2æœˆ',
        'æ®‹æ¥­æ™‚é–“\t1\t2',
        'å—æ³¨ä»¶æ•°\t10\t20',
        'å¿œç­”ç‡\t95.0%\t96.0ï¼…',
        'å—ç™ºæ³¨èª²å‡¦ç†æ¯”ç‡\t75.0%\t76.0%'
      ].join('\n');
      document.getElementById('pasteArea').value=raw1;
      document.getElementById('replaceMode').checked=true;
      document.getElementById('btnImport').click();
      expect(months.join(',')==='Jan-25,Feb-25','æ—¥æœ¬èªæœˆãŒ Jan-YY ã«æ­£è¦åŒ–ã•ã‚Œã‚‹');
      expect(data.answerRT[0]===95 && data.answerRT[1]===96,'å¿œç­”ç‡ã®%/ï¼…ãŒæ•°å€¤åŒ–ã•ã‚Œã‚‹');
      expect(data.ratio[0]===75 && data.ratio[1]===76,'å‡¦ç†æ¯”ç‡ã®%ãŒæ•°å€¤åŒ–ã•ã‚Œã‚‹');

      // 2) è¿½åŠ ï¼ˆreplaceãƒ¢ãƒ¼ãƒ‰OFFï¼‰
      const raw2=[
        'æœˆ\t2025/03',
        'æ®‹æ¥­æ™‚é–“\t3',
        'å—æ³¨ä»¶æ•°\t30'
      ].join('\n');
      document.getElementById('replaceMode').checked=false;
      document.getElementById('pasteArea').value=raw2;
      document.getElementById('btnImport').click();
      expect(months.includes('Mar-25'),'2025/03 ãŒ Mar-25 ã¨ã—ã¦è¿½åŠ ã•ã‚Œã‚‹');

      // 3) æ—¢å­˜æœˆã®ä¸Šæ›¸ã
      const raw3=[
        'æœˆ\tJan-25',
        'æ®‹æ¥­æ™‚é–“\t9.9',
        'å—æ³¨ä»¶æ•°\t999'
      ].join('\n');
      document.getElementById('pasteArea').value=raw3;
      document.getElementById('btnImport').click();
      const idxJan=months.indexOf('Jan-25');
      expect(data.overtime[idxJan]===9.9 && data.orders[idxJan]===999,'åŒä¸€æœˆã¯ä¸Šæ›¸ãã•ã‚Œã‚‹');

      log('â€” tests finished â€”');
    });

    // åˆæœŸæç”»
    buildTable();
    renderCharts();
  </script>
</body>
</html>
