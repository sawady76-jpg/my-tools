<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
      body { font-family: sans-serif; padding: 15px; text-align: center; background-color: #f0f2f5; color: #333; }
      
      /* è¨­å®šã‚¨ãƒªã‚¢ */
      .settings-area { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: left;}
      label { font-size: 12px; color: #666; display: block; margin-bottom: 4px; font-weight: bold;}
      select { width: 100%; padding: 12px; font-size: 16px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; background: #fff;}

      /* æ¤œç´¢ã‚¨ãƒªã‚¢ */
      .search-area { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: left; }
      .search-input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
      .search-results { margin-top: 10px; max-height: 200px; overflow-y: auto; }
      .search-item { padding: 12px; border-bottom: 1px solid #eee; text-align: left; cursor: pointer; }
      .search-item:hover, .search-item:active { background-color: #f0f7ff; }
      .search-item-code { font-size: 12px; color: #888; }
      .search-item-name { font-size: 14px; font-weight: bold; color: #333; }
      .search-item-stock { font-size: 12px; color: #007bff; float: right; }
      .search-note { font-size: 11px; color: #999; margin-top: 8px; }

      /* ãƒœã‚¿ãƒ³é¡ */
      #reader { width: 100%; margin: 0 auto; display:none; border-radius: 8px; border: 2px solid #ccc;}
      .btn-scan { background-color: #007bff; color: white; width: 100%; padding: 15px; border:none; border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold;}
      .btn-close { background-color: #666; color: white; width: 100%; padding: 10px; margin-top:10px; border:none; border-radius: 8px; display:none;}

      /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
      #result { display: none; background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
      .item-name { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: block; border-bottom: 1px solid #eee; padding-bottom: 10px; color: #333;}
      
      .stock-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      .stock-label { font-size: 14px; color: #666; }
      .stock-val { font-size: 32px; font-weight: bold; color: #007bff; }
      
      .update-time { font-size: 12px; color: #888; text-align: right; margin-bottom: 20px; display: block;}

      /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
      .input-group { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 8px;}
      input[type="number"] { width: 80px; padding: 10px; font-size: 24px; text-align: center; border: 2px solid #ddd; border-radius: 8px; }
      
      /* å…¥å‡ºåº«ãƒœã‚¿ãƒ³ */
      .btn-row { display: flex; gap: 10px; }
      .btn-action { flex: 1; padding: 15px; font-size: 16px; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; transition: opacity 0.2s;}
      .btn-action:active { opacity: 0.7; }
      .btn-in { background-color: #28a745; }
      .btn-out { background-color: #dc3545; }
    </style>
  </head>
  <body>
    <div class="settings-area">
      <label>ğŸ“ å€‰åº«ã‚’é¸æŠ</label>
      <select id="locationSelect" onchange="filterUsers()"><option>èª­ã¿è¾¼ã¿ä¸­...</option></select>
      
      <label>ğŸ‘¤ æ‹…å½“è€…ã‚’é¸æŠ</label>
      <select id="userSelect"><option>å€‰åº«ã‚’é¸ã‚“ã§ãã ã•ã„</option></select>
    </div>

    <div class="search-area">
      <label>ğŸ” å•†å“ã‚’æ¤œç´¢ï¼ˆã‚³ãƒ¼ãƒ‰ or åå‰ï¼‰</label>
      <input type="text" id="searchInput" class="search-input" placeholder="ä¾‹: AR325 ã¾ãŸã¯ ãƒ™ã‚¹ãƒˆ" oninput="onSearchInput()">
      <div id="searchResults" class="search-results"></div>
      <div class="search-note">â€» 2æ–‡å­—ä»¥ä¸Šã§æ¤œç´¢é–‹å§‹ï¼ˆæœ€å¤§10ä»¶è¡¨ç¤ºï¼‰</div>
    </div>

    <button id="startScan" class="btn-scan" onclick="startCamera()">ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
    <div id="reader"></div>
    <button id="stopScan" class="btn-close" onclick="stopCamera()">ã‚«ãƒ¡ãƒ©ã‚’é–‰ã˜ã‚‹</button>

    <div id="result">
      <span id="itemName" class="item-name"></span>
      
      <div class="stock-display">
        <span class="stock-label">ç¾åœ¨ã®åœ¨åº«</span>
        <span id="currentStock" class="stock-val">--</span>
      </div>
      <span id="lastUpdate" class="update-time">æœ€çµ‚æ›´æ–°: --</span>

      <div class="input-group">
        <span style="font-weight:bold;">æ•°é‡:</span>
        <input type="number" id="inputQty" value="1" min="1" inputmode="numeric">
      </div>

      <div class="btn-row">
        <button class="btn-action btn-out" onclick="processStock('out')">å‡ºåº« (æ¸›ã‚‰ã™)</button>
        <button class="btn-action btn-in" onclick="processStock('in')">å…¥åº« (å¢—ã‚„ã™)</button>
      </div>
    </div>

    <script>
      let html5QrcodeScanner;
      let currentCode = "";
      let allUsers = [];
      let searchTimeout;

      window.onload = function() {
        google.script.run.withSuccessHandler(initDropdowns).getAppConfig();
      };

      function initDropdowns(config) {
        const locSelect = document.getElementById('locationSelect');
        const userSelect = document.getElementById('userSelect');
        locSelect.innerHTML = ""; 
        allUsers = config.users;

        if(config.locations.length === 0) {
          let option = document.createElement("option");
          option.text = "è¨­å®šã‚·ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„";
          locSelect.add(option);
          return;
        }

        config.locations.forEach(loc => {
          let option = document.createElement("option");
          option.text = loc;
          locSelect.add(option);
        });
        
        filterUsers();
      }

      function filterUsers() {
        const locSelect = document.getElementById('locationSelect');
        const userSelect = document.getElementById('userSelect');
        const selectedLoc = locSelect.value;
        
        userSelect.innerHTML = "";
        const filtered = allUsers.filter(user => user.startsWith(selectedLoc));

        if (filtered.length === 0) {
          let option = document.createElement("option");
          option.text = "è©²å½“ã™ã‚‹æ‹…å½“è€…ãŒã„ã¾ã›ã‚“";
          userSelect.add(option);
        } else {
          filtered.forEach(user => {
            let option = document.createElement("option");
            option.text = user;
            userSelect.add(option);
          });
        }
        
        // å€‰åº«ãŒå¤‰ã‚ã£ãŸã‚‰æ¤œç´¢çµæœã‚‚ã‚¯ãƒªã‚¢
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
      }

      // æ¤œç´¢æ©Ÿèƒ½
      function onSearchInput() {
        clearTimeout(searchTimeout);
        const query = document.getElementById('searchInput').value.trim();
        const resultsDiv = document.getElementById('searchResults');
        
        if (query.length < 2) {
          resultsDiv.innerHTML = '';
          return;
        }
        
        searchTimeout = setTimeout(() => {
          const location = document.getElementById('locationSelect').value;
          google.script.run.withSuccessHandler(displaySearchResults).searchItems(query, location);
        }, 300);
      }

      function displaySearchResults(items) {
        const resultsDiv = document.getElementById('searchResults');
        
        if (items.length === 0) {
          resultsDiv.innerHTML = '<div style="padding:10px; color:#888;">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
          return;
        }
        
        let html = '';
        items.forEach(item => {
          html += '<div class="search-item" onclick="selectSearchItem(\'' + item.code + '\')">' +
            '<span class="search-item-stock">åœ¨åº«: ' + item.stock + '</span>' +
            '<div class="search-item-code">' + item.code + '</div>' +
            '<div class="search-item-name">' + item.name + '</div>' +
          '</div>';
        });
        
        resultsDiv.innerHTML = html;
      }

      function selectSearchItem(code) {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').innerHTML = '';
        
        const location = document.getElementById('locationSelect').value;
        currentCode = code;
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('itemName').innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
        document.getElementById('currentStock').innerText = "--";
        document.getElementById('lastUpdate').innerText = "";

        google.script.run.withSuccessHandler(showResult).getItemInfo(code, location);
      }

      // ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³é–¢é€£
      function startCamera() {
        document.getElementById('result').style.display = 'none';
        document.getElementById('reader').style.display = 'block';
        document.getElementById('startScan').style.display = 'none';
        document.getElementById('stopScan').style.display = 'block';
        
        html5QrcodeScanner = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess);
      }

      function stopCamera() {
        if (html5QrcodeScanner) {
          html5QrcodeScanner.stop().then(() => {
            document.getElementById('reader').style.display = 'none';
            document.getElementById('startScan').style.display = 'block';
            document.getElementById('stopScan').style.display = 'none';
          }).catch(err => console.log(err));
        }
      }

      function onScanSuccess(decodedText) {
        stopCamera();
        const location = document.getElementById('locationSelect').value;
        currentCode = decodedText;
        
        document.getElementById('result').style.display = 'block';
        document.getElementById('itemName').innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...";
        document.getElementById('currentStock').innerText = "--";
        document.getElementById('lastUpdate').innerText = "";

        google.script.run.withSuccessHandler(showResult).getItemInfo(decodedText, location);
      }

      function showResult(item) {
        if (item && !item.error) {
          document.getElementById('itemName').innerText = item.name;
          document.getElementById('currentStock').innerText = item.stock;
          document.getElementById('lastUpdate').innerText = "æœ€çµ‚æ›´æ–°: " + item.lastUpdate;
          document.getElementById('inputQty').value = 1; 
        } else {
          alert("ã‚¨ãƒ©ãƒ¼: " + (item ? item.error : "å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"));
          document.getElementById('result').style.display = 'none';
        }
      }

      function processStock(type) {
        const qtyInput = document.getElementById('inputQty');
        let qty = parseInt(qtyInput.value);
        if (isNaN(qty) || qty <= 0) {
          alert("æ­£ã—ã„æ•°é‡ã‚’å…¥ã‚Œã¦ãã ã•ã„");
          return;
        }

        if (qty >= 50) {
            const confirmMsg = "ä¸€åº¦ã« " + qty + " å€‹ã‚‚å‹•ã‹ã—ã¾ã™ã€‚\næœ¬å½“ã«é–“é•ã„ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ";
            if (!confirm(confirmMsg)) {
                return;
            }
        }

        if (type === 'out') qty = -qty;

        const location = document.getElementById('locationSelect').value;
        const user = document.getElementById('userSelect').value;

        document.querySelector('.btn-in').disabled = true;
        document.querySelector('.btn-out').disabled = true;

        google.script.run.withSuccessHandler(updateDisplay).updateStock(currentCode, qty, location, user);
      }

      function updateDisplay(result) {
        if(result === "Error") {
          alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆæ··ã¿åˆã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰");
        } else if (String(result).startsWith("Error:")) {
          alert(result);
        } else {
          document.getElementById('currentStock').innerText = result.newStock;
          document.getElementById('lastUpdate').innerText = "æœ€çµ‚æ›´æ–°: " + result.lastUpdate;
          alert("å®Œäº†ï¼\nåœ¨åº«æ•°: " + result.newStock);
        }
        document.querySelector('.btn-in').disabled = false;
        document.querySelector('.btn-out').disabled = false;
      }
    </script>
  </body>
</html>
