<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>領収書バッチOCR</title>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --header-bg: #2980b9;
      --row-odd: #ecf0f1;
      --row-even: #ffffff;
      --container-bg: #ffffff;
      --body-bg: #f7f9fa;
    }
    body { font-family: Meiryo, sans-serif; margin: 20px; background: var(--body-bg); }
    .container { max-width: 800px; margin: auto; background: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
    h1 { color: var(--header-bg); text-align: center; }
    p { text-align: center; color: #555; }
    input[type="file"] { display: block; margin: 10px auto; padding: 10px; border: 2px dashed var(--primary-color); border-radius: 4px; background: #fafafa; }
    button { margin: 10px 5px; padding: 10px 20px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; color: #fff; }
    #processBtn { background: var(--primary-color); }
    #copyBtn { background: var(--secondary-color); }
    button:disabled { opacity: 0.6; cursor: default; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; text-align: left; }
    th { background: var(--header-bg); color: #fff; }
    tbody tr:nth-child(odd) { background: var(--row-odd); }
    tbody tr:nth-child(even) { background: var(--row-even); }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>領収書バッチOCR</h1>
    <p>PDFを複数選択し、日付・内容・金額を抽出して表示・コピーします。</p>
    <input type="file" id="fileInput" accept="application/pdf" multiple>
    <div style="text-align:center;">
      <button id="processBtn">読み取り実行</button>
      <button id="copyBtn" disabled>コピー</button>
    </div>
    <table id="resultTable">
      <thead><tr><th>ファイル名</th><th>日付</th><th>内容</th><th>金額</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';

    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');
    const copyBtn = document.getElementById('copyBtn');
    const tbody = document.querySelector('#resultTable tbody');
    let records = [];

    // PDFテキスト抽出
    async function readPdf(buffer) {
      const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      return text;
    }

    // 日付抽出
    function extractDate(text, filename) {
      let m = text.match(/乗車日[:：]?\s*([0-9]{4}[年\/\.-][0-9]{1,2}[月\/\.-][0-9]{1,2}日?)/);
      if (m) return normalizeDate(m[1]);
      m = text.match(/購入日[:：]?\s*([0-9]{4}年[0-9]{1,2}月[0-9]{1,2}日)/);
      if (m) return m[1];
      m = text.match(/(\d{4}[\.\/\-]\d{1,2}[\.\/\-]\d{1,2})/);
      if (m) return normalizeDate(m[1]);
      m = filename.match(/(\d{4})(\d{2})(\d{2})/);
      if (m) return `${m[1]}年${+m[2]}月${+m[3]}日`;
      return '';
    }
    function normalizeDate(s) {
      const nums = s.match(/(\d{4})[\.\/\-年](\d{1,2})[\.\/\-月](\d{1,2})日?/);
      if (nums) return `${nums[1]}年${+nums[2]}月${+nums[3]}日`;
      return s;
    }

    // 内容抽出
    function extractContent(filename, text) {
      const h = filename.match(/【(.+?)】/);
      if (h) return h[1];
      const fn = filename.toLowerCase();
      if (fn.includes('新幹線')) return '新幹線';
      if (fn.includes('特急')) return '特急';
      const airlines = ['jal','ana','skymark','peach','jetstar','airdo','starflyer','solaseed'];
      if (airlines.some(a => fn.includes(a))) return '飛行機';
      if (/タクシー/.test(text)) return 'タクシー';
      return 'その他';
    }

    // 金額抽出（特急は汎用、全般的に対応）
    function extractAmount(text, filename) {
      // 全角数字を半角に変換
      text = text.replace(/[０-９]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0));

      // 1. 新幹線領収書からの金額抽出を最優先
      // 「金額計」または「TOTAL AMOUNT」の後に続く「¥」または「￥」と数字（カンマあり可）を抽出
      // 括弧内のテキスト（例: (10% 税込)）を無視できるように修正し、改行も考慮
      let m;
      // まず「金額計」または「TOTAL AMOUNT」を探し、その後に続く金額を抽出
      m = text.match(/(?:金額計|TOTAL AMOUNT)[\s\S]*?[¥￥]\s*([0-9,]+)(?:\s*\(.+?\))?/i);
      if (m) {
        return m[1].replace(/,/g, '');
      }

      // 2. 汎用パターン (明示的なラベル)
      // 「合計金額」「合計」「料金」「運賃」などの明示的なラベルの後に続く金額
      // こちらも括弧内のテキストを無視できるように修正
      const explicitPatterns = [
        /合計金額[:：]?\s*[¥￥]?([0-9,]+)(?:\s*\(.+?\))?/,
        /合計[:：]?\s*[¥￥]?([0-9,]+)(?:\s*\(.+?\))?/,
        /料金[:：]?\s*[¥￥]?([0-9,]+)(?:\s*\(.+?\))?/,
        /運賃[:：]?\s*[¥￥]?([0-9,]+)(?:\s*\(.+?\))?/,
        /金額[:：]?\s*[¥￥]?([0-9,]+)(?:\s*\(.+?\))?/, // 「金額」単体も追加
      ];
      for (const p of explicitPatterns) {
        m = text.match(p);
        if (m) return m[1].replace(/,/g, '');
      }

      // 3. 「円」の直前の数字を抽出（特急などでラベルがない場合を想定）
      // 複数の「円」付き数値がある場合、一番最後に現れる（通常、総額が最後に来る）
      // ただし、年（例: 2025年）と誤認しないように、桁数や文脈を考慮
      const yenAmounts = (text.match(/([0-9]{1,3}(?:,[0-9]{3})*)\s*円/g) || [])
                            .map(n => n.replace(/,/g, '').replace(/\s*円/, ''));
      if (yenAmounts.length > 0) {
          // 金額として妥当な範囲（50円以上、8桁未満）でフィルタリング
          const validYenAmounts = yenAmounts.filter(val => {
              const numValue = parseInt(val);
              // 4桁でかつ年号として妥当な範囲の数字（1900～2100）を除外
              return numValue > 50 && val.length < 8 && !(val.length === 4 && numValue >= 1900 && numValue <= 2100);
          });
          if (validYenAmounts.length > 0) {
              // 複数の候補がある場合、最も大きい金額が総額である可能性が高い
              return validYenAmounts.reduce((max, current) => parseInt(max) > parseInt(current) ? max : current, "0");
          }
      }
      
      // 4. より広い範囲での金額候補の抽出：「¥」または「￥」の後に続く数字を捉える
      // こちらも括弧内のテキストを無視できるように修正
      m = text.match(/[¥￥]\s*([0-9,]+)(?:\s*\(.+?\))?/);
      if (m) {
          return m[1].replace(/,/g, '');
      }

      // 5. 最終フォールバック：テキスト中の数字を金額と見なす
      // ただし、予約番号や電話番号のような長い数字、日付の年を除外
      const nums = (text.match(/[0-9,]{2,}/g) || []).map(n => n.replace(/,/g, ''));
      const probableAmounts = nums.filter(n => {
          const numValue = parseInt(n);
          // 予約番号やIDのような非常に長い数字 (8桁以上)、
          // または日付の年（4桁でかつ年らしい値 1900～2100）を除外
          return n.length < 8 && numValue > 50 && !(n.length === 4 && numValue >= 1900 && numValue <= 2100);
      });
      
      // 複数の候補がある場合、通常は最も大きい金額が総額である可能性が高い
      if (probableAmounts.length > 0) {
          return probableAmounts.reduce((max, current) => parseInt(max) > parseInt(current) ? max : current, "0");
      }

      return ''; // どのパターンにもマッチしない場合
    }

    processBtn.addEventListener('click', async () => {
      const files = Array.from(fileInput.files);
      if (!files.length) return alert('PDFを選択してください');
      tbody.innerHTML = '';
      records = [];
      for (const f of files) {
        try {
          const buf = await f.arrayBuffer();
          const txt = await readPdf(buf);
          const date = extractDate(txt, f.name);
          const content = extractContent(f.name, txt);
          const amount = extractAmount(txt, f.name);
          records.push({ name: f.name, date, content, amount });
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${f.name}</td><td>${date}</td><td>${content}</td><td>${amount}</td>`;
          tbody.appendChild(tr);
        } catch (e) {
          console.error('PDF読み取りエラー', f.name, e);
        }
      }
      copyBtn.disabled = records.length === 0;
    });

    copyBtn.addEventListener('click', () => {
      let tsv = 'ファイル名\t日付\t内容\t金額\n';
      records.forEach(r => tsv += `${r.name}\t${r.date}\t${r.content}\t${r.amount}\n`);
      navigator.clipboard.writeText(tsv).then(() => alert('コピーしました'));
    });
  </script>
</body>
</html>