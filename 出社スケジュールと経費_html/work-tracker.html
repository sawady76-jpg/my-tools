<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™ãƒ»å‡ºå¼µç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-card: #242b33;
            --bg-hover: #2d353f;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        h1 {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h1::before {
            content: 'ğŸ“Š';
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .month-selector button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        .month-selector button:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }
        .month-selector span {
            font-size: 1.2rem;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .tab:hover {
            background: var(--bg-hover);
        }
        .tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        .panel {
            display: none;
        }
        .panel.active {
            display: block;
        }
        /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        .summary-card .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .summary-card .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .summary-card .unit {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 4px;
        }
        .summary-card.blue .value { color: var(--accent-blue); }
        .summary-card.green .value { color: var(--accent-green); }
        .summary-card.orange .value { color: var(--accent-orange); }
        .summary-card.purple .value { color: var(--accent-purple); }
        .summary-card.red .value { color: var(--accent-red); }
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 1px solid var(--border);
        }
        .calendar-header span {
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-secondary);
            padding: 10px 0;
            background: var(--bg-card);
        }
        .calendar-header span:first-child {
            color: #f87171;
        }
        .calendar-header span:last-child {
            color: #60a5fa;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-day {
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 1rem;
            position: relative;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }
        .calendar-day:hover {
            background: var(--bg-hover);
        }
        .calendar-day.empty {
            cursor: default;
            background: var(--bg-card);
            opacity: 0.5;
        }
        .calendar-day.today {
            background: rgba(59, 130, 246, 0.15);
        }
        .calendar-day.today .date {
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-day .date {
            font-weight: 700;
            font-size: 1.15rem;
            margin-bottom: 4px;
        }
        .calendar-day .type-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 2px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 95%;
        }
        .calendar-day .dest-label {
            font-size: 0.75rem;
            color: var(--text-primary);
            margin-top: 2px;
            background: rgba(0,0,0,0.25);
            padding: 1px 5px;
            border-radius: 3px;
            max-width: 95%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .calendar-day .event-badge {
            font-size: 0.65rem;
            color: #fef3c7;
            background: #b45309;
            padding: 1px 5px;
            border-radius: 3px;
            margin-top: 2px;
            max-width: 95%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .calendar-day.office { background: rgba(59, 130, 246, 0.2); }
        .calendar-day.office .type-badge { background: var(--accent-blue); }
        .calendar-day.remote { background: rgba(16, 185, 129, 0.2); }
        .calendar-day.remote .type-badge { background: var(--accent-green); }
        .calendar-day.trip { background: rgba(245, 158, 11, 0.2); }
        .calendar-day.trip .type-badge { background: var(--accent-orange); }
        .calendar-day.paid-leave { background: rgba(139, 92, 246, 0.2); }
        .calendar-day.paid-leave .type-badge { background: var(--accent-purple); }
        .calendar-day.paid-leave-am { background: rgba(139, 92, 246, 0.15); }
        .calendar-day.paid-leave-am .type-badge { background: #a78bfa; }
        .calendar-day.paid-leave-pm { background: rgba(139, 92, 246, 0.15); }
        .calendar-day.paid-leave-pm .type-badge { background: #a78bfa; }
        .calendar-day.paid-leave-hour { background: rgba(139, 92, 246, 0.1); }
        .calendar-day.paid-leave-hour .type-badge { background: #c4b5fd; color: #1f2937; }
        .calendar-day.saturday .date { color: #60a5fa; }
        .calendar-day.sunday .date { color: #f87171; }
        .calendar-day.holiday .date { color: #f87171; }
        .calendar-day.holiday::after {
            content: 'ç¥';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.7rem;
            color: #f87171;
            font-weight: bold;
        }
        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .form-section h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        /* å±¥æ­´ãƒªã‚¹ãƒˆ */
        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-item:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }
        /* çµŒè²»ãƒ†ãƒ¼ãƒ–ãƒ« */
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .expense-table th,
        .expense-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .expense-table th {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .expense-table td {
            font-size: 0.9rem;
        }
        .expense-table .amount {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }
        .expense-table .delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .expense-table .delete-btn:hover {
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }
        .expense-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-blue);
        }
        .expense-table tr:has(input:checked) {
            background: rgba(59, 130, 246, 0.1);
        }
        /* ã‚½ãƒ¼ãƒˆå¯èƒ½ãªãƒ˜ãƒƒãƒ€ãƒ¼ */
        .expense-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .expense-table th.sortable:hover {
            color: var(--accent-blue);
        }
        .expense-table th.sortable::after {
            content: ' â†•';
            opacity: 0.3;
            font-size: 0.7rem;
        }
        .expense-table th.sortable.asc::after {
            content: ' â–²';
            opacity: 1;
            color: var(--accent-blue);
        }
        .expense-table th.sortable.desc::after {
            content: ' â–¼';
            opacity: 1;
            color: var(--accent-blue);
        }
        /* åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ */
        .flow-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .flow-question {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .flow-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .flow-option {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .flow-option:hover {
            border-color: var(--accent-blue);
        }
        .flow-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        .flow-result {
            margin-top: 24px;
            padding: 20px;
            border-radius: 12px;
            font-size: 1rem;
        }
        .flow-result.recommend {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-green);
        }
        .flow-result.not-recommend {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--accent-orange);
        }
        .flow-result h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .flow-result.recommend h3 { color: var(--accent-green); }
        .flow-result.not-recommend h3 { color: var(--accent-orange); }
        /* ã‚³ã‚¹ãƒˆæ¯”è¼ƒ */
        .cost-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .cost-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .cost-box h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .cost-box .total {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        .cost-box .breakdown {
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .cost-diff {
            text-align: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-top: 16px;
        }
        .cost-diff .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .cost-diff .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-orange);
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h2 {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            header {
                flex-direction: column;
                gap: 16px;
            }
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .cost-compare {
                grid-template-columns: 1fr;
            }
            .calendar-day {
                font-size: 0.9rem;
            }
            .calendar-day .type-badge {
                font-size: 0.6rem;
                padding: 1px 4px;
            }
        }
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
        .calendar-day[draggable="true"] {
            cursor: move;
        }
        .calendar-day.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }
        .calendar-day.drag-over {
            border: 2px dashed var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        .calendar-day.drag-over-copy {
            border: 2px dashed var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }
        .calendar-day.drag-over-copy::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: var(--accent-green);
            font-weight: 700;
            pointer-events: none;
        }
        /* ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .context-menu {
            display: none;
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width: 200px;
        }
        .context-menu.active {
            display: block;
        }
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-item:hover {
            background: var(--bg-hover);
        }
        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 8px;
        }
        /* å‡¡ä¾‹ */
        .legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }
        .legend-color.office { background: var(--accent-blue); }
        .legend-color.remote { background: var(--accent-green); }
        .legend-color.trip { background: var(--accent-orange); }
        .legend-color.paid-leave { background: var(--accent-purple); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å‹¤å‹™ãƒ»å‡ºå¼µç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
            <div class="month-selector">
                <button onclick="changeMonth(-1)">â—€</button>
                <span id="currentMonth">2026å¹´1æœˆ</span>
                <button onclick="changeMonth(1)">â–¶</button>
            </div>
        </header>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
            <div class="tab" onclick="switchTab('input')">âœï¸ å‹¤å‹™å…¥åŠ›</div>
            <div class="tab" onclick="switchTab('expense')">ğŸ’° çµŒè²»å…¥åŠ›</div>
            <div class="tab" onclick="switchTab('events')">ğŸ“… ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆ</div>
            <div class="tab" onclick="switchTab('hotels')">ğŸ¨ å®¿æ³Šå±¥æ­´</div>
            <div class="tab" onclick="switchTab('flow')">ğŸ¤” å‰ä¹—ã‚Šåˆ¤æ–­</div>
        </div>
        <div id="dashboard" class="panel active">
            <div class="summary-grid">
                <div class="summary-card blue">
                    <div class="label">å‹¤å‹™æ—¥æ•°</div>
                    <div class="value"><span id="sumWorkDays">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card green">
                    <div class="label">åœ¨å®…å‹¤å‹™</div>
                    <div class="value"><span id="sumRemote">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card blue">
                    <div class="label">å‡ºç¤¾</div>
                    <div class="value"><span id="sumOffice">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card orange">
                    <div class="label">å‡ºå¼µ</div>
                    <div class="value"><span id="sumTrip">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card purple">
                    <div class="label">æœ‰çµ¦</div>
                    <div class="value"><span id="sumPaidLeave">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card red">
                    <div class="label">å€‹äººç«‹æ›¿ åˆè¨ˆ</div>
                    <div class="value">Â¥<span id="sumPersonal">0</span></div>
                </div>
                <div class="summary-card purple">
                    <div class="label">æ³•äººã‚«ãƒ¼ãƒ‰ åˆè¨ˆ</div>
                    <div class="value">Â¥<span id="sumCorporate">0</span></div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item"><span class="legend-color office"></span>å‡ºç¤¾</div>
                <div class="legend-item"><span class="legend-color remote"></span>åœ¨å®…</div>
                <div class="legend-item"><span class="legend-color trip"></span>å‡ºå¼µ</div>
                <div class="legend-item"><span class="legend-color paid-leave"></span>æœ‰çµ¦</div>
                <div class="legend-item"><span style="color: #60a5fa;">â– </span> åœŸæ›œ</div>
                <div class="legend-item"><span style="color: #f87171;">â– </span> æ—¥æ›œãƒ»ç¥æ—¥</div>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">
                ğŸ’¡ ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• ï½œ Alt(Option)ï¼‹ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚³ãƒ”ãƒ¼ ï½œ å³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            </div>
            <div class="calendar">
                <div class="calendar-header">
                    <span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
            <div class="form-section">
                <h2>ğŸ“ çµŒè²»æ˜ç´°</h2>
                
                <!-- ç· ã‚æœŸé–“åˆ‡ã‚Šæ›¿ãˆ -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="expenseViewType" onchange="renderExpenseTable()" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="personal">å€‹äººç«‹æ›¿ï¼ˆå½“æœˆ1æ—¥ã€œæœ«æ—¥ï¼‰</option>
                            <option value="corporate">æ³•äººã‚«ãƒ¼ãƒ‰ï¼ˆ16æ—¥ã€œç¿Œ15æ—¥ï¼‰</option>
                        </select>
                    </div>
                    <div id="expensePeriodLabel" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
                </div>
                
                <!-- ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn btn-secondary" onclick="selectAllExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨é¸æŠ</button>
                    <button class="btn btn-secondary" onclick="deselectAllExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠè§£é™¤</button>
                    <button class="btn btn-danger" onclick="deleteSelectedExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠå‰Šé™¤</button>
                    <button class="btn btn-danger" onclick="deleteAllDisplayedExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨å‰Šé™¤</button>
                </div>
                
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="expenseSelectAll" onchange="toggleAllExpenseCheckboxes(this)"></th>
                            <th class="sortable" onclick="sortExpenseTable('category')">ç¨®åˆ¥</th>
                            <th class="sortable" onclick="sortExpenseTable('date')">æ—¥ä»˜</th>
                            <th class="sortable" onclick="sortExpenseTable('desc')">å†…å®¹</th>
                            <th class="sortable amount" onclick="sortExpenseTable('amount')">é‡‘é¡</th>
                            <th class="sortable" onclick="sortExpenseTable('paymentType')">æ”¯æ‰•</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                    </tbody>
                </table>
                <div id="expenseSummary" style="margin-top: 12px; text-align: right; font-size: 0.9rem;"></div>
            </div>
        </div>
        <div id="input" class="panel">
            <div class="form-section">
                <h2>ğŸ“¥ å‡ºå¼µäºˆå®šã®å–ã‚Šè¾¼ã¿</h2>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px;">
                    ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œå‡ºå¼µãƒã‚¹ã‚¿ã€ã¨ã€Œå–¶æ¥­æ‰€ãƒã‚¹ã‚¿ã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™ã€‚<br>
                    <strong>å¯¾å¿œå½¢å¼: ã€ŒID | æ—¥ä»˜ | çµ‚äº†æ—¥ | å–¶æ¥­æ‰€IDã€ã¾ãŸã¯ã€Œæ—¥ä»˜ | çµ‚äº†æ—¥ | å–¶æ¥­æ‰€IDã€</strong>
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>1. äºˆå®šãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                        <textarea id="tripScheduleData" rows="4" placeholder="2025/12/22	2025/12/22	5 ..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>2. å–¶æ¥­æ‰€ãƒã‚¹ã‚¿è²¼ã‚Šä»˜ã‘ (ID | å–¶æ¥­æ‰€å)</label>
                        <textarea id="officeMasterData" rows="4" placeholder="1	æœ­å¹Œå–¶æ¥­æ‰€ ..."></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="btn btn-primary" onclick="importTripSchedule()">åæ˜ </button>
                    <span id="tripImportResult" style="font-size: 0.85rem;"></span>
                </div>
            </div>

            <div class="form-section">
                <h2>ğŸ“… 1ä»¶ç™»éŒ²</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="workDate">
                    </div>
                    <div class="form-group">
                        <label>å‹¤å‹™ã‚¿ã‚¤ãƒ—</label>
                        <select id="workType">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                            <option value="remote">åœ¨å®…</option>
                            <option value="trip">å‡ºå¼µ</option>
                            <option value="paid-leave">æœ‰çµ¦</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="tripDestGroup" style="display: none;">
                    <label>å‡ºå¼µå…ˆ</label>
                    <input type="text" id="tripDest" placeholder="ä¾‹:ä»™å°">
                </div>
                <button class="btn btn-primary" onclick="saveWorkDay()">ç™»éŒ²</button>
            </div>
        </div>
        <div id="expense" class="panel">
            <div class="form-section">
                <h2>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿(ã‚³ãƒ”ãƒš)</h2>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                    ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
                    æœªåŠ å·¥ãƒ‡ãƒ¼ã‚¿ï¼ˆè²»ç›®ã€å†…å®¹ãƒ»åŒºé–“ãªã©ï¼‰ã‚‚è‡ªå‹•ã§å¤‰æ›ã•ã‚Œã¾ã™ã€‚
                </p>
                <div class="form-group">
                    <label>ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                    <textarea id="importData" rows="8" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘..." style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; align-items: center; margin-top: 12px;">
                    <button class="btn btn-primary" onclick="importFromClipboard()">å–ã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
                    <span id="importResult" style="font-size: 0.85rem; color: var(--text-secondary);"></span>
                </div>
                <div id="importPreview" style="margin-top: 16px; display: none;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 8px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼(æœ€åˆã®5ä»¶)</h4>
                    <div id="importPreviewContent" style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; font-size: 0.8rem; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="form-section">
                <h2>âœï¸ æ‰‹å‹•å…¥åŠ›</h2>
                <details style="cursor: pointer;">
                    <summary style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">æ‰‹å‹•ã§1ä»¶ãšã¤å…¥åŠ›ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰</summary>
                    
                    <div style="margin-top: 16px;">
                        <h3 style="font-size: 0.95rem; margin-bottom: 12px;">ğŸšƒ äº¤é€šè²»</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="date" id="transDate">
                            </div>
                            <div class="form-group">
                                <label>ãƒ«ãƒ¼ãƒˆ</label>
                                <input type="text" id="transRoute" placeholder="ä¾‹:çŸ³å²¡ â†’ æ±äº¬(ç‰¹æ€¥)">
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¡</label>
                                <input type="number" id="transAmount" placeholder="ä¾‹:2540">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveTransport()">ç™»éŒ²</button>
                        <div class="history-list" id="transHistory"></div>
                    </div>
                    <div style="margin-top: 24px;">
                        <h3 style="font-size: 0.95rem; margin-bottom: 12px;">ğŸ¨ å®¿æ³Šè²»</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="date" id="hotelDate">
                            </div>
                            <div class="form-group">
                                <label>å®¿æ³Šå…ˆ</label>
                                <input type="text" id="hotelName" placeholder="ä¾‹:ä»™å°é§…å‰ãƒ›ãƒ†ãƒ«">
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¡</label>
                                <input type="number" id="hotelAmount" placeholder="ä¾‹:12000">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveHotel()">ç™»éŒ²</button>
                        <div class="history-list" id="hotelHistory"></div>
                    </div>
                    <div style="margin-top: 24px;">
                        <h3 style="font-size: 0.95rem; margin-bottom: 12px;">ğŸ’¼ å‡ºå¼µæ‰‹å½“</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="date" id="allowanceDate">
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¡(ä¸€å¾‹)</label>
                                <input type="number" id="allowanceAmount" value="3000" readonly>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveAllowance()">ç™»éŒ²</button>
                    </div>
                </details>
            </div>
        </div>
        <div id="flow" class="panel">
            <div class="flow-card">
                <h2 style="margin-bottom: 24px;">ğŸ¤” å‰ä¹—ã‚Šã™ã¹ã?åˆ¤æ–­ãƒ•ãƒ­ãƒ¼</h2>
                
                <div id="flowStep1" class="flow-step">
                    <div class="flow-question">Q1. å‡ºå¼µå…ˆã¯ã©ã“?</div>
                    <div class="flow-options">
                        <div class="flow-option" onclick="selectFlow(1, 'tohoku')">æ±åŒ—(ä»™å°ãªã©)</div>
                        <div class="flow-option" onclick="selectFlow(1, 'other')">ãã®ä»–</div>
                    </div>
                </div>
                <div id="flowStep2" class="flow-step" style="display: none; margin-top: 24px;">
                    <div class="flow-question">Q2. æ™‚æœŸã¯?</div>
                    <div class="flow-options">
                        <div class="flow-option" onclick="selectFlow(2, 'winter')">å†¬å­£(1ã€œ2æœˆ)</div>
                        <div class="flow-option" onclick="selectFlow(2, 'other')">ãã‚Œä»¥å¤–</div>
                    </div>
                </div>
                <div id="flowStep3" class="flow-step" style="display: none; margin-top: 24px;">
                    <div class="flow-question">Q3. ãã®é€±ã®å‡ºç¤¾å›æ•°ã¯?</div>
                    <div class="flow-options">
                        <div class="flow-option" onclick="selectFlow(3, '2plus')">2å›ä»¥ä¸Š</div>
                        <div class="flow-option" onclick="selectFlow(3, '1')">1å›</div>
                        <div class="flow-option" onclick="selectFlow(3, '0')">0å›</div>
                    </div>
                </div>
                <div id="flowResult" style="display: none;"></div>
                <button class="btn btn-secondary" onclick="resetFlow()" style="margin-top: 20px;">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="form-section">
                <h2>ğŸ’° ã‚³ã‚¹ãƒˆæ¯”è¼ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>çŸ³å²¡â‡”æ±äº¬(ç‰¹æ€¥ãƒ»ç‰‡é“)</label>
                        <input type="number" id="costTokyo" value="2540">
                    </div>
                    <div class="form-group">
                        <label>å®¿æ³Šè²»(1æ³Š)</label>
                        <input type="number" id="costHotel" value="12000">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="calcCostCompare()">è¨ˆç®—</button>
                <div class="cost-compare" id="costCompareResult" style="display: none;">
                    <div class="cost-box">
                        <h4>æ¡ˆ1 å½“æ—¥ç§»å‹•</h4>
                        <div class="total" id="cost1Total">Â¥0</div>
                        <div class="breakdown" id="cost1Breakdown"></div>
                    </div>
                    <div class="cost-box">
                        <h4>æ¡ˆ2 å‰ä¹—ã‚Š</h4>
                        <div class="total" id="cost2Total">Â¥0</div>
                        <div class="breakdown" id="cost2Breakdown"></div>
                    </div>
                </div>
                <div class="cost-diff" id="costDiff" style="display: none;">
                    <div class="label">å·®é¡(å‰ä¹—ã‚Šã®è¿½åŠ ã‚³ã‚¹ãƒˆ)</div>
                    <div class="value" id="costDiffValue">+Â¥0</div>
                </div>
            </div>
        </div>

        <!-- ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ãƒãƒ« -->
        <div id="events" class="panel">
            <div class="form-section">
                <h2>ğŸ“… ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label>ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥</label>
                        <select id="eventType">
                            <option value="meeting">ä¼šè­°</option>
                            <option value="training">ç ”ä¿®</option>
                            <option value="ceremony">å¼å…¸</option>
                            <option value="party">æ‡‡è¦ªä¼š</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                        <input type="text" id="eventName" placeholder="ä¾‹ï¼šã‚­ãƒƒã‚¯ã‚ªãƒ•ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å ´æ‰€</label>
                        <input type="text" id="eventLocation" placeholder="ä¾‹ï¼šæœ¬ç¤¾ä¼šè­°å®¤">
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¢</label>
                        <input type="text" id="eventMemo" placeholder="ä¾‹ï¼šè³‡æ–™æŒå‚">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveEvent()">ç™»éŒ²</button>
            </div>

            <div class="form-section">
                <h2>ğŸ“‹ ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h2>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn btn-secondary" onclick="selectAllEvents()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨é¸æŠ</button>
                    <button class="btn btn-secondary" onclick="deselectAllEvents()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠè§£é™¤</button>
                    <button class="btn btn-danger" onclick="deleteSelectedEvents()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠå‰Šé™¤</button>
                </div>
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="eventSelectAll" onchange="toggleAllEventCheckboxes(this)"></th>
                            <th class="sortable" onclick="sortEventTable('date')">æ—¥ä»˜</th>
                            <th class="sortable" onclick="sortEventTable('type')">ç¨®åˆ¥</th>
                            <th class="sortable" onclick="sortEventTable('name')">ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                            <th class="sortable" onclick="sortEventTable('location')">å ´æ‰€</th>
                            <th>ãƒ¡ãƒ¢</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="eventTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å®¿æ³Šå±¥æ­´ãƒ‘ãƒãƒ« -->
        <div id="hotels" class="panel">
            <div class="form-section">
                <h2>ğŸ“‹ éå»ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬å–ã‚Šè¾¼ã¿</h2>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                    ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã€Œæ—¥ä»˜ï¼‹ãƒ›ãƒ†ãƒ«åã€å½¢å¼ã§ã‚³ãƒ”ãƒšã—ã¦ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™ã€‚<br>
                    ä¾‹: <code>2024/6/10(æœˆ)	æ±æ¨ªINNæ¨ªæµœå¸‚å–¶åœ°ä¸‹é‰„ã‚»ãƒ³ã‚¿ãƒ¼å—é§…</code>
                </p>
                <div class="form-group">
                    <label>ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                    <textarea id="hotelImportData" rows="6" placeholder="ã“ã“ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..." style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="btn btn-primary" onclick="importHotelHistory()">å–ã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
                    <span id="hotelImportResult" style="font-size: 0.85rem;"></span>
                </div>
            </div>

            <div class="form-section">
                <h2>ğŸ¨ å®¿æ³Šå±¥æ­´ç™»éŒ²ï¼ˆæ‰‹å‹•ï¼‰</h2>
                <details>
                    <summary style="cursor: pointer; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">æ‰‹å‹•ã§1ä»¶ãšã¤ç™»éŒ²ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰</summary>
                    <div style="margin-top: 16px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥</label>
                                <input type="date" id="hotelCheckin">
                            </div>
                            <div class="form-group">
                                <label>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥</label>
                                <input type="date" id="hotelCheckout">
                            </div>
                            <div class="form-group">
                                <label>ãƒ›ãƒ†ãƒ«å</label>
                                <input type="text" id="hotelNameInput" placeholder="ä¾‹ï¼šæ±æ¨ªINN ä»™å°é§…å‰">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ã‚¨ãƒªã‚¢</label>
                                <input type="text" id="hotelArea" placeholder="ä¾‹ï¼šä»™å°">
                            </div>
                            <div class="form-group">
                                <label>æ–™é‡‘</label>
                                <input type="number" id="hotelPrice" placeholder="ä¾‹ï¼š8500">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ã‚¢ã‚¯ã‚»ã‚¹</label>
                                <select id="hotelAccess">
                                    <option value="">æœªè©•ä¾¡</option>
                                    <option value="5">5 - æœ€é«˜</option>
                                    <option value="4">4 - è‰¯ã„</option>
                                    <option value="3">3 - æ™®é€š</option>
                                    <option value="2">2 - ã„ã¾ã„ã¡</option>
                                    <option value="1">1 - æ‚ªã„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>éƒ¨å±‹</label>
                                <select id="hotelRoom">
                                    <option value="">æœªè©•ä¾¡</option>
                                    <option value="5">5 - æœ€é«˜</option>
                                    <option value="4">4 - è‰¯ã„</option>
                                    <option value="3">3 - æ™®é€š</option>
                                    <option value="2">2 - ã„ã¾ã„ã¡</option>
                                    <option value="1">1 - æ‚ªã„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é£Ÿäº‹</label>
                                <select id="hotelFood">
                                    <option value="">æœªè©•ä¾¡</option>
                                    <option value="5">5 - æœ€é«˜</option>
                                    <option value="4">4 - è‰¯ã„</option>
                                    <option value="3">3 - æ™®é€š</option>
                                    <option value="2">2 - ã„ã¾ã„ã¡</option>
                                    <option value="1">1 - æ‚ªã„</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ãƒ¡ãƒ¢ï¼ˆè‰¯ã‹ã£ãŸç‚¹ãƒ»æ‚ªã‹ã£ãŸç‚¹ãªã©ï¼‰</label>
                            <textarea id="hotelMemo" rows="2" placeholder="ä¾‹ï¼šæœé£ŸãŒç¾å‘³ã—ã„ã€é§…ã‹ã‚‰è¿‘ã„" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveHotelHistory()">ç™»éŒ²</button>
                    </div>
                </details>
                <div class="history-list" id="hotelHistoryQuick" style="margin-top: 12px;"></div>
            </div>

            <div class="form-section">
                <h2>ğŸ“‹ å®¿æ³Šå±¥æ­´ä¸€è¦§</h2>
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="hotelFilterArea" onchange="renderHotelTable()" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="">å…¨ã‚¨ãƒªã‚¢</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="selectAllHotels()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨é¸æŠ</button>
                    <button class="btn btn-secondary" onclick="deselectAllHotels()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠè§£é™¤</button>
                    <button class="btn btn-danger" onclick="deleteSelectedHotels()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠå‰Šé™¤</button>
                </div>
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="hotelSelectAll" onchange="toggleAllHotelCheckboxes(this)"></th>
                            <th class="sortable" onclick="sortHotelTable('checkin')">æ—¥ä»˜</th>
                            <th class="sortable" onclick="sortHotelTable('name')">ãƒ›ãƒ†ãƒ«å</th>
                            <th class="sortable" onclick="sortHotelTable('area')">ã‚¨ãƒªã‚¢</th>
                            <th class="sortable" onclick="sortHotelTable('nights')">æ³Šæ•°</th>
                            <th class="sortable amount" onclick="sortHotelTable('price')">é‡‘é¡</th>
                            <th class="sortable" onclick="sortHotelTable('rating')">è©•ä¾¡</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="hotelTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="dayModal">
        <div class="modal">
            <h2 id="modalTitle">1æœˆ1æ—¥ã®ç·¨é›†</h2>
            <div class="form-group">
                <label>å‹¤å‹™ã‚¿ã‚¤ãƒ—</label>
                <select id="modalWorkType">
                    <option value="">æœªè¨­å®š</option>
                    <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                    <option value="remote">åœ¨å®…</option>
                    <option value="trip">å‡ºå¼µ</option>
                    <option value="paid-leave">æœ‰çµ¦ï¼ˆå…¨ä¼‘ï¼‰</option>
                    <option value="paid-leave-am">æœ‰çµ¦ï¼ˆAMä¼‘ï¼‰</option>
                    <option value="paid-leave-pm">æœ‰çµ¦ï¼ˆPMä¼‘ï¼‰</option>
                    <option value="paid-leave-hour">æœ‰çµ¦ï¼ˆæ™‚é–“ä¼‘ï¼‰</option>
                </select>
            </div>
            <div class="form-group" id="modalTripDestGroup" style="display: none;">
                <label>å‡ºå¼µå…ˆ</label>
                <input type="text" id="modalTripDest" placeholder="ä¾‹:ä»™å°">
            </div>
            <div class="form-group" id="modalHourLeaveGroup" style="display: none;">
                <label>æ™‚é–“ä¼‘ã®æ™‚é–“æ•°</label>
                <input type="number" id="modalHourLeave" placeholder="ä¾‹:2" min="1" max="7" style="width: 80px;"> æ™‚é–“
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" onclick="deleteWorkDay()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="saveModalWorkDay()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- å®¿æ³Šå±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="hotelDetailModal">
        <div class="modal" style="max-width: 600px;">
            <h2>ğŸ¨ å®¿æ³Šå±¥æ­´è©³ç´°</h2>
            <input type="hidden" id="hotelDetailIndex">
            <div class="form-row">
                <div class="form-group">
                    <label>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥</label>
                    <input type="date" id="hotelDetailCheckin">
                </div>
                <div class="form-group">
                    <label>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥</label>
                    <input type="date" id="hotelDetailCheckout">
                </div>
            </div>
            <div class="form-group">
                <label>ãƒ›ãƒ†ãƒ«å</label>
                <input type="text" id="hotelDetailName">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ã‚¨ãƒªã‚¢</label>
                    <input type="text" id="hotelDetailArea">
                </div>
                <div class="form-group">
                    <label>æ–™é‡‘</label>
                    <input type="number" id="hotelDetailPrice">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ã‚¢ã‚¯ã‚»ã‚¹</label>
                    <select id="hotelDetailAccess">
                        <option value="">æœªè©•ä¾¡</option>
                        <option value="5">5 - æœ€é«˜</option>
                        <option value="4">4 - è‰¯ã„</option>
                        <option value="3">3 - æ™®é€š</option>
                        <option value="2">2 - ã„ã¾ã„ã¡</option>
                        <option value="1">1 - æ‚ªã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>éƒ¨å±‹</label>
                    <select id="hotelDetailRoom">
                        <option value="">æœªè©•ä¾¡</option>
                        <option value="5">5 - æœ€é«˜</option>
                        <option value="4">4 - è‰¯ã„</option>
                        <option value="3">3 - æ™®é€š</option>
                        <option value="2">2 - ã„ã¾ã„ã¡</option>
                        <option value="1">1 - æ‚ªã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é£Ÿäº‹</label>
                    <select id="hotelDetailFood">
                        <option value="">æœªè©•ä¾¡</option>
                        <option value="5">5 - æœ€é«˜</option>
                        <option value="4">4 - è‰¯ã„</option>
                        <option value="3">3 - æ™®é€š</option>
                        <option value="2">2 - ã„ã¾ã„ã¡</option>
                        <option value="1">1 - æ‚ªã„</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ãƒ¡ãƒ¢</label>
                <textarea id="hotelDetailMemo" rows="3" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeHotelDetailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-secondary" onclick="duplicateHotelStay()">ğŸ“‹ è¤‡è£½</button>
                <button class="btn btn-danger" onclick="deleteHotelStayFromModal()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="saveHotelDetail()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="eventDetailModal">
        <div class="modal" style="max-width: 500px;">
            <h2>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°</h2>
            <input type="hidden" id="eventDetailIndex">
            <div class="form-row">
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="eventDetailDate">
                </div>
                <div class="form-group">
                    <label>ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥</label>
                    <select id="eventDetailType">
                        <option value="meeting">ä¼šè­°</option>
                        <option value="training">ç ”ä¿®</option>
                        <option value="ceremony">å¼å…¸</option>
                        <option value="party">æ‡‡è¦ªä¼š</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                <input type="text" id="eventDetailName">
            </div>
            <div class="form-group">
                <label>å ´æ‰€</label>
                <input type="text" id="eventDetailLocation">
            </div>
            <div class="form-group">
                <label>ãƒ¡ãƒ¢</label>
                <textarea id="eventDetailMemo" rows="3" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEventDetailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-secondary" onclick="duplicateEventFromModal()">ğŸ“‹ è¤‡è£½</button>
                <button class="btn btn-danger" onclick="deleteEventFromModal()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="saveEventDetail()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="copyToNextDay()">
            ğŸ“‹ ç¿Œæ—¥ã«ã‚³ãƒ”ãƒ¼
        </div>
        <div class="context-menu-item" onclick="copyToNextWeek()">
            ğŸ“… ç¿Œé€±ã«ã‚³ãƒ”ãƒ¼
        </div>
        <div class="context-menu-item" onclick="copyToMultipleDays()">
            ğŸ“† è¤‡æ•°æ—¥ã«ã‚³ãƒ”ãƒ¼...
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="editFromContextMenu()">
            âœï¸ ç·¨é›†
        </div>
        <div class="context-menu-item" onclick="deleteFromContextMenu()">
            ğŸ—‘ï¸ å‰Šé™¤
        </div>
    </div>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        let currentYear = 2026;
        let currentMonth = 1;
        let selectedDate = null;
        let draggedDate = null;
        let contextMenuDate = null;
        let isCopyMode = false;
        
        // ã‚½ãƒ¼ãƒˆçŠ¶æ…‹
        let sortState = {
            expense: { key: 'date', order: 'asc' },
            event: { key: 'date', order: 'asc' },
            hotel: { key: 'checkin', order: 'desc' }
        };
        // 2026å¹´ã®ç¥æ—¥ãƒ‡ãƒ¼ã‚¿
        const holidays2026 = {
            '2026-01-01': 'å…ƒæ—¥',
            '2026-01-12': 'æˆäººã®æ—¥',
            '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2026-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2026-04-29': 'æ˜­å’Œã®æ—¥',
            '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2026-07-20': 'æµ·ã®æ—¥',
            '2026-08-11': 'å±±ã®æ—¥',
            '2026-09-21': 'æ•¬è€ã®æ—¥',
            '2026-09-22': 'å›½æ°‘ã®ä¼‘æ—¥',
            '2026-09-23': 'ç§‹åˆ†ã®æ—¥',
            '2026-10-12': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2026-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2026-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥'
        };
        // ç¥æ—¥åˆ¤å®š
        function isHoliday(dateStr) {
            return holidays2026[dateStr] || null;
        }
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        let data = {
            workDays: {},    // { "2026-01-15": { type: "office", dest: "" } }
            expenses: [],    // [{ date, category, desc, amount }]
            transHistory: [],
            hotelHistory: [],
            events: [],      // [{ date, type, name, location, memo }]
            hotelStays: []   // [{ checkin, checkout, name, area, price, rating, memo }]
        };
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderAll();
            setupEventListeners();
        });
        // LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadData() {
            const saved = localStorage.getItem('workTrackerData');
            if (saved) {
                const loaded = JSON.parse(saved);
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                data = {
                    workDays: loaded.workDays || {},
                    expenses: loaded.expenses || [],
                    transHistory: loaded.transHistory || [],
                    hotelHistory: loaded.hotelHistory || [],
                    events: loaded.events || [],
                    hotelStays: loaded.hotelStays || []
                };
            }
        }
        // LocalStorageã«ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            localStorage.setItem('workTrackerData', JSON.stringify(data));
        }
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            document.getElementById('workType').addEventListener('change', (e) => {
                document.getElementById('tripDestGroup').style.display =
                    e.target.value === 'trip' ? 'block' : 'none';
            });
            document.getElementById('modalWorkType').addEventListener('change', (e) => {
                const val = e.target.value;
                document.getElementById('modalTripDestGroup').style.display =
                    val === 'trip' ? 'block' : 'none';
                document.getElementById('modalHourLeaveGroup').style.display =
                    val === 'paid-leave-hour' ? 'block' : 'none';
            });
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('dayModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeModal();
                }
            });
            // å®¿æ³Šå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('hotelDetailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeHotelDetailModal();
                }
            });
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('eventDetailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeEventDetailModal();
                }
            });
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu')) {
                    closeContextMenu();
                }
            });
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ(Alt/Optionã‚­ãƒ¼æ¤œå‡º)
            document.addEventListener('keydown', (e) => {
                if (e.altKey && draggedDate) {
                    isCopyMode = true;
                }
            });
            document.addEventListener('keyup', (e) => {
                if (!e.altKey) {
                    isCopyMode = false;
                }
            });
        }
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        // æœˆå¤‰æ›´
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            } else if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            renderAll();
        }
        // å…¨ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderAll() {
            document.getElementById('currentMonth').textContent = `${currentYear}å¹´${currentMonth}æœˆ`;
            renderCalendar();
            renderSummary();
            renderExpenseTable();
            renderHistories();
            renderEventTable();
            renderHotelTable();
            
            // æ—¥ä»˜å…¥åŠ›ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä»Šæ—¥ã«
            const today = toDateStr(new Date());
            document.getElementById('workDate').value = today;
            document.getElementById('transDate').value = today;
            document.getElementById('hotelDate').value = today;
            document.getElementById('allowanceDate').value = today;
            document.getElementById('eventDate').value = today;
            document.getElementById('hotelCheckin').value = today;
            document.getElementById('hotelCheckout').value = today;
        }
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            // ç©ºç™½ã‚»ãƒ«
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                grid.appendChild(emptyCell);
            }
            // æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = data.workDays[dateStr];
                const dateObj = new Date(currentYear, currentMonth - 1, day);
                const dayOfWeek = dateObj.getDay();
                const holidayName = isHoliday(dateStr);
                
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                if (dateStr === todayStr) {
                    cell.classList.add('today');
                }
                
                // åœŸæ—¥ç¥ã®åˆ¤å®š
                if (dayOfWeek === 0) {
                    cell.classList.add('sunday');
                } else if (dayOfWeek === 6) {
                    cell.classList.add('saturday');
                }
                if (holidayName) {
                    cell.classList.add('holiday');
                    cell.title = holidayName;
                }
                
                if (dayData) {
                    cell.classList.add(dayData.type);
                }
                
                // ã“ã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                const dayEvents = (data.events || []).filter(e => e.date === dateStr);
                const eventHtml = dayEvents.length > 0 
                    ? `<span class="event-badge" title="${dayEvents.map(e => e.name).join(', ')}">${dayEvents[0].name.substring(0, 6)}${dayEvents.length > 1 ? '...' : ''}</span>`
                    : '';
                
                cell.innerHTML = `
                    <span class="date">${day}</span>
                    ${dayData ? `<span class="type-badge">${getTypeLabel(dayData.type)}${dayData.type === 'paid-leave-hour' && dayData.hours ? `(${dayData.hours}h)` : ''}</span>` : ''}
                    ${dayData && dayData.dest ? `<span class="dest-label">${dayData.dest}</span>` : ''}
                    ${eventHtml}
                `;
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
                if (dayData) {
                    cell.draggable = true;
                    cell.addEventListener('dragstart', (e) => handleDragStart(e, dateStr));
                    cell.addEventListener('dragend', handleDragEnd);
                }
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('dragleave', handleDragLeave);
                cell.addEventListener('drop', (e) => handleDrop(e, dateStr));
                // å·¦ã‚¯ãƒªãƒƒã‚¯(ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«)
                cell.addEventListener('click', (e) => {
                    if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                        openDayModal(dateStr, day);
                    }
                });
                // å³ã‚¯ãƒªãƒƒã‚¯(ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼)
                cell.addEventListener('contextmenu', (e) => {
                    if (dayData) {
                        e.preventDefault();
                        showContextMenu(e, dateStr);
                    }
                });
                grid.appendChild(cell);
            }
        }
        // å‹¤å‹™ã‚¿ã‚¤ãƒ—ã®ãƒ©ãƒ™ãƒ«å–å¾—
        function getTypeLabel(type) {
            const labels = {
                'office': 'å‡ºç¤¾',
                'remote': 'åœ¨å®…',
                'trip': 'å‡ºå¼µ',
                'paid-leave': 'æœ‰çµ¦',
                'paid-leave-am': 'AMä¼‘',
                'paid-leave-pm': 'PMä¼‘',
                'paid-leave-hour': 'æ™‚é–“ä¼‘'
            };
            return labels[type] || '';
        }
        
        // æœ‰çµ¦ç³»ã‹ã©ã†ã‹åˆ¤å®š
        function isPaidLeaveType(type) {
            return type && type.startsWith('paid-leave');
        }
        // ã‚µãƒãƒªãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderSummary() {
            const monthPrefix = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            
            let counts = { office: 0, remote: 0, trip: 0, paidLeave: 0 };
            
            Object.entries(data.workDays).forEach(([date, info]) => {
                if (date.startsWith(monthPrefix)) {
                    if (info.type === 'office') counts.office++;
                    else if (info.type === 'remote') counts.remote++;
                    else if (info.type === 'trip') counts.trip++;
                    else if (isPaidLeaveType(info.type)) counts.paidLeave++;
                }
            });
            const workDays = counts.office + counts.remote + counts.trip;
            
            document.getElementById('sumWorkDays').textContent = workDays;
            document.getElementById('sumRemote').textContent = counts.remote;
            document.getElementById('sumOffice').textContent = counts.office;
            document.getElementById('sumTrip').textContent = counts.trip;
            document.getElementById('sumPaidLeave').textContent = counts.paidLeave;
            // çµŒè²»åˆè¨ˆ(å€‹äººç«‹æ›¿ãƒ»æ³•äººã‚«ãƒ¼ãƒ‰åˆ¥)
            const monthExpenses = data.expenses.filter(e => e.date.startsWith(monthPrefix));
            
            const personalTotal = monthExpenses
                .filter(e => e.paymentType !== 'æ³•äººã‚«ãƒ¼ãƒ‰')
                .reduce((sum, e) => sum + e.amount, 0);
            
            const corporateTotal = monthExpenses
                .filter(e => e.paymentType === 'æ³•äººã‚«ãƒ¼ãƒ‰')
                .reduce((sum, e) => sum + e.amount, 0);
            
            document.getElementById('sumPersonal').textContent = personalTotal.toLocaleString();
            document.getElementById('sumCorporate').textContent = corporateTotal.toLocaleString();
        }
        // çµŒè²»ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆç· ã‚æ—¥å¯¾å¿œç‰ˆï¼‰
        function renderExpenseTable() {
            const viewType = document.getElementById('expenseViewType').value;
            const tbody = document.getElementById('expenseTableBody');
            
            // ç· ã‚æœŸé–“ã‚’è¨ˆç®—
            let startDate, endDate, periodLabel;
            
            if (viewType === 'personal') {
                // å€‹äººç«‹æ›¿: å½“æœˆ1æ—¥ã€œå½“æœˆæœ«æ—¥
                startDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-01`;
                const lastDay = new Date(currentYear, currentMonth, 0).getDate();
                endDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
                periodLabel = `${currentMonth}/1 ã€œ ${currentMonth}/${lastDay}`;
            } else {
                // æ³•äººã‚«ãƒ¼ãƒ‰: å½“æœˆ16æ—¥ã€œç¿Œæœˆ15æ—¥
                startDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-16`;
                let nextMonth = currentMonth + 1;
                let nextYear = currentYear;
                if (nextMonth > 12) {
                    nextMonth = 1;
                    nextYear++;
                }
                endDate = `${nextYear}-${String(nextMonth).padStart(2, '0')}-15`;
                periodLabel = `${currentMonth}/16 ã€œ ${nextMonth}/15`;
            }
            
            document.getElementById('expensePeriodLabel').textContent = `å¯¾è±¡æœŸé–“: ${periodLabel}`;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredExpenses = data.expenses
                .filter(e => {
                    const matchDate = e.date >= startDate && e.date <= endDate;
                    const matchType = viewType === 'personal' 
                        ? (e.paymentType !== 'æ³•äººã‚«ãƒ¼ãƒ‰')
                        : (e.paymentType === 'æ³•äººã‚«ãƒ¼ãƒ‰');
                    return matchDate && matchType;
                });
            
            // ã‚½ãƒ¼ãƒˆ
            const { key, order } = sortState.expense;
            filteredExpenses.sort((a, b) => {
                let valA = a[key] || '';
                let valB = b[key] || '';
                if (key === 'amount') {
                    valA = Number(valA);
                    valB = Number(valB);
                }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
            updateSortHeaders('expense', key, order);
            
            if (filteredExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">çµŒè²»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                document.getElementById('expenseSummary').textContent = '';
                return;
            }
            
            tbody.innerHTML = filteredExpenses.map((e) => {
                const globalIndex = data.expenses.indexOf(e);
                return `
                <tr data-index="${globalIndex}">
                    <td><input type="checkbox" class="expense-checkbox" data-index="${globalIndex}"></td>
                    <td>${getCategoryLabel(e.category)}</td>
                    <td>${formatDate(e.date)}</td>
                    <td>${e.desc}</td>
                    <td class="amount">Â¥${e.amount.toLocaleString()}</td>
                    <td><span style="font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: ${e.paymentType === 'æ³•äººã‚«ãƒ¼ãƒ‰' ? 'var(--accent-purple)' : 'var(--accent-blue)'};">${e.paymentType || 'å€‹äººç«‹æ›¿'}</span></td>
                    <td><button class="delete-btn" onclick="deleteExpense(${globalIndex})">âœ•</button></td>
                </tr>
            `}).join('');
            
            // åˆè¨ˆè¡¨ç¤º
            const total = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('expenseSummary').innerHTML = `
                <strong>åˆè¨ˆ: Â¥${total.toLocaleString()}</strong>ï¼ˆ${filteredExpenses.length}ä»¶ï¼‰
            `;
        }
        
        // çµŒè²»ãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
        function sortExpenseTable(key) {
            if (sortState.expense.key === key) {
                sortState.expense.order = sortState.expense.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.expense.key = key;
                sortState.expense.order = 'asc';
            }
            renderExpenseTable();
        }
        
        // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
        function updateSortHeaders(tableType, activeKey, order) {
            const tableMap = {
                'expense': '#dashboard .expense-table',
                'event': '#events .expense-table',
                'hotel': '#hotels .expense-table'
            };
            const table = document.querySelector(tableMap[tableType]);
            if (!table) return;
            
            table.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            
            const keyMap = {
                'expense': { 'category': 1, 'date': 2, 'desc': 3, 'amount': 4, 'paymentType': 5 },
                'event': { 'date': 1, 'type': 2, 'name': 3, 'location': 4 },
                'hotel': { 'checkin': 1, 'name': 2, 'area': 3, 'nights': 4, 'price': 5, 'rating': 6 }
            };
            
            const colIndex = keyMap[tableType][activeKey];
            if (colIndex !== undefined) {
                const th = table.querySelector(`thead tr th:nth-child(${colIndex + 1})`);
                if (th) th.classList.add(order);
            }
        }
        
        // å…¨é¸æŠ
        function selectAllExpenses() {
            document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('expenseSelectAll').checked = true;
        }
        
        // é¸æŠè§£é™¤
        function deselectAllExpenses() {
            document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('expenseSelectAll').checked = false;
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§å…¨åˆ‡ã‚Šæ›¿ãˆ
        function toggleAllExpenseCheckboxes(headerCheckbox) {
            document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = headerCheckbox.checked);
        }
        
        // é¸æŠã—ãŸçµŒè²»ã‚’å‰Šé™¤
        function deleteSelectedExpenses() {
            const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`${checkedBoxes.length}ä»¶ã®çµŒè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå¾Œã‚ã‹ã‚‰å‰Šé™¤ã—ãªã„ã¨ã‚ºãƒ¬ã‚‹ï¼‰
            const indices = Array.from(checkedBoxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            
            indices.forEach(idx => {
                data.expenses.splice(idx, 1);
            });
            
            saveData();
            renderAll();
            alert(`${checkedBoxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        
        // è¡¨ç¤ºä¸­ã®çµŒè²»ã‚’å…¨å‰Šé™¤
        function deleteAllDisplayedExpenses() {
            const checkboxes = document.querySelectorAll('.expense-checkbox');
            if (checkboxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const viewType = document.getElementById('expenseViewType').value;
            const typeName = viewType === 'personal' ? 'å€‹äººç«‹æ›¿' : 'æ³•äººã‚«ãƒ¼ãƒ‰';
            
            if (!confirm(`è¡¨ç¤ºä¸­ã®${typeName}ãƒ‡ãƒ¼ã‚¿ï¼ˆ${checkboxes.length}ä»¶ï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
            const indices = Array.from(checkboxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            
            indices.forEach(idx => {
                data.expenses.splice(idx, 1);
            });
            
            saveData();
            renderAll();
            alert(`${checkboxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        // ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«
        function getCategoryLabel(category) {
            const labels = {
                'transport': 'ğŸšƒ äº¤é€šè²»',
                'hotel': 'ğŸ¨ å®¿æ³Šè²»',
                'allowance': 'ğŸ’¼ å‡ºå¼µæ‰‹å½“',
                'entertainment': 'ğŸ» äº¤éš›è²»',
                'other': 'ğŸ“ ãã®ä»–'
            };
            return labels[category] || category;
        }
        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return `${parseInt(m)}/${parseInt(d)}`;
        }
        // å±¥æ­´ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderHistories() {
            const transHistory = document.getElementById('transHistory');
            const hotelHistory = document.getElementById('hotelHistory');
            transHistory.innerHTML = data.transHistory.map(h => 
                `<div class="history-item" onclick="fillTransport('${h.route}', ${h.amount})">${h.route} - Â¥${h.amount.toLocaleString()}</div>`
            ).join('');
            hotelHistory.innerHTML = data.hotelHistory.map(h => 
                `<div class="history-item" onclick="fillHotel('${h.name}', ${h.amount})">${h.name} - Â¥${h.amount.toLocaleString()}</div>`
            ).join('');
        }
        // å±¥æ­´ã‹ã‚‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
        function fillTransport(route, amount) {
            document.getElementById('transRoute').value = route;
            document.getElementById('transAmount').value = amount;
        }
        function fillHotel(name, amount) {
            document.getElementById('hotelName').value = name;
            document.getElementById('hotelAmount').value = amount;
        }
        // å‹¤å‹™æ—¥ä¿å­˜
        function saveWorkDay() {
            const date = document.getElementById('workDate').value;
            const type = document.getElementById('workType').value;
            const dest = document.getElementById('tripDest').value;
            if (!date || !type) {
                alert('æ—¥ä»˜ã¨å‹¤å‹™ã‚¿ã‚¤ãƒ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.workDays[date] = { type, dest };
            saveData();
            renderAll();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('workType').value = '';
            document.getElementById('tripDest').value = '';
            document.getElementById('tripDestGroup').style.display = 'none';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // äº¤é€šè²»ä¿å­˜
        function saveTransport() {
            const date = document.getElementById('transDate').value;
            const route = document.getElementById('transRoute').value;
            const amount = parseInt(document.getElementById('transAmount').value);
            if (!date || !route || !amount) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.expenses.push({ date, category: 'transport', desc: route, amount });
            
            // å±¥æ­´ã«è¿½åŠ (é‡è¤‡æ’é™¤ã€æœ€å¤§10ä»¶)
            const historyKey = `${route}-${amount}`;
            data.transHistory = data.transHistory.filter(h => `${h.route}-${h.amount}` !== historyKey);
            data.transHistory.unshift({ route, amount });
            data.transHistory = data.transHistory.slice(0, 10);
            saveData();
            renderAll();
            document.getElementById('transRoute').value = '';
            document.getElementById('transAmount').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // å®¿æ³Šè²»ä¿å­˜
        function saveHotel() {
            const date = document.getElementById('hotelDate').value;
            const name = document.getElementById('hotelName').value;
            const amount = parseInt(document.getElementById('hotelAmount').value);
            if (!date || !name || !amount) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.expenses.push({ date, category: 'hotel', desc: name, amount });
            
            // å±¥æ­´ã«è¿½åŠ 
            const historyKey = `${name}-${amount}`;
            data.hotelHistory = data.hotelHistory.filter(h => `${h.name}-${h.amount}` !== historyKey);
            data.hotelHistory.unshift({ name, amount });
            data.hotelHistory = data.hotelHistory.slice(0, 10);
            saveData();
            renderAll();
            document.getElementById('hotelName').value = '';
            document.getElementById('hotelAmount').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // å‡ºå¼µæ‰‹å½“ä¿å­˜
        function saveAllowance() {
            const date = document.getElementById('allowanceDate').value;
            const amount = 3000;
            if (!date) {
                alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.expenses.push({ date, category: 'allowance', desc: 'å‡ºå¼µæ‰‹å½“', amount });
            saveData();
            renderAll();
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // çµŒè²»å‰Šé™¤
        function deleteExpense(index) {
            if (confirm('ã“ã®çµŒè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                data.expenses.splice(index, 1);
                saveData();
                renderAll();
            }
        }
        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        function openDayModal(dateStr, day) {
            selectedDate = dateStr;
            const dayData = data.workDays[dateStr];
            document.getElementById('modalTitle').textContent = `${currentMonth}æœˆ${day}æ—¥ã®ç·¨é›†`;
            document.getElementById('modalWorkType').value = dayData?.type || '';
            document.getElementById('modalTripDest').value = dayData?.dest || '';
            document.getElementById('modalHourLeave').value = dayData?.hours || '';
            document.getElementById('modalTripDestGroup').style.display = 
                dayData?.type === 'trip' ? 'block' : 'none';
            document.getElementById('modalHourLeaveGroup').style.display = 
                dayData?.type === 'paid-leave-hour' ? 'block' : 'none';
            document.getElementById('dayModal').classList.add('active');
        }
        function closeModal() {
            document.getElementById('dayModal').classList.remove('active');
            selectedDate = null;
        }
        function saveModalWorkDay() {
            const type = document.getElementById('modalWorkType').value;
            const dest = document.getElementById('modalTripDest').value;
            const hours = document.getElementById('modalHourLeave').value;
            if (!type) {
                delete data.workDays[selectedDate];
            } else {
                const workDayData = { type };
                if (type === 'trip' && dest) {
                    workDayData.dest = dest;
                }
                if (type === 'paid-leave-hour' && hours) {
                    workDayData.hours = parseInt(hours);
                }
                data.workDays[selectedDate] = workDayData;
            }
            saveData();
            renderAll();
            closeModal();
        }
        function deleteWorkDay() {
            if (confirm('ã“ã®æ—¥ã®å‹¤å‹™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                delete data.workDays[selectedDate];
                saveData();
                renderAll();
                closeModal();
            }
        }
        // åˆ¤æ–­ãƒ•ãƒ­ãƒ¼
        let flowAnswers = {};
        function selectFlow(step, answer) {
            flowAnswers[step] = answer;
            
            // é¸æŠçŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
            document.querySelectorAll(`#flowStep${step} .flow-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
            if (step === 1) {
                document.getElementById('flowStep2').style.display = 'block';
            } else if (step === 2) {
                document.getElementById('flowStep3').style.display = 'block';
            } else if (step === 3) {
                showFlowResult();
            }
        }
        function showFlowResult() {
            const { 1: dest, 2: season, 3: officeCount } = flowAnswers;
            
            let recommend = false;
            let reason = '';
            // åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯
            if (dest === 'tohoku' && season === 'winter') {
                recommend = true;
                reason = 'å†¬å­£ã®æ±åŒ—å‡ºå¼µã¯é…å»¶ãƒªã‚¹ã‚¯ãŒé«˜ã„ãŸã‚ã€å‰ä¹—ã‚Šã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
            } else if (dest === 'tohoku' && officeCount === '2plus') {
                recommend = true;
                reason = 'å‡ºç¤¾2å›ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ãŠã‚Šã€å‰ä¹—ã‚Šã®èª¬æ˜ãŒã—ã‚„ã™ã„çŠ¶æ³ã§ã™ã€‚';
            } else if (officeCount === '2plus') {
                recommend = true;
                reason = 'å‡ºç¤¾å›æ•°ãŒç¢ºä¿ã§ãã¦ã„ã‚‹ãŸã‚ã€å‰ä¹—ã‚Šã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚';
            } else if (dest === 'other' && season === 'other' && officeCount !== '2plus') {
                recommend = false;
                reason = 'ç‰¹æ®µã®ãƒªã‚¹ã‚¯è¦å› ãŒãªã„ãŸã‚ã€å½“æ—¥ç§»å‹•ã§ã‚‚å•é¡Œãªã„ã§ã—ã‚‡ã†ã€‚';
            } else {
                recommend = false;
                reason = 'çŠ¶æ³ã«å¿œã˜ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚è¿½åŠ ã‚³ã‚¹ãƒˆã¨ç§»å‹•è² è·ã‚’æ¯”è¼ƒã—ã¾ã—ã‚‡ã†ã€‚';
            }
            const resultDiv = document.getElementById('flowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = `flow-result ${recommend ? 'recommend' : 'not-recommend'}`;
            resultDiv.innerHTML = `
                <h3>${recommend ? 'âœ… å‰ä¹—ã‚Šæ¨å¥¨' : 'âš ï¸ å½“æ—¥ç§»å‹•ã§OK'}</h3>
                <p>${reason}</p>
            `;
        }
        function resetFlow() {
            flowAnswers = {};
            document.querySelectorAll('.flow-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('flowStep2').style.display = 'none';
            document.getElementById('flowStep3').style.display = 'none';
            document.getElementById('flowResult').style.display = 'none';
        }
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        function handleDragStart(e, dateStr) {
            draggedDate = dateStr;
            isCopyMode = e.altKey;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = isCopyMode ? 'copy' : 'move';
            e.dataTransfer.setData('text/plain', dateStr);
        }
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedDate = null;
            isCopyMode = false;
            // ã™ã¹ã¦ã®drag-overã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.drag-over, .drag-over-copy').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-copy');
            });
        }
        function handleDragOver(e) {
            if (!draggedDate) return;
            e.preventDefault();
            // Altã‚­ãƒ¼ã®çŠ¶æ…‹ã‚’å¸¸ã«ãƒã‚§ãƒƒã‚¯
            isCopyMode = e.altKey;
            e.dataTransfer.dropEffect = isCopyMode ? 'copy' : 'move';
            const cell = e.currentTarget;
            cell.classList.remove('drag-over', 'drag-over-copy');
            cell.classList.add(isCopyMode ? 'drag-over-copy' : 'drag-over');
        }
        function handleDragLeave(e) {
            const cell = e.currentTarget;
            cell.classList.remove('drag-over', 'drag-over-copy');
        }
        function handleDrop(e, targetDateStr) {
            e.preventDefault();
            if (!draggedDate || draggedDate === targetDateStr) return;
            const sourceData = data.workDays[draggedDate];
            if (!sourceData) return;
            if (isCopyMode || e.altKey) {
                // ã‚³ãƒ”ãƒ¼
                data.workDays[targetDateStr] = { ...sourceData };
            } else {
                // ç§»å‹•
                data.workDays[targetDateStr] = sourceData;
                delete data.workDays[draggedDate];
            }
            saveData();
            renderAll();
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            document.querySelectorAll('.drag-over, .drag-over-copy').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-copy');
            });
        }
        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½
        function showContextMenu(e, dateStr) {
            e.preventDefault();
            contextMenuDate = dateStr;
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            menu.classList.add('active');
        }
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
            contextMenuDate = null;
        }
        function copyToNextDay() {
            if (!contextMenuDate) return;
            const sourceData = data.workDays[contextMenuDate];
            if (!sourceData) return;
            const date = toLocalDate(contextMenuDate);
            date.setDate(date.getDate() + 1);
            const targetDateStr = toDateStr(date);
            data.workDays[targetDateStr] = { ...sourceData };
            saveData();
            renderAll();
            closeContextMenu();
            alert(`ç¿Œæ—¥(${formatDate(targetDateStr)})ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
        }
        function copyToNextWeek() {
            if (!contextMenuDate) return;
            const sourceData = data.workDays[contextMenuDate];
            if (!sourceData) return;
            const date = toLocalDate(contextMenuDate);
            date.setDate(date.getDate() + 7);
            const targetDateStr = toDateStr(date);
            data.workDays[targetDateStr] = { ...sourceData };
            saveData();
            renderAll();
            closeContextMenu();
            alert(`ç¿Œé€±(${formatDate(targetDateStr)})ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
        }
        function copyToMultipleDays() {
            if (!contextMenuDate) return;
            const sourceData = data.workDays[contextMenuDate];
            if (!sourceData) return;
            const days = prompt('ä½•æ—¥åˆ†ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹?(ä¾‹:5)');
            const numDays = parseInt(days);
            if (!numDays || numDays < 1 || numDays > 31) {
                alert('1ã€œ31ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            const startDate = toLocalDate(contextMenuDate);
            let copiedCount = 0;
            for (let i = 1; i <= numDays; i++) {
                const targetDate = new Date(startDate);
                targetDate.setDate(targetDate.getDate() + i);
                const targetDateStr = toDateStr(targetDate);
                data.workDays[targetDateStr] = { ...sourceData };
                copiedCount++;
            }
            saveData();
            renderAll();
            closeContextMenu();
            alert(`${copiedCount}æ—¥åˆ†ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
        }
        function editFromContextMenu() {
            if (!contextMenuDate) return;
            const date = new Date(contextMenuDate);
            const day = date.getDate();
            closeContextMenu();
            openDayModal(contextMenuDate, day);
        }
        function deleteFromContextMenu() {
            if (!contextMenuDate) return;
            if (confirm('ã“ã®æ—¥ã®å‹¤å‹™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                delete data.workDays[contextMenuDate];
                saveData();
                renderAll();
            }
            closeContextMenu();
        }
        // ã‚³ã‚¹ãƒˆæ¯”è¼ƒè¨ˆç®—
        function calcCostCompare() {
            const tokyoCost = parseInt(document.getElementById('costTokyo').value) || 2540;
            const hotelCost = parseInt(document.getElementById('costHotel').value) || 12000;
            // æ¡ˆ1:å½“æ—¥ç§»å‹•
            // æœˆå‡ºç¤¾ + æ°´å‡ºç¤¾ + æœ¨çŸ³å²¡â†’æ±äº¬ + ä»™å°1æ³Š
            const cost1_mon = tokyoCost * 2;  // å¾€å¾©
            const cost1_wed = tokyoCost * 2;  // å¾€å¾©
            const cost1_thu = tokyoCost;      // ç‰‡é“(çŸ³å²¡â†’æ±äº¬)
            const cost1_hotel = hotelCost;    // 1æ³Š
            const cost1_total = cost1_mon + cost1_wed + cost1_thu + cost1_hotel;
            // æ¡ˆ2:å‰ä¹—ã‚Š
            // æœˆå‡ºç¤¾ + æ°´ç‰‡é“ + ä»™å°2æ³Š
            const cost2_mon = tokyoCost * 2;  // å¾€å¾©
            const cost2_wed = tokyoCost;      // ç‰‡é“
            const cost2_hotel = hotelCost * 2; // 2æ³Š
            const cost2_total = cost2_mon + cost2_wed + cost2_hotel;
            document.getElementById('costCompareResult').style.display = 'grid';
            document.getElementById('costDiff').style.display = 'block';
            document.getElementById('cost1Total').textContent = `Â¥${cost1_total.toLocaleString()}`;
            document.getElementById('cost1Breakdown').innerHTML = `
                æœˆå‡ºç¤¾: Â¥${cost1_mon.toLocaleString()}<br>
                æ°´å‡ºç¤¾: Â¥${cost1_wed.toLocaleString()}<br>
                æœ¨ç§»å‹•: Â¥${cost1_thu.toLocaleString()}<br>
                å®¿æ³Š1æ³Š: Â¥${cost1_hotel.toLocaleString()}
            `;
            document.getElementById('cost2Total').textContent = `Â¥${cost2_total.toLocaleString()}`;
            document.getElementById('cost2Breakdown').innerHTML = `
                æœˆå‡ºç¤¾: Â¥${cost2_mon.toLocaleString()}<br>
                æ°´ç‰‡é“: Â¥${cost2_wed.toLocaleString()}<br>
                å®¿æ³Š2æ³Š: Â¥${cost2_hotel.toLocaleString()}
            `;
            const diff = cost2_total - cost1_total;
            document.getElementById('costDiffValue').textContent = `+Â¥${diff.toLocaleString()}`;
        }
        
        // æ—¥ä»˜æ–‡å­—åˆ—ã®æ­£è¦åŒ–ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function parseDate(raw) {
            if (!raw) return null;
            const s = raw.trim();
            
            // æ­£è¦è¡¨ç¾ã§å¹´æœˆæ—¥ã‚’æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ï¼‰
            // å¯¾å¿œå½¢å¼: 2026/1/22, 2026-01-22, 2026å¹´1æœˆ22æ—¥
            let match = s.match(/(\d{4})[\/\-å¹´](\d{1,2})[\/\-æœˆ](\d{1,2})æ—¥?/);
            if (!match) return null;
            
            const year = match[1];
            const month = match[2].padStart(2, '0');
            const day = match[3].padStart(2, '0');
            
            // YYYY-MM-DDå½¢å¼ã§è¿”ã™ï¼ˆæ–‡å­—åˆ—æ“ä½œã®ã¿ã€Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸ä½¿ç”¨ï¼‰
            return `${year}-${month}-${day}`;
        }
        
        // æ—¥ä»˜æ–‡å­—åˆ—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œå›é¿ï¼‰
        function toLocalDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d); // monthã¯0å§‹ã¾ã‚Š
        }
        
        // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ YYYY-MM-DD æ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§ï¼‰
        function toDateStr(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // å‡ºå¼µäºˆå®šå–ã‚Šè¾¼ã¿ (åˆ—ã‚ºãƒ¬è‡ªå‹•è£œæ­£ç‰ˆãƒ»ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œä¿®æ­£ç‰ˆ)
        function importTripSchedule() {
            const scheduleRaw = document.getElementById('tripScheduleData').value.trim();
            const masterRaw = document.getElementById('officeMasterData').value.trim();
            
            if (!scheduleRaw || !masterRaw) {
                alert('äºˆå®šãƒ‡ãƒ¼ã‚¿ã¨ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            // 1. ãƒã‚¹ã‚¿ã®è§£æ (ID -> åå‰)
            const officeMap = {};
            const masterLines = masterRaw.split('\n');
            masterLines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                // ã‚¿ãƒ–ãŒã‚ã‚Œã°ã‚¿ãƒ–å„ªå…ˆã€ãªã‘ã‚Œã°ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
                const cols = trimmed.includes('\t') 
                    ? trimmed.split('\t') 
                    : trimmed.split(/\s+/);
                
                if (cols.length >= 2) {
                    const id = cols[0].trim();
                    // IDä»¥é™ã®æ–‡å­—ã‚’ã™ã¹ã¦åå‰ã¨ã—ã¦çµåˆï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šç¤¾åå¯¾ç­–ï¼‰
                    const name = cols.slice(1).join(' ').trim();
                    if (id && name && !isNaN(Number(id))) { // IDãŒæ•°å­—ã®å ´åˆã®ã¿
                        officeMap[id] = name;
                    }
                }
            });
            
            console.log('å–¶æ¥­æ‰€ãƒã‚¹ã‚¿:', officeMap);

            // 2. äºˆå®šã®è§£æã¨åæ˜ 
            const scheduleLines = scheduleRaw.split('\n');
            let addedCount = 0;
            let skippedCount = 0;
            let skippedReasons = [];
            
            scheduleLines.forEach((line, lineIdx) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                // ã‚¿ãƒ–ãŒã‚ã‚Œã°ã‚¿ãƒ–å„ªå…ˆã€ãªã‘ã‚Œã°ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
                const cols = trimmed.includes('\t') 
                    ? trimmed.split('\t').map(c => c.trim())
                    : trimmed.split(/\s+/);
                
                if (cols.length < 3) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: åˆ—æ•°ä¸è¶³ (${cols.length}åˆ—)`);
                    return;
                }

                // åˆ—ã‚ºãƒ¬ã®è‡ªå‹•æ¤œçŸ¥
                let dateIdx, endIdx, officeIdx;

                if (parseDate(cols[0])) {
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³A: æ—¥ä»˜ãŒå…ˆé ­ (Båˆ—, Cåˆ—, Dåˆ— ã®ã¿ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸå ´åˆ)
                    dateIdx = 0;
                    endIdx = 1;
                    officeIdx = 2;
                } else if (parseDate(cols[1])) {
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³B: IDãŒå…ˆé ­ (Aåˆ—, Båˆ—, Cåˆ—, Dåˆ— ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸå ´åˆ)
                    dateIdx = 1;
                    endIdx = 2;
                    officeIdx = 3;
                } else {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚‰ãªã„ (${cols.slice(0, 3).join(', ')})`);
                    return; // æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚‰ãªã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                }

                // æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹
                const startDateStr = parseDate(cols[dateIdx]);
                const endDateStr = parseDate(cols[endIdx]);
                const officeId = cols[officeIdx]?.trim();

                if (!startDateStr) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: é–‹å§‹æ—¥ãŒç„¡åŠ¹ (${cols[dateIdx]})`);
                    return;
                }
                if (!endDateStr) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: çµ‚äº†æ—¥ãŒç„¡åŠ¹ (${cols[endIdx]})`);
                    return;
                }
                if (!officeId) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: å–¶æ¥­æ‰€IDãŒãªã„`);
                    return;
                }

                const officeName = officeMap[officeId] || 'å‡ºå¼µ';
                
                // æœŸé–“åˆ†ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
                const start = toLocalDate(startDateStr);
                const end = toLocalDate(endDateStr);
                
                // æ—¥ä»˜ãƒ«ãƒ¼ãƒ—
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = toDateStr(d);
                    data.workDays[dateStr] = {
                        type: 'trip',
                        dest: officeName
                    };
                    addedCount++;
                }
            });

            saveData();
            renderAll();
            
            // çµæœè¡¨ç¤º
            const resultEl = document.getElementById('tripImportResult');
            if (addedCount > 0) {
                let msg = `âœ… ${addedCount}æ—¥åˆ†ã®å‡ºå¼µäºˆå®šã‚’ç™»éŒ²ã—ã¾ã—ãŸ`;
                if (skippedCount > 0) {
                    msg += ` (${skippedCount}è¡Œã‚¹ã‚­ãƒƒãƒ—)`;
                }
                resultEl.textContent = msg;
                resultEl.style.color = 'var(--accent-green)';
            } else {
                resultEl.textContent = `âŒ å–ã‚Šè¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ (${skippedCount}è¡Œã‚¹ã‚­ãƒƒãƒ—)`;
                resultEl.style.color = 'var(--accent-red)';
                if (skippedReasons.length > 0) {
                    console.log('ã‚¹ã‚­ãƒƒãƒ—ç†ç”±:', skippedReasons);
                    alert('å–ã‚Šè¾¼ã¿ã‚¨ãƒ©ãƒ¼:\n' + skippedReasons.slice(0, 5).join('\n') + 
                          (skippedReasons.length > 5 ? `\n... ä»–${skippedReasons.length - 5}ä»¶` : ''));
                }
            }
            
            // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
            document.getElementById('tripScheduleData').value = '';
            document.getElementById('officeMasterData').value = '';
        }

        // ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿æ©Ÿèƒ½ (çµŒè²»)
        function importFromClipboard() {
            const rawData = document.getElementById('importData').value.trim();
            if (!rawData) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            const lines = rawData.split('\n');
            if (lines.length < 2) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const headers = lines[0].split('\t').map(h => h.trim());
            
            const isRawFormat = headers.includes('è²»ç›®') && headers.includes('å†…å®¹ãƒ»åŒºé–“');
            const isProcessedFormat = headers.includes('è³¼å…¥å“');

            if (!isRawFormat && !isProcessedFormat) {
                alert('å¯¾å¿œã—ã¦ã„ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nã€Œè²»ç›®/å†…å®¹ãƒ»åŒºé–“ã€ã¾ãŸã¯ã€Œè³¼å…¥å“/æ³¨è¨˜ã€ãŒå«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                return;
            }

            let newRecords = [];
            let duplicateRecords = [];
            let hotelRecords = []; // å®¿æ³Šå±¥æ­´ç”¨
            let skipped = 0;

            const existingKeys = new Set(
                data.expenses.map(e => `${e.date}-${e.amount}-${e.desc}`)
            );
            
            // æ—¢å­˜ã®å®¿æ³Šå±¥æ­´ã‚­ãƒ¼
            const existingHotelKeys = new Set(
                data.hotelStays.map(h => `${h.checkin}-${h.name}`)
            );

            let dateIdx, itemIdx, amountIdx, paymentIdx, noteIdx, categoryIdx, contentIdx;
            let checkinIdx = -1, checkoutIdx = -1;

            if (isRawFormat) {
                dateIdx = headers.indexOf('æ—¥ä»˜');
                categoryIdx = headers.indexOf('è²»ç›®');
                paymentIdx = headers.indexOf('æ”¯æ‰•ç¨®åˆ¥');
                contentIdx = headers.indexOf('å†…å®¹ãƒ»åŒºé–“');
                amountIdx = headers.indexOf('é‡‘é¡');
                // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆåˆ—ã‚’æ¢ã™
                checkinIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³') || h.includes('IN'));
                checkoutIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ') || h.includes('OUT'));
            } else {
                dateIdx = headers.findIndex(h => h.includes('æ—¥ä»˜'));
                itemIdx = headers.findIndex(h => h.includes('è³¼å…¥å“'));
                amountIdx = headers.findIndex(h => h.includes('é‡‘é¡'));
                paymentIdx = headers.findIndex(h => h.includes('ä½¿ç”¨'));
                noteIdx = headers.findIndex(h => h.includes('æ³¨è¨˜'));
                // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆåˆ—ã‚’æ¢ã™
                checkinIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³') || h.includes('IN'));
                checkoutIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ') || h.includes('OUT'));
            }

            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split('\t');
                if (cols.length < 3) continue;

                const dateRaw = cols[dateIdx]?.trim();
                let dateStr = parseDate(dateRaw);
                if (!dateStr) { skipped++; continue; }

                const amountRaw = cols[amountIdx]?.trim() || '0';
                const amount = parseInt(amountRaw.replace(/[Â¥,]/g, ''));
                if (isNaN(amount) || amount === 0) { skipped++; continue; }

                const paymentRaw = cols[paymentIdx]?.trim() || '';
                const paymentType = paymentRaw.includes('æ³•äºº') ? 'æ³•äººã‚«ãƒ¼ãƒ‰' : 'å€‹äººç«‹æ›¿';

                let category = 'other';
                let desc = '';
                let hotelName = '';

                if (isRawFormat) {
                    const rawContent = cols[contentIdx]?.trim() || '';
                    const rawCategory = cols[categoryIdx]?.trim() || '';

                    if (rawCategory === 'äº¤é€šè²»') category = 'transport';
                    else if (rawCategory === 'å®¿æ³Šè²»') category = 'hotel';
                    else if (rawCategory === 'ä¼šè­°è²»') category = 'entertainment';
                    else category = 'other';

                    if (rawContent.includes('@')) {
                        const parts = rawContent.split('@');
                        const item = parts[0];
                        const note = parts[1];
                        desc = `${item} (${note})`;
                        hotelName = item;
                    } else {
                        desc = rawContent;
                        hotelName = rawContent;
                    }

                } else {
                    const item = cols[itemIdx]?.trim() || '';
                    const note = cols[noteIdx]?.trim() || '';
                    
                    if (item.match(/æ–°å¹¹ç·š|ç‰¹æ€¥|é›»è»Š|ã‚¿ã‚¯ã‚·ãƒ¼|ãƒã‚¹|ãƒ•ãƒ©ã‚¤ãƒˆ|èˆªç©ºåˆ¸/)) category = 'transport';
                    else if (item.match(/ãƒ›ãƒ†ãƒ«|å®¿æ³Š|ã‚¤ãƒ³|ã‚¢ãƒ‘|æ±æ¨ª/)) category = 'hotel';
                    else if (item.match(/æ‰‹å½“|æ—¥å½“/)) category = 'allowance';
                    else if (item.match(/é£²é£Ÿ|ä¼šé£Ÿ|æ˜¼é£Ÿ|å¤•é£Ÿ/)) category = 'entertainment';

                    desc = note ? `${item} (${note})` : item;
                    hotelName = item;
                }

                const record = {
                    date: dateStr,
                    category: category,
                    desc: desc,
                    amount: amount,
                    paymentType: paymentType
                };

                const key = `${dateStr}-${amount}-${desc}`;
                if (existingKeys.has(key)) {
                    duplicateRecords.push(record);
                } else {
                    newRecords.push(record);
                }
                
                // å®¿æ³Šè²»ã®å ´åˆã€å®¿æ³Šå±¥æ­´ã«è¿½åŠ 
                if (category === 'hotel' && hotelName) {
                    let checkinDate = dateStr;
                    let checkoutDate = '';
                    
                    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆåˆ—ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    if (checkinIdx >= 0 && cols[checkinIdx]) {
                        const parsedCheckin = parseDate(cols[checkinIdx]?.trim());
                        if (parsedCheckin) checkinDate = parsedCheckin;
                    }
                    if (checkoutIdx >= 0 && cols[checkoutIdx]) {
                        const parsedCheckout = parseDate(cols[checkoutIdx]?.trim());
                        if (parsedCheckout) checkoutDate = parsedCheckout;
                    }
                    
                    const hotelKey = `${checkinDate}-${hotelName}`;
                    if (!existingHotelKeys.has(hotelKey)) {
                        const area = guessArea(hotelName);
                        hotelRecords.push({
                            checkin: checkinDate,
                            checkout: checkoutDate,
                            name: hotelName,
                            area: area,
                            price: amount,
                            access: '',
                            room: '',
                            food: '',
                            memo: ''
                        });
                        existingHotelKeys.add(hotelKey);
                    }
                }
            }

            if (newRecords.length === 0 && duplicateRecords.length === 0) {
                document.getElementById('importResult').textContent = `å–ã‚Šè¾¼ã¿å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ(ã‚¹ã‚­ãƒƒãƒ—: ${skipped}ä»¶)`;
                document.getElementById('importResult').style.color = 'var(--accent-orange)';
                return;
            }

            let finalImportList = [...newRecords];
            let msg = `æ–°è¦ãƒ‡ãƒ¼ã‚¿: ${newRecords.length}ä»¶\n`;
            
            if (duplicateRecords.length > 0) {
                if (confirm(`${duplicateRecords.length}ä»¶ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ï¼ˆåŒæ—¥ãƒ»åŒé¡ãƒ»åŒå†…å®¹ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\nã“ã‚Œã‚‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ\n\n[OK] = é‡è¤‡ã¯ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹\n[ã‚­ãƒ£ãƒ³ã‚»ãƒ«] = é‡è¤‡ã‚‚å«ã‚ã¦å…¨ã¦å–ã‚Šè¾¼ã‚€`)) {
                     msg += `é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${duplicateRecords.length}ä»¶`;
                } else {
                    finalImportList = finalImportList.concat(duplicateRecords);
                    msg += `é‡è¤‡å–ã‚Šè¾¼ã¿: ${duplicateRecords.length}ä»¶`;
                }
            }

            finalImportList.forEach(r => data.expenses.push(r));
            
            // å®¿æ³Šå±¥æ­´ã«è¿½åŠ 
            if (hotelRecords.length > 0) {
                hotelRecords.forEach(h => data.hotelStays.push(h));
                data.hotelStays.sort((a, b) => b.checkin.localeCompare(a.checkin));
                msg += `\nå®¿æ³Šå±¥æ­´: ${hotelRecords.length}ä»¶è¿½åŠ `;
            }
            
            saveData();
            renderAll();

            document.getElementById('importResult').textContent = `âœ… å–ã‚Šè¾¼ã¿å®Œäº† (${msg})`;
            document.getElementById('importResult').style.color = 'var(--accent-green)';
            document.getElementById('importData').value = '';
            
            if (finalImportList.length > 0) {
                const preview = finalImportList.slice(0, 5).map(e => 
                    `${e.date} | ${getCategoryLabel(e.category)} | ${e.desc} | Â¥${e.amount.toLocaleString()}`
                ).join('<br>');
                document.getElementById('importPreview').style.display = 'block';
                document.getElementById('importPreviewContent').innerHTML = preview + 
                    (finalImportList.length > 5 ? `<br>... ä»– ${finalImportList.length - 5}ä»¶` : '');
            }
        }

        // ========== ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆæ©Ÿèƒ½ ==========
        function getEventTypeLabel(type) {
            const labels = {
                'meeting': 'ğŸ—“ï¸ ä¼šè­°',
                'training': 'ğŸ“š ç ”ä¿®',
                'ceremony': 'ğŸ‰ å¼å…¸',
                'party': 'ğŸ» æ‡‡è¦ªä¼š',
                'other': 'ğŸ“ ãã®ä»–'
            };
            return labels[type] || type;
        }

        function saveEvent() {
            const date = document.getElementById('eventDate').value;
            const type = document.getElementById('eventType').value;
            const name = document.getElementById('eventName').value;
            const location = document.getElementById('eventLocation').value;
            const memo = document.getElementById('eventMemo').value;

            if (!date || !name) {
                alert('æ—¥ä»˜ã¨ã‚¤ãƒ™ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            data.events.push({ date, type, name, location, memo });
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('eventName').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventMemo').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        function renderEventTable() {
            const tbody = document.getElementById('eventTableBody');
            if (!data.events || data.events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // ã‚½ãƒ¼ãƒˆ
            const { key, order } = sortState.event;
            const sortedEvents = [...data.events].sort((a, b) => {
                let valA = a[key] || '';
                let valB = b[key] || '';
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
            updateSortHeaders('event', key, order);

            tbody.innerHTML = sortedEvents.map((e) => {
                const globalIndex = data.events.indexOf(e);
                return `
                <tr style="cursor: pointer;" onclick="openEventDetailModal(${globalIndex})">
                    <td onclick="event.stopPropagation();"><input type="checkbox" class="event-checkbox" data-index="${globalIndex}"></td>
                    <td>${formatDate(e.date)}</td>
                    <td>${getEventTypeLabel(e.type)}</td>
                    <td>${e.name}</td>
                    <td>${e.location || '-'}</td>
                    <td>${e.memo || '-'}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="delete-btn" onclick="duplicateEvent(${globalIndex})" title="è¤‡è£½" style="margin-right: 4px;">ğŸ“‹</button>
                        <button class="delete-btn" onclick="deleteEvent(${globalIndex})" title="å‰Šé™¤">âœ•</button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
        function sortEventTable(key) {
            if (sortState.event.key === key) {
                sortState.event.order = sortState.event.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.event.key = key;
                sortState.event.order = 'asc';
            }
            renderEventTable();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEventDetailModal(index) {
            const e = data.events[index];
            if (!e) return;
            
            document.getElementById('eventDetailIndex').value = index;
            document.getElementById('eventDetailDate').value = e.date || '';
            document.getElementById('eventDetailType').value = e.type || 'meeting';
            document.getElementById('eventDetailName').value = e.name || '';
            document.getElementById('eventDetailLocation').value = e.location || '';
            document.getElementById('eventDetailMemo').value = e.memo || '';
            
            document.getElementById('eventDetailModal').classList.add('active');
        }
        
        function closeEventDetailModal() {
            document.getElementById('eventDetailModal').classList.remove('active');
        }
        
        function saveEventDetail() {
            const index = parseInt(document.getElementById('eventDetailIndex').value);
            if (isNaN(index)) return;
            
            data.events[index] = {
                date: document.getElementById('eventDetailDate').value,
                type: document.getElementById('eventDetailType').value,
                name: document.getElementById('eventDetailName').value,
                location: document.getElementById('eventDetailLocation').value,
                memo: document.getElementById('eventDetailMemo').value
            };
            
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();
            renderCalendar();
            closeEventDetailModal();
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        function deleteEventFromModal() {
            const index = parseInt(document.getElementById('eventDetailIndex').value);
            if (isNaN(index)) return;
            
            if (confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.events.splice(index, 1);
                saveData();
                renderEventTable();
                renderCalendar();
                closeEventDetailModal();
            }
        }
        
        function duplicateEventFromModal() {
            const index = parseInt(document.getElementById('eventDetailIndex').value);
            if (isNaN(index)) return;
            
            const original = data.events[index];
            const newEvent = { ...original };
            data.events.push(newEvent);
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();
            renderCalendar();
            closeEventDetailModal();
            alert('è¤‡è£½ã—ã¾ã—ãŸï¼ˆä¸€è¦§ã«è¿½åŠ ï¼‰');
        }

        function deleteEvent(index) {
            if (confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.events.splice(index, 1);
                saveData();
                renderEventTable();
                renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚æ›´æ–°
            }
        }
        
        function duplicateEvent(index) {
            const original = data.events[index];
            if (!original) return;
            
            const newEvent = { ...original };
            data.events.push(newEvent);
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();
            renderCalendar();
            alert('è¤‡è£½ã—ã¾ã—ãŸ');
        }

        function selectAllEvents() {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('eventSelectAll').checked = true;
        }

        function deselectAllEvents() {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('eventSelectAll').checked = false;
        }

        function toggleAllEventCheckboxes(headerCheckbox) {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = headerCheckbox.checked);
        }

        function deleteSelectedEvents() {
            const checkedBoxes = document.querySelectorAll('.event-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!confirm(`${checkedBoxes.length}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            const indices = Array.from(checkedBoxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            indices.forEach(idx => data.events.splice(idx, 1));
            saveData();
            renderEventTable();
            alert(`${checkedBoxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        // ========== å®¿æ³Šå±¥æ­´æ©Ÿèƒ½ ==========
        function saveHotelHistory() {
            const checkin = document.getElementById('hotelCheckin').value;
            const checkout = document.getElementById('hotelCheckout').value;
            const name = document.getElementById('hotelNameInput').value;
            const area = document.getElementById('hotelArea').value;
            const price = parseInt(document.getElementById('hotelPrice').value) || 0;
            const access = document.getElementById('hotelAccess').value;
            const room = document.getElementById('hotelRoom').value;
            const food = document.getElementById('hotelFood').value;
            const memo = document.getElementById('hotelMemo').value;

            if (!checkin || !name) {
                alert('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥ã¨ãƒ›ãƒ†ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            data.hotelStays.push({ checkin, checkout, name, area, price, access, room, food, memo });
            data.hotelStays.sort((a, b) => b.checkin.localeCompare(a.checkin)); // æ–°ã—ã„é †
            saveData();
            renderHotelTable();

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('hotelNameInput').value = '';
            document.getElementById('hotelArea').value = '';
            document.getElementById('hotelPrice').value = '';
            document.getElementById('hotelAccess').value = '';
            document.getElementById('hotelRoom').value = '';
            document.getElementById('hotelFood').value = '';
            document.getElementById('hotelMemo').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        // å®¿æ³Šå±¥æ­´ã®ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importHotelHistory() {
            const rawData = document.getElementById('hotelImportData').value.trim();
            if (!rawData) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            const lines = rawData.split('\n');
            let imported = 0;
            let skipped = 0;
            let currentHotel = null;
            let currentCheckin = null;

            // é€£ç¶šã™ã‚‹åŒã˜ãƒ›ãƒ†ãƒ«ã‚’ã¾ã¨ã‚ã‚‹å‡¦ç†
            const stays = [];

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;

                // ã‚¿ãƒ–åŒºåˆ‡ã‚Šã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Š
                const parts = trimmed.includes('\t') ? trimmed.split('\t') : trimmed.split(/\s{2,}/);
                if (parts.length < 1) return;

                // æ—¥ä»˜ã‚’æŠ½å‡º (2024/6/10(æœˆ) ãªã©)
                const dateMatch = parts[0].match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
                if (!dateMatch) {
                    skipped++;
                    return;
                }

                const dateStr = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
                const hotelName = parts[1]?.trim().replace(/^["ã€€]+|["ã€€]+$/g, '') || '';

                if (!hotelName) {
                    // ãƒ›ãƒ†ãƒ«åãŒç©ºã®æ—¥ã¯ã€å‰ã®ãƒ›ãƒ†ãƒ«ãŒãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ãŸã¨ã¿ãªã™
                    if (currentHotel && currentCheckin) {
                        // å‰æ—¥ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥ã¨ã—ã¦ä¿å­˜
                        stays.push({
                            checkin: currentCheckin,
                            checkout: currentCheckin, // å˜æ³Šã®å ´åˆ
                            name: currentHotel,
                            area: guessArea(currentHotel),
                            stayCount: 1
                        });
                        currentHotel = null;
                        currentCheckin = null;
                    }
                    return;
                }

                // æ–°ã—ã„ãƒ›ãƒ†ãƒ«ã¾ãŸã¯é•ã†ãƒ›ãƒ†ãƒ«
                if (currentHotel !== hotelName) {
                    // å‰ã®ãƒ›ãƒ†ãƒ«ã‚’ä¿å­˜
                    if (currentHotel && currentCheckin) {
                        stays.push({
                            checkin: currentCheckin,
                            checkout: dateStr,
                            name: currentHotel,
                            area: guessArea(currentHotel)
                        });
                    }
                    currentHotel = hotelName;
                    currentCheckin = dateStr;
                }
            });

            // æœ€å¾Œã®ãƒ›ãƒ†ãƒ«ã‚’ä¿å­˜
            if (currentHotel && currentCheckin) {
                stays.push({
                    checkin: currentCheckin,
                    checkout: currentCheckin,
                    name: currentHotel,
                    area: guessArea(currentHotel)
                });
            }

            // é€£ç¶šã™ã‚‹åŒã˜ãƒ›ãƒ†ãƒ«ã‚’ãƒãƒ¼ã‚¸
            const mergedStays = [];
            stays.forEach(stay => {
                const last = mergedStays[mergedStays.length - 1];
                if (last && last.name === stay.name && last.checkout === stay.checkin) {
                    last.checkout = stay.checkout;
                } else {
                    mergedStays.push({ ...stay });
                }
            });

            // ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
            mergedStays.forEach(stay => {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const exists = data.hotelStays.some(h => 
                    h.checkin === stay.checkin && h.name === stay.name
                );
                if (!exists) {
                    data.hotelStays.push(stay);
                    imported++;
                } else {
                    skipped++;
                }
            });

            data.hotelStays.sort((a, b) => b.checkin.localeCompare(a.checkin));
            saveData();
            renderHotelTable();

            const resultEl = document.getElementById('hotelImportResult');
            resultEl.textContent = `âœ… ${imported}ä»¶ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ${skipped > 0 ? `ï¼ˆ${skipped}ä»¶ã‚¹ã‚­ãƒƒãƒ—ï¼‰` : ''}`;
            resultEl.style.color = imported > 0 ? 'var(--accent-green)' : 'var(--accent-orange)';
            document.getElementById('hotelImportData').value = '';
        }

        // ãƒ›ãƒ†ãƒ«åã‹ã‚‰ã‚¨ãƒªã‚¢ã‚’æ¨æ¸¬
        function guessArea(hotelName) {
            const areaMap = {
                'æ¨ªæµœ': 'æ¨ªæµœ', 'æ–°æ¨ªæµœ': 'æ¨ªæµœ', 'æ¡œæœ¨ç”º': 'æ¨ªæµœ', 'é–¢å†…': 'æ¨ªæµœ', 'ã‚»ãƒ³ã‚¿ãƒ¼å—': 'æ¨ªæµœ',
                'ä»™å°': 'ä»™å°',
                'å²¡å±±': 'å²¡å±±',
                'åå¤å±‹': 'åå¤å±‹', 'æ „': 'åå¤å±‹', 'ç´å±‹æ©‹': 'åå¤å±‹',
                'åšå¤š': 'ç¦å²¡', 'ç¦å²¡': 'ç¦å²¡', 'å¤©ç¥': 'ç¦å²¡',
                'å¤§é˜ª': 'å¤§é˜ª', 'æ–°å¤§é˜ª': 'å¤§é˜ª', 'å º': 'å¤§é˜ª',
                'æœ­å¹Œ': 'æœ­å¹Œ',
                'å½¦æ ¹': 'å½¦æ ¹', 'è¿‘æ±Ÿå…«å¹¡': 'æ»‹è³€',
                'å¿—æœ¨': 'åŸ¼ç‰', 'æµ¦å’Œ': 'åŸ¼ç‰',
                'æµå±±': 'åƒè‘‰',
                'ä¸Šé‡': 'æ±äº¬', 'æ—¥æœ¬æ©‹': 'æ±äº¬', 'æ°´é“æ©‹': 'æ±äº¬', 'äººå½¢ç”º': 'æ±äº¬'
            };
            for (const [keyword, area] of Object.entries(areaMap)) {
                if (hotelName.includes(keyword)) return area;
            }
            return '';
        }

        function renderHotelTable() {
            const tbody = document.getElementById('hotelTableBody');
            const filterArea = document.getElementById('hotelFilterArea').value;

            if (!data.hotelStays) data.hotelStays = [];

            // ã‚¨ãƒªã‚¢ãƒ•ã‚£ãƒ«ã‚¿ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
            const areas = [...new Set(data.hotelStays.map(h => h.area).filter(a => a))];
            const filterSelect = document.getElementById('hotelFilterArea');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '<option value="">å…¨ã‚¨ãƒªã‚¢</option>' + 
                areas.map(a => `<option value="${a}"${a === currentFilter ? ' selected' : ''}>${a}</option>`).join('');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filtered = [...data.hotelStays];
            if (filterArea) {
                filtered = filtered.filter(h => h.area === filterArea);
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">å®¿æ³Šå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            // æ³Šæ•°ã¨è©•ä¾¡ã‚’è¨ˆç®—ã—ã¦è¿½åŠ 
            filtered = filtered.map(h => {
                let nights = 1;
                if (h.checkout && h.checkout !== h.checkin) {
                    const checkinDate = new Date(h.checkin);
                    const checkoutDate = new Date(h.checkout);
                    nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                }
                const ratings = [h.access, h.room, h.food].filter(r => r).map(Number);
                const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length) : 0;
                return { ...h, nights, avgRating };
            });
            
            // ã‚½ãƒ¼ãƒˆ
            const { key, order } = sortState.hotel;
            filtered.sort((a, b) => {
                let valA, valB;
                if (key === 'nights') {
                    valA = a.nights;
                    valB = b.nights;
                } else if (key === 'price') {
                    valA = Number(a.price) || 0;
                    valB = Number(b.price) || 0;
                } else if (key === 'rating') {
                    valA = a.avgRating;
                    valB = b.avgRating;
                } else {
                    valA = a[key] || '';
                    valB = b[key] || '';
                }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
            updateSortHeaders('hotel', key, order);

            tbody.innerHTML = filtered.map((h) => {
                const globalIndex = data.hotelStays.findIndex(orig => 
                    orig.checkin === h.checkin && orig.name === h.name && orig.checkout === h.checkout
                );
                const ratingDisplay = h.avgRating > 0 ? h.avgRating.toFixed(1) : '-';
                
                // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€œãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’è¡¨ç¤º
                const dateLabel = h.checkout && h.checkout !== h.checkin 
                    ? `${formatDate(h.checkin)}ã€œ${formatDate(h.checkout)}`
                    : formatDate(h.checkin);
                
                // é‡‘é¡è¡¨ç¤º
                const priceDisplay = h.price ? `Â¥${Number(h.price).toLocaleString()}` : '-';
                
                return `
                <tr style="cursor: pointer;" onclick="openHotelDetailModal(${globalIndex})">
                    <td onclick="event.stopPropagation();"><input type="checkbox" class="hotel-checkbox" data-index="${globalIndex}"></td>
                    <td>${dateLabel}</td>
                    <td>${h.name}</td>
                    <td>${h.area || '-'}</td>
                    <td style="text-align: center;">${h.nights}æ³Š</td>
                    <td class="amount">${priceDisplay}</td>
                    <td style="text-align: center; color: #fbbf24;">${ratingDisplay}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="delete-btn" onclick="duplicateHotelStayByIndex(${globalIndex})" title="è¤‡è£½" style="margin-right: 4px;">ğŸ“‹</button>
                        <button class="delete-btn" onclick="deleteHotelStay(${globalIndex})" title="å‰Šé™¤">âœ•</button>
                    </td>
                </tr>
            `}).join('');

            // ã‚¯ã‚¤ãƒƒã‚¯å±¥æ­´è¡¨ç¤º
            const quickHistory = document.getElementById('hotelHistoryQuick');
            const uniqueHotels = [...new Map(data.hotelStays.map(h => [h.name, h])).values()].slice(0, 10);
            quickHistory.innerHTML = uniqueHotels.map(h => 
                `<div class="history-item" onclick="fillHotelHistory('${h.name}', '${h.area || ''}')">${h.name}${h.area ? ` (${h.area})` : ''}</div>`
            ).join('');
        }
        
        // å®¿æ³Šãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
        function sortHotelTable(key) {
            if (sortState.hotel.key === key) {
                sortState.hotel.order = sortState.hotel.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.hotel.key = key;
                sortState.hotel.order = key === 'checkin' ? 'desc' : 'asc';
            }
            renderHotelTable();
        }

        // å®¿æ³Šå±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openHotelDetailModal(index) {
            const h = data.hotelStays[index];
            if (!h) return;
            
            document.getElementById('hotelDetailIndex').value = index;
            document.getElementById('hotelDetailCheckin').value = h.checkin || '';
            document.getElementById('hotelDetailCheckout').value = h.checkout || '';
            document.getElementById('hotelDetailName').value = h.name || '';
            document.getElementById('hotelDetailArea').value = h.area || '';
            document.getElementById('hotelDetailPrice').value = h.price || '';
            document.getElementById('hotelDetailAccess').value = h.access || '';
            document.getElementById('hotelDetailRoom').value = h.room || '';
            document.getElementById('hotelDetailFood').value = h.food || '';
            document.getElementById('hotelDetailMemo').value = h.memo || '';
            
            document.getElementById('hotelDetailModal').classList.add('active');
        }
        
        function closeHotelDetailModal() {
            document.getElementById('hotelDetailModal').classList.remove('active');
        }
        
        function saveHotelDetail() {
            const index = parseInt(document.getElementById('hotelDetailIndex').value);
            if (isNaN(index)) return;
            
            data.hotelStays[index] = {
                checkin: document.getElementById('hotelDetailCheckin').value,
                checkout: document.getElementById('hotelDetailCheckout').value,
                name: document.getElementById('hotelDetailName').value,
                area: document.getElementById('hotelDetailArea').value,
                price: parseInt(document.getElementById('hotelDetailPrice').value) || 0,
                access: document.getElementById('hotelDetailAccess').value,
                room: document.getElementById('hotelDetailRoom').value,
                food: document.getElementById('hotelDetailFood').value,
                memo: document.getElementById('hotelDetailMemo').value
            };
            
            saveData();
            renderHotelTable();
            closeHotelDetailModal();
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        function deleteHotelStayFromModal() {
            const index = parseInt(document.getElementById('hotelDetailIndex').value);
            if (isNaN(index)) return;
            
            if (confirm('ã“ã®å®¿æ³Šå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.hotelStays.splice(index, 1);
                saveData();
                renderHotelTable();
                closeHotelDetailModal();
            }
        }
        
        function duplicateHotelStay() {
            const index = parseInt(document.getElementById('hotelDetailIndex').value);
            if (isNaN(index)) return;
            
            const original = data.hotelStays[index];
            const newStay = { ...original };
            data.hotelStays.unshift(newStay);
            saveData();
            renderHotelTable();
            closeHotelDetailModal();
            alert('è¤‡è£½ã—ã¾ã—ãŸï¼ˆä¸€è¦§ã®å…ˆé ­ã«è¿½åŠ ï¼‰');
        }
        
        function duplicateHotelStayByIndex(index) {
            const original = data.hotelStays[index];
            if (!original) return;
            
            const newStay = { ...original };
            data.hotelStays.unshift(newStay);
            saveData();
            renderHotelTable();
            alert('è¤‡è£½ã—ã¾ã—ãŸ');
        }

        function fillHotelHistory(name, area) {
            document.getElementById('hotelNameInput').value = name;
            document.getElementById('hotelArea').value = area;
        }

        function deleteHotelStay(index) {
            event.stopPropagation();
            if (confirm('ã“ã®å®¿æ³Šå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.hotelStays.splice(index, 1);
                saveData();
                renderHotelTable();
            }
        }

        function selectAllHotels() {
            document.querySelectorAll('.hotel-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('hotelSelectAll').checked = true;
        }

        function deselectAllHotels() {
            document.querySelectorAll('.hotel-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('hotelSelectAll').checked = false;
        }

        function toggleAllHotelCheckboxes(headerCheckbox) {
            document.querySelectorAll('.hotel-checkbox').forEach(cb => cb.checked = headerCheckbox.checked);
        }

        function deleteSelectedHotels() {
            const checkedBoxes = document.querySelectorAll('.hotel-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!confirm(`${checkedBoxes.length}ä»¶ã®å®¿æ³Šå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            const indices = Array.from(checkedBoxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            indices.forEach(idx => data.hotelStays.splice(idx, 1));
            saveData();
            renderHotelTable();
            alert(`${checkedBoxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
    </script>
</body>
</html>