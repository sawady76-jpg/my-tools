<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™ãƒ»å‡ºå¼µç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-card: #242b33;
            --bg-hover: #2d353f;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-purple: #8b5cf6;
            --accent-red: #ef4444;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 24px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        h1 {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        h1::before {
            content: 'ğŸ“Š';
        }
        .month-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .month-selector button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        .month-selector button:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }
        .month-selector span {
            font-size: 1.2rem;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }
        /* åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .sync-status:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }
        .sync-status .spinning {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        .tab:hover {
            background: var(--bg-hover);
        }
        .tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        .panel {
            display: none;
        }
        .panel.active {
            display: block;
        }
        /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        .summary-card .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .summary-card .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }
        .summary-card .unit {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 4px;
        }
        .summary-card.blue .value { color: var(--accent-blue); }
        .summary-card.green .value { color: var(--accent-green); }
        .summary-card.orange .value { color: var(--accent-orange); }
        .summary-card.purple .value { color: var(--accent-purple); }
        .summary-card.red .value { color: var(--accent-red); }
        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 1px solid var(--border);
        }
        .calendar-header span {
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-secondary);
            padding: 10px 0;
            background: var(--bg-card);
        }
        .calendar-header span:first-child {
            color: #f87171;
        }
        .calendar-header span:last-child {
            color: #60a5fa;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-day {
            min-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 1rem;
            position: relative;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }
        .calendar-day:hover {
            background: var(--bg-hover);
        }
        .calendar-day.empty {
            cursor: default;
            background: var(--bg-card);
            opacity: 0.5;
        }
        .calendar-day.today {
            background: rgba(59, 130, 246, 0.15);
        }
        .calendar-day.today .date {
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-day .date {
            font-weight: 700;
            font-size: 1.15rem;
            margin-bottom: 4px;
        }
        .calendar-day .type-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            margin-top: 2px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 95%;
        }
        .calendar-day .dest-label {
            font-size: 0.75rem;
            color: var(--text-primary);
            margin-top: 2px;
            background: rgba(0,0,0,0.25);
            padding: 1px 5px;
            border-radius: 3px;
            max-width: 95%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .calendar-day .event-badge {
            font-size: 0.65rem;
            color: #fef3c7;
            background: #b45309;
            padding: 1px 5px;
            border-radius: 3px;
            margin-top: 2px;
            max-width: 95%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .calendar-day.office { background: rgba(59, 130, 246, 0.2); }
        .calendar-day.office .type-badge { background: var(--accent-blue); }
        .calendar-day.remote { background: rgba(16, 185, 129, 0.2); }
        .calendar-day.remote .type-badge { background: var(--accent-green); }
        .calendar-day.trip { background: rgba(245, 158, 11, 0.2); }
        .calendar-day.trip .type-badge { background: var(--accent-orange); }
        .calendar-day.paid-leave { background: rgba(139, 92, 246, 0.2); }
        .calendar-day.paid-leave .type-badge { background: var(--accent-purple); }
        .calendar-day.paid-leave-am { background: rgba(139, 92, 246, 0.15); }
        .calendar-day.paid-leave-am .type-badge { background: #a78bfa; }
        .calendar-day.paid-leave-pm { background: rgba(139, 92, 246, 0.15); }
        .calendar-day.paid-leave-pm .type-badge { background: #a78bfa; }
        .calendar-day.paid-leave-hour { background: rgba(139, 92, 246, 0.1); }
        .calendar-day.paid-leave-hour .type-badge { background: #c4b5fd; color: #1f2937; }
        /* åˆå‰/åˆå¾Œåˆ¥ï¼ˆsplitï¼‰ã®è¡¨ç¤º */
        .calendar-day.split { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 50%, rgba(245, 158, 11, 0.2) 50%); 
        }
        .calendar-day.split .type-badge.split-badge { 
            background: linear-gradient(90deg, var(--accent-blue) 50%, var(--accent-orange) 50%);
            font-size: 0.6rem;
            padding: 2px 6px;
        }
        .calendar-day.saturday .date { color: #60a5fa; }
        .calendar-day.sunday .date { color: #f87171; }
        .calendar-day.holiday .date { color: #f87171; }
        .calendar-day.holiday::after {
            content: 'ç¥';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.7rem;
            color: #f87171;
            font-weight: bold;
        }
        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .form-section h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        .btn-primary:hover {
            background: #2563eb;
        }
        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        .btn-danger {
            background: var(--accent-red);
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        /* å±¥æ­´ãƒªã‚¹ãƒˆ */
        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        .history-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .history-item:hover {
            border-color: var(--accent-blue);
            background: var(--bg-hover);
        }
        /* çµŒè²»ãƒ†ãƒ¼ãƒ–ãƒ« */
        .expense-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }
        .expense-table th,
        .expense-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        .expense-table th {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .expense-table td {
            font-size: 0.9rem;
        }
        .expense-table .amount {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }
        .expense-table .delete-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }
        .expense-table .delete-btn:hover {
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }
        .expense-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-blue);
        }
        .expense-table tr:has(input:checked) {
            background: rgba(59, 130, 246, 0.1);
        }
        /* ã‚½ãƒ¼ãƒˆå¯èƒ½ãªãƒ˜ãƒƒãƒ€ãƒ¼ */
        .expense-table th.sortable {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }
        .expense-table th.sortable:hover {
            color: var(--accent-blue);
        }
        .expense-table th.sortable::after {
            content: ' â†•';
            opacity: 0.3;
            font-size: 0.7rem;
        }
        .expense-table th.sortable.asc::after {
            content: ' â–²';
            opacity: 1;
            color: var(--accent-blue);
        }
        .expense-table th.sortable.desc::after {
            content: ' â–¼';
            opacity: 1;
            color: var(--accent-blue);
        }
        /* åˆ¤æ–­ãƒ•ãƒ­ãƒ¼ */
        .flow-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .flow-question {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .flow-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .flow-option {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .flow-option:hover {
            border-color: var(--accent-blue);
        }
        .flow-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        .flow-result {
            margin-top: 24px;
            padding: 20px;
            border-radius: 12px;
            font-size: 1rem;
        }
        .flow-result.recommend {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent-green);
        }
        .flow-result.not-recommend {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--accent-orange);
        }
        .flow-result h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .flow-result.recommend h3 { color: var(--accent-green); }
        .flow-result.not-recommend h3 { color: var(--accent-orange); }
        /* ã‚³ã‚¹ãƒˆæ¯”è¼ƒ */
        .cost-compare {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .cost-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .cost-box h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        .cost-box .total {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        .cost-box .breakdown {
            margin-top: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .cost-diff {
            text-align: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-top: 16px;
        }
        .cost-diff .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .cost-diff .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-orange);
        }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal h2 {
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            header {
                flex-direction: column;
                gap: 16px;
            }
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .cost-compare {
                grid-template-columns: 1fr;
            }
            .calendar-day {
                font-size: 0.9rem;
            }
            .calendar-day .type-badge {
                font-size: 0.6rem;
                padding: 1px 4px;
            }
        }
        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
        .calendar-day[draggable="true"] {
            cursor: move;
        }
        .calendar-day.dragging {
            opacity: 0.4;
            cursor: grabbing;
        }
        .calendar-day.drag-over {
            border: 2px dashed var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }
        .calendar-day.drag-over-copy {
            border: 2px dashed var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }
        .calendar-day.drag-over-copy::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: var(--accent-green);
            font-weight: 700;
            pointer-events: none;
        }
        /* ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .context-menu {
            display: none;
            position: absolute;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px;
            z-index: 2000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            min-width: 200px;
        }
        .context-menu.active {
            display: block;
        }
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-item:hover {
            background: var(--bg-hover);
        }
        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 8px;
        }
        /* å‡¡ä¾‹ */
        .legend {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
        }
        .legend-color.office { background: var(--accent-blue); }
        .legend-color.remote { background: var(--accent-green); }
        .legend-color.trip { background: var(--accent-orange); }
        .legend-color.paid-leave { background: var(--accent-purple); }
        
        /* æ³•äººã‚«ãƒ¼ãƒ‰ç· ã‚æœŸé–“ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .corporate-card-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .corporate-card-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 12px;
        }
        .period-nav-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .period-nav-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-purple);
        }
        .period-info {
            text-align: center;
            min-width: 150px;
        }
        .period-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .period-range {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-purple);
        }
        .corporate-card-amount {
            text-align: center;
        }
        .corporate-card-amount .amount-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-purple);
        }
        .corporate-card-amount .amount-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-left: 8px;
        }
        /* ã‚°ãƒ©ãƒ•ç”¨CSS */
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
        }
        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            height: 200px;
            padding: 10px 0;
        }
        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .bar-stack {
            width: 100%;
            display: flex;
            flex-direction: column-reverse;
            max-width: 40px;
        }
        .bar-segment {
            width: 100%;
            min-height: 2px;
            transition: height 0.3s;
        }
        .bar-segment.office { background: var(--accent-blue); }
        .bar-segment.remote { background: var(--accent-green); }
        .bar-segment.trip { background: var(--accent-orange); }
        .bar-segment.paidLeave { background: var(--accent-purple); }
        .bar-segment.transport { background: #3b82f6; }
        .bar-segment.hotel { background: #f59e0b; }
        .bar-segment.allowance { background: #10b981; }
        .bar-segment.entertainment { background: #8b5cf6; }
        .bar-segment.other { background: #6b7280; }
        .bar-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        .bar-value {
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        /* å††ã‚°ãƒ©ãƒ•é¢¨ã®è¡¨ç¤º */
        .pie-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .pie-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        .pie-legend-label {
            flex: 1;
            font-size: 0.9rem;
        }
        .pie-legend-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        .pie-legend-percent {
            font-size: 0.8rem;
            color: var(--text-muted);
            width: 50px;
            text-align: right;
        }
        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .ranking-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .ranking-rank {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }
        .ranking-rank.gold { background: #fbbf24; color: #1f2937; }
        .ranking-rank.silver { background: #9ca3af; color: #1f2937; }
        .ranking-rank.bronze { background: #d97706; color: white; }
        .ranking-rank.normal { background: var(--bg-card); color: var(--text-secondary); }
        .ranking-dest { flex: 1; font-size: 0.95rem; }
        .ranking-count { font-weight: 600; color: var(--accent-orange); }
        /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ */
        .template-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .template-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .template-days {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .template-day-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-card);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å‹¤å‹™ãƒ»å‡ºå¼µç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div id="syncStatus" class="sync-status" onclick="manualSync()" title="ã‚¯ãƒªãƒƒã‚¯ã§æ‰‹å‹•åŒæœŸ">
                    <span id="syncIcon">â˜ï¸</span>
                    <span id="syncText">æ¥ç¶šä¸­...</span>
                </div>
                <div class="month-selector">
                    <button onclick="changeMonth(-1)">â—€</button>
                    <span id="currentMonth">2026å¹´1æœˆ</span>
                    <button onclick="changeMonth(1)">â–¶</button>
                </div>
            </div>
        </header>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
            <div class="tab" onclick="switchTab('input')">âœï¸ å‹¤å‹™å…¥åŠ›</div>
            <div class="tab" onclick="switchTab('expense')">ğŸ’° çµŒè²»å…¥åŠ›</div>
            <div class="tab" onclick="switchTab('events')">ğŸ“… ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆ</div>
            <div class="tab" onclick="switchTab('hotels')">ğŸ¨ å®¿æ³Šå±¥æ­´</div>
            <div class="tab" onclick="switchTab('annual')">ğŸ“ˆ å¹´é–“ã‚µãƒãƒªãƒ¼</div>
            <div class="tab" onclick="switchTab('settings')">âš™ï¸ è¨­å®š</div>
        </div>
        <div id="dashboard" class="panel active">
            <div class="summary-grid">
                <div class="summary-card blue">
                    <div class="label">å‹¤å‹™æ—¥æ•°</div>
                    <div class="value"><span id="sumWorkDays">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card green">
                    <div class="label">åœ¨å®…å‹¤å‹™</div>
                    <div class="value"><span id="sumRemote">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card blue">
                    <div class="label">å‡ºç¤¾</div>
                    <div class="value"><span id="sumOffice">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card orange">
                    <div class="label">å‡ºå¼µ</div>
                    <div class="value"><span id="sumTrip">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card purple">
                    <div class="label">æœ‰çµ¦</div>
                    <div class="value"><span id="sumPaidLeave">0</span><span class="unit">æ—¥</span></div>
                </div>
                <div class="summary-card red">
                    <div class="label">å€‹äººç«‹æ›¿ åˆè¨ˆ</div>
                    <div class="value">Â¥<span id="sumPersonal">0</span></div>
                </div>
            </div>
            
            <!-- æ³•äººã‚«ãƒ¼ãƒ‰ç· ã‚æœŸé–“åˆ¥è¡¨ç¤º -->
            <div class="corporate-card-section">
                <div class="corporate-card-header">
                    <button class="period-nav-btn" onclick="changeCorporatePeriod(-1)">â—€</button>
                    <div class="period-info">
                        <div class="period-label">ğŸ’³ æ³•äººã‚«ãƒ¼ãƒ‰</div>
                        <div class="period-range" id="corporatePeriodRange">1/16 ã€œ 2/15</div>
                    </div>
                    <button class="period-nav-btn" onclick="changeCorporatePeriod(1)">â–¶</button>
                </div>
                <div class="corporate-card-amount">
                    <span class="amount-value">Â¥<span id="sumCorporatePeriod">0</span></span>
                    <span class="amount-count">ï¼ˆ<span id="sumCorporateCount">0</span>ä»¶ï¼‰</span>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item"><span class="legend-color office"></span>å‡ºç¤¾</div>
                <div class="legend-item"><span class="legend-color remote"></span>åœ¨å®…</div>
                <div class="legend-item"><span class="legend-color trip"></span>å‡ºå¼µ</div>
                <div class="legend-item"><span class="legend-color paid-leave"></span>æœ‰çµ¦</div>
                <div class="legend-item"><span style="color: #60a5fa;">â– </span> åœŸæ›œ</div>
                <div class="legend-item"><span style="color: #f87171;">â– </span> æ—¥æ›œãƒ»ç¥æ—¥</div>
            </div>
            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">
                ğŸ’¡ ãƒ‰ãƒ©ãƒƒã‚°ã§ç§»å‹• ï½œ Alt(Option)ï¼‹ãƒ‰ãƒ©ãƒƒã‚°ã§ã‚³ãƒ”ãƒ¼ ï½œ å³ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            </div>
            <div class="calendar">
                <div class="calendar-header">
                    <span>æ—¥</span><span>æœˆ</span><span>ç«</span><span>æ°´</span><span>æœ¨</span><span>é‡‘</span><span>åœŸ</span>
                </div>
                <div id="calendarGrid" class="calendar-grid"></div>
            </div>
            <div class="form-section">
                <h2>ğŸ“ çµŒè²»æ˜ç´°</h2>
                
                <!-- ç· ã‚æœŸé–“åˆ‡ã‚Šæ›¿ãˆ -->
                <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="expenseViewType" onchange="renderExpenseTable()" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="personal">å€‹äººç«‹æ›¿ï¼ˆå½“æœˆ1æ—¥ã€œæœ«æ—¥ï¼‰</option>
                            <option value="corporate">æ³•äººã‚«ãƒ¼ãƒ‰ï¼ˆ16æ—¥ã€œç¿Œ15æ—¥ï¼‰</option>
                        </select>
                    </div>
                    <div id="expensePeriodLabel" style="font-size: 0.85rem; color: var(--text-secondary);"></div>
                </div>
                
                <!-- ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn btn-secondary" onclick="selectAllExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨é¸æŠ</button>
                    <button class="btn btn-secondary" onclick="deselectAllExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠè§£é™¤</button>
                    <button class="btn btn-danger" onclick="deleteSelectedExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠå‰Šé™¤</button>
                    <button class="btn btn-danger" onclick="deleteAllDisplayedExpenses()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨å‰Šé™¤</button>
                </div>
                
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="expenseSelectAll" onchange="toggleAllExpenseCheckboxes(this)"></th>
                            <th class="sortable" onclick="sortExpenseTable('category')">ç¨®åˆ¥</th>
                            <th class="sortable" onclick="sortExpenseTable('date')">æ—¥ä»˜</th>
                            <th class="sortable" onclick="sortExpenseTable('desc')">å†…å®¹</th>
                            <th class="sortable amount" onclick="sortExpenseTable('amount')">é‡‘é¡</th>
                            <th class="sortable" onclick="sortExpenseTable('paymentType')">æ”¯æ‰•</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                    </tbody>
                </table>
                <div id="expenseSummary" style="margin-top: 12px; text-align: right; font-size: 0.9rem;"></div>
            </div>
        </div>
        <div id="input" class="panel">
            <div class="form-section">
                <h2>ğŸ“¥ å‡ºå¼µäºˆå®šã®å–ã‚Šè¾¼ã¿</h2>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 12px;">
                    ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ã€Œå‡ºå¼µãƒã‚¹ã‚¿ã€ã¨ã€Œå–¶æ¥­æ‰€ãƒã‚¹ã‚¿ã€ã‚’è²¼ã‚Šä»˜ã‘ã¦ã€ä¸€æ‹¬ç™»éŒ²ã—ã¾ã™ã€‚<br>
                    <strong>å¯¾å¿œå½¢å¼: ã€ŒID | æ—¥ä»˜ | çµ‚äº†æ—¥ | å–¶æ¥­æ‰€IDã€ã¾ãŸã¯ã€Œæ—¥ä»˜ | çµ‚äº†æ—¥ | å–¶æ¥­æ‰€IDã€</strong>
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label>1. äºˆå®šãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                        <textarea id="tripScheduleData" rows="4" placeholder="2025/12/22	2025/12/22	5 ..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>2. å–¶æ¥­æ‰€ãƒã‚¹ã‚¿è²¼ã‚Šä»˜ã‘ (ID | å–¶æ¥­æ‰€å)</label>
                        <textarea id="officeMasterData" rows="4" placeholder="1	æœ­å¹Œå–¶æ¥­æ‰€ ..."></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="btn btn-primary" onclick="importTripSchedule()">åæ˜ </button>
                    <span id="tripImportResult" style="font-size: 0.85rem;"></span>
                </div>
            </div>

            <div class="form-section">
                <h2>ğŸ“… 1ä»¶ç™»éŒ²</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="workDate">
                    </div>
                    <div class="form-group">
                        <label>å‹¤å‹™ã‚¿ã‚¤ãƒ—</label>
                        <select id="workType">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                            <option value="remote">åœ¨å®…</option>
                            <option value="trip">å‡ºå¼µ</option>
                            <option value="paid-leave">æœ‰çµ¦</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="tripDestGroup" style="display: none;">
                    <label>å‡ºå¼µå…ˆ</label>
                    <input type="text" id="tripDest" placeholder="ä¾‹:ä»™å°">
                </div>
                <button class="btn btn-primary" onclick="saveWorkDay()">ç™»éŒ²</button>
            </div>
        </div>
        <div id="expense" class="panel">
            <div class="form-section">
                <h2>ğŸ“‹ ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿(ã‚³ãƒ”ãƒš)</h2>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                    ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
                    æœªåŠ å·¥ãƒ‡ãƒ¼ã‚¿ï¼ˆè²»ç›®ã€å†…å®¹ãƒ»åŒºé–“ãªã©ï¼‰ã‚‚è‡ªå‹•ã§å¤‰æ›ã•ã‚Œã¾ã™ã€‚
                </p>
                <div class="form-group">
                    <label>ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                    <textarea id="importData" rows="8" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘..." style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 12px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; align-items: center; margin-top: 12px;">
                    <button class="btn btn-primary" onclick="importFromClipboard()">å–ã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
                    <span id="importResult" style="font-size: 0.85rem; color: var(--text-secondary);"></span>
                </div>
                <div id="importPreview" style="margin-top: 16px; display: none;">
                    <h4 style="font-size: 0.9rem; margin-bottom: 8px;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼(æœ€åˆã®5ä»¶)</h4>
                    <div id="importPreviewContent" style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; font-size: 0.8rem; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="form-section">
                <h2>âœï¸ æ‰‹å‹•å…¥åŠ›</h2>
                <details style="cursor: pointer;">
                    <summary style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">æ‰‹å‹•ã§1ä»¶ãšã¤å…¥åŠ›ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰</summary>
                    
                    <div style="margin-top: 16px;">
                        <h3 style="font-size: 0.95rem; margin-bottom: 12px;">ğŸšƒ äº¤é€šè²»</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="date" id="transDate">
                            </div>
                            <div class="form-group">
                                <label>ãƒ«ãƒ¼ãƒˆ</label>
                                <input type="text" id="transRoute" placeholder="ä¾‹:çŸ³å²¡ â†’ æ±äº¬(ç‰¹æ€¥)">
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¡</label>
                                <input type="number" id="transAmount" placeholder="ä¾‹:2540">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveTransport()">ç™»éŒ²</button>
                        <div class="history-list" id="transHistory"></div>
                    </div>
                    <div style="margin-top: 24px;">
                        <h3 style="font-size: 0.95rem; margin-bottom: 12px;">ğŸ¨ å®¿æ³Šè²»</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="date" id="hotelDate">
                            </div>
                            <div class="form-group">
                                <label>å®¿æ³Šå…ˆ</label>
                                <input type="text" id="hotelName" placeholder="ä¾‹:ä»™å°é§…å‰ãƒ›ãƒ†ãƒ«">
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¡</label>
                                <input type="number" id="hotelAmount" placeholder="ä¾‹:12000">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveHotel()">ç™»éŒ²</button>
                        <div class="history-list" id="hotelHistory"></div>
                    </div>
                    <div style="margin-top: 24px;">
                        <h3 style="font-size: 0.95rem; margin-bottom: 12px;">ğŸ’¼ å‡ºå¼µæ‰‹å½“</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>æ—¥ä»˜</label>
                                <input type="date" id="allowanceDate">
                            </div>
                            <div class="form-group">
                                <label>é‡‘é¡(ä¸€å¾‹)</label>
                                <input type="number" id="allowanceAmount" value="3000" readonly>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveAllowance()">ç™»éŒ²</button>
                    </div>
                </details>
            </div>
        </div>
        </div>

        <!-- å¹´é–“ã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ« -->
        <div id="annual" class="panel">
            <div class="form-section">
                <h2>ğŸ“ˆ å¹´é–“ã‚µãƒãƒªãƒ¼</h2>
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="changeAnnualYear(-1)">â—€</button>
                    <span id="annualYear" style="font-size: 1.2rem; font-weight: 600;">2026å¹´</span>
                    <button class="btn btn-secondary" onclick="changeAnnualYear(1)">â–¶</button>
                </div>
                
                <!-- å¹´é–“é›†è¨ˆã‚«ãƒ¼ãƒ‰ -->
                <div class="summary-grid" style="margin-bottom: 24px;">
                    <div class="summary-card blue">
                        <div class="label">å¹´é–“å‹¤å‹™æ—¥æ•°</div>
                        <div class="value"><span id="annualWorkDays">0</span><span class="unit">æ—¥</span></div>
                    </div>
                    <div class="summary-card orange">
                        <div class="label">å¹´é–“å‡ºå¼µæ—¥æ•°</div>
                        <div class="value"><span id="annualTripDays">0</span><span class="unit">æ—¥</span></div>
                    </div>
                    <div class="summary-card purple">
                        <div class="label">æœ‰çµ¦æ¶ˆåŒ–</div>
                        <div class="value"><span id="annualPaidLeave">0</span><span class="unit">æ—¥</span></div>
                    </div>
                    <div class="summary-card red">
                        <div class="label">å¹´é–“çµŒè²»åˆè¨ˆ</div>
                        <div class="value">Â¥<span id="annualExpense">0</span></div>
                    </div>
                </div>
                
                <!-- æœˆåˆ¥å‹¤å‹™ã‚°ãƒ©ãƒ• -->
                <h3 style="font-size: 0.95rem; margin-bottom: 12px;">ğŸ“Š æœˆåˆ¥å‹¤å‹™æ—¥æ•°</h3>
                <div id="monthlyWorkChart" class="chart-container"></div>
                
                <!-- æœˆåˆ¥çµŒè²»ã‚°ãƒ©ãƒ• -->
                <h3 style="font-size: 0.95rem; margin: 24px 0 12px;">ğŸ’° æœˆåˆ¥çµŒè²»</h3>
                <div id="monthlyExpenseChart" class="chart-container"></div>
                
                <!-- çµŒè²»ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚°ãƒ©ãƒ• -->
                <h3 style="font-size: 0.95rem; margin: 24px 0 12px;">ğŸ“¦ çµŒè²»ã‚«ãƒ†ã‚´ãƒªåˆ¥å†…è¨³</h3>
                <div id="categoryChart" class="chart-container" style="display: flex; gap: 24px; flex-wrap: wrap;">
                    <div id="categoryPieChart" style="flex: 1; min-width: 200px;"></div>
                    <div id="categoryLegend" style="flex: 1; min-width: 200px;"></div>
                </div>
                
                <!-- å‡ºå¼µå…ˆãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                <h3 style="font-size: 0.95rem; margin: 24px 0 12px;">ğŸ† å‡ºå¼µå…ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div id="tripRanking"></div>
            </div>
        </div>

        <!-- è¨­å®šãƒ‘ãƒãƒ« -->
        <div id="settings" class="panel">
            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ -->
            <div class="form-section">
                <h2>ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½</h2>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                    ã‚ˆãä½¿ã†å‹¤å‹™ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¿å­˜ã—ã¦ã€ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§ç™»éŒ²ã§ãã¾ã™ã€‚
                </p>
                
                <details>
                    <summary style="cursor: pointer; color: var(--accent-blue); font-size: 0.9rem; margin-bottom: 12px;">ï¼‹ æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ</summary>
                    <div style="margin-top: 12px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div class="form-group">
                            <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå</label>
                            <input type="text" id="templateName" placeholder="ä¾‹ï¼šä»™å°å‡ºå¼µ2æ³Š3æ—¥">
                        </div>
                        <div class="form-group">
                            <label>æ—¥æ•°</label>
                            <input type="number" id="templateDays" value="1" min="1" max="14" style="width: 80px;">
                        </div>
                        <div id="templateDayInputs"></div>
                        <button class="btn btn-secondary" onclick="generateTemplateDayInputs()" style="margin: 12px 0;">å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ</button>
                        <button class="btn btn-primary" onclick="saveTemplate()">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜</button>
                    </div>
                </details>
                
                <h3 style="font-size: 0.9rem; margin: 20px 0 12px;">ä¿å­˜æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h3>
                <div id="templateList"></div>
            </div>

            <!-- å®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
            <div class="form-section">
                <h2>ğŸ” å®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™»éŒ²</h2>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 16px;">
                    ã€Œæ¯é€±æ°´æ›œã¯åœ¨å®…ã€ãªã©ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™ã€‚
                </p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>æ›œæ—¥</label>
                        <select id="recurringDayOfWeek">
                            <option value="1">æ¯é€± æœˆæ›œ</option>
                            <option value="2">æ¯é€± ç«æ›œ</option>
                            <option value="3">æ¯é€± æ°´æ›œ</option>
                            <option value="4">æ¯é€± æœ¨æ›œ</option>
                            <option value="5">æ¯é€± é‡‘æ›œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å‹¤å‹™ã‚¿ã‚¤ãƒ—</label>
                        <select id="recurringWorkType">
                            <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                            <option value="remote">åœ¨å®…</option>
                            <option value="trip">å‡ºå¼µ</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="recurringTripDestGroup" style="display: none;">
                    <label>å‡ºå¼µå…ˆ</label>
                    <input type="text" id="recurringTripDest" placeholder="ä¾‹ï¼šåŸ¼ç‰æ”¯åº—">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥</label>
                        <input type="date" id="recurringStartDate">
                    </div>
                    <div class="form-group">
                        <label>çµ‚äº†æ—¥</label>
                        <input type="date" id="recurringEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="recurringSkipHolidays" checked style="width: 18px; height: 18px;">
                        ç¥æ—¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
                    </label>
                </div>
                <button class="btn btn-primary" onclick="applyRecurringSchedule()">ä¸€æ‹¬ç™»éŒ²</button>
            </div>
            
            <!-- å‰ä¹—ã‚Šåˆ¤æ–­ï¼ˆç§»å‹•ï¼‰ -->
            <div class="form-section">
                <h2>ğŸ¤” å‰ä¹—ã‚Šåˆ¤æ–­ãƒ•ãƒ­ãƒ¼</h2>
                <div class="flow-card" style="background: transparent; border: none; padding: 0;">
                    <div id="flowStep1" class="flow-step">
                        <div class="flow-question">Q1. å‡ºå¼µå…ˆã¯ã©ã“?</div>
                        <div class="flow-options">
                            <div class="flow-option" onclick="selectFlow(1, 'tohoku')">æ±åŒ—(ä»™å°ãªã©)</div>
                            <div class="flow-option" onclick="selectFlow(1, 'other')">ãã®ä»–</div>
                        </div>
                    </div>
                    <div id="flowStep2" class="flow-step" style="display: none; margin-top: 24px;">
                        <div class="flow-question">Q2. æ™‚æœŸã¯?</div>
                        <div class="flow-options">
                            <div class="flow-option" onclick="selectFlow(2, 'winter')">å†¬å­£(1ã€œ2æœˆ)</div>
                            <div class="flow-option" onclick="selectFlow(2, 'other')">ãã‚Œä»¥å¤–</div>
                        </div>
                    </div>
                    <div id="flowStep3" class="flow-step" style="display: none; margin-top: 24px;">
                        <div class="flow-question">Q3. ãã®é€±ã®å‡ºç¤¾å›æ•°ã¯?</div>
                        <div class="flow-options">
                            <div class="flow-option" onclick="selectFlow(3, '2plus')">2å›ä»¥ä¸Š</div>
                            <div class="flow-option" onclick="selectFlow(3, '1')">1å›</div>
                            <div class="flow-option" onclick="selectFlow(3, '0')">0å›</div>
                        </div>
                    </div>
                    <div id="flowResult" style="display: none;"></div>
                    <button class="btn btn-secondary" onclick="resetFlow()" style="margin-top: 20px;">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
            
            <!-- ã‚³ã‚¹ãƒˆæ¯”è¼ƒ -->
            <div class="form-section">
                <h2>ğŸ’° ã‚³ã‚¹ãƒˆæ¯”è¼ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>çŸ³å²¡â‡”æ±äº¬(ç‰¹æ€¥ãƒ»ç‰‡é“)</label>
                        <input type="number" id="costTokyo" value="2540">
                    </div>
                    <div class="form-group">
                        <label>å®¿æ³Šè²»(1æ³Š)</label>
                        <input type="number" id="costHotel" value="12000">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="calcCostCompare()">è¨ˆç®—</button>
                <div class="cost-compare" id="costCompareResult" style="display: none;">
                    <div class="cost-box">
                        <h4>æ¡ˆ1 å½“æ—¥ç§»å‹•</h4>
                        <div class="total" id="cost1Total">Â¥0</div>
                        <div class="breakdown" id="cost1Breakdown"></div>
                    </div>
                    <div class="cost-box">
                        <h4>æ¡ˆ2 å‰ä¹—ã‚Š</h4>
                        <div class="total" id="cost2Total">Â¥0</div>
                        <div class="breakdown" id="cost2Breakdown"></div>
                    </div>
                </div>
                <div class="cost-diff" id="costDiff" style="display: none;">
                    <div class="label">å·®é¡(å‰ä¹—ã‚Šã®è¿½åŠ ã‚³ã‚¹ãƒˆ)</div>
                    <div class="value" id="costDiffValue">+Â¥0</div>
                </div>
            </div>
        </div>

        <!-- ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ãƒãƒ« -->
        <div id="events" class="panel">
            <div class="form-section">
                <h2>ğŸ“… ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="eventDate">
                    </div>
                    <div class="form-group">
                        <label>ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥</label>
                        <select id="eventType">
                            <option value="meeting">ä¼šè­°</option>
                            <option value="training">ç ”ä¿®</option>
                            <option value="ceremony">å¼å…¸</option>
                            <option value="party">æ‡‡è¦ªä¼š</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                        <input type="text" id="eventName" placeholder="ä¾‹ï¼šã‚­ãƒƒã‚¯ã‚ªãƒ•ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å ´æ‰€</label>
                        <input type="text" id="eventLocation" placeholder="ä¾‹ï¼šæœ¬ç¤¾ä¼šè­°å®¤">
                    </div>
                    <div class="form-group">
                        <label>ãƒ¡ãƒ¢</label>
                        <input type="text" id="eventMemo" placeholder="ä¾‹ï¼šè³‡æ–™æŒå‚">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveEvent()">ç™»éŒ²</button>
            </div>

            <div class="form-section">
                <h2>ğŸ“‹ ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</h2>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="btn btn-secondary" onclick="selectAllEvents()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨é¸æŠ</button>
                    <button class="btn btn-secondary" onclick="deselectAllEvents()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠè§£é™¤</button>
                    <button class="btn btn-danger" onclick="deleteSelectedEvents()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠå‰Šé™¤</button>
                </div>
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="eventSelectAll" onchange="toggleAllEventCheckboxes(this)"></th>
                            <th class="sortable" onclick="sortEventTable('date')">æ—¥ä»˜</th>
                            <th class="sortable" onclick="sortEventTable('type')">ç¨®åˆ¥</th>
                            <th class="sortable" onclick="sortEventTable('name')">ã‚¤ãƒ™ãƒ³ãƒˆå</th>
                            <th class="sortable" onclick="sortEventTable('location')">å ´æ‰€</th>
                            <th>ãƒ¡ãƒ¢</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="eventTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- å®¿æ³Šå±¥æ­´ãƒ‘ãƒãƒ« -->
        <div id="hotels" class="panel">
            <div class="form-section">
                <h2>ğŸ“‹ éå»ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬å–ã‚Šè¾¼ã¿</h2>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">
                    ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã€Œæ—¥ä»˜ï¼‹ãƒ›ãƒ†ãƒ«åã€å½¢å¼ã§ã‚³ãƒ”ãƒšã—ã¦ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™ã€‚<br>
                    ä¾‹: <code>2024/6/10(æœˆ)	æ±æ¨ªINNæ¨ªæµœå¸‚å–¶åœ°ä¸‹é‰„ã‚»ãƒ³ã‚¿ãƒ¼å—é§…</code>
                </p>
                <div class="form-group">
                    <label>ãƒ‡ãƒ¼ã‚¿è²¼ã‚Šä»˜ã‘</label>
                    <textarea id="hotelImportData" rows="6" placeholder="ã“ã“ã«ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘..." style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="btn btn-primary" onclick="importHotelHistory()">å–ã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
                    <span id="hotelImportResult" style="font-size: 0.85rem;"></span>
                </div>
            </div>

            <div class="form-section">
                <h2>ğŸ¨ å®¿æ³Šå±¥æ­´ç™»éŒ²ï¼ˆæ‰‹å‹•ï¼‰</h2>
                <details>
                    <summary style="cursor: pointer; color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 12px;">æ‰‹å‹•ã§1ä»¶ãšã¤ç™»éŒ²ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰</summary>
                    <div style="margin-top: 16px;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥</label>
                                <input type="date" id="hotelCheckin">
                            </div>
                            <div class="form-group">
                                <label>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥</label>
                                <input type="date" id="hotelCheckout">
                            </div>
                            <div class="form-group">
                                <label>ãƒ›ãƒ†ãƒ«å</label>
                                <input type="text" id="hotelNameInput" placeholder="ä¾‹ï¼šæ±æ¨ªINN ä»™å°é§…å‰">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ã‚¨ãƒªã‚¢</label>
                                <input type="text" id="hotelArea" placeholder="ä¾‹ï¼šä»™å°">
                            </div>
                            <div class="form-group">
                                <label>æ–™é‡‘</label>
                                <input type="number" id="hotelPrice" placeholder="ä¾‹ï¼š8500">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>ã‚¢ã‚¯ã‚»ã‚¹</label>
                                <select id="hotelAccess">
                                    <option value="">æœªè©•ä¾¡</option>
                                    <option value="5">5 - æœ€é«˜</option>
                                    <option value="4">4 - è‰¯ã„</option>
                                    <option value="3">3 - æ™®é€š</option>
                                    <option value="2">2 - ã„ã¾ã„ã¡</option>
                                    <option value="1">1 - æ‚ªã„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>éƒ¨å±‹</label>
                                <select id="hotelRoom">
                                    <option value="">æœªè©•ä¾¡</option>
                                    <option value="5">5 - æœ€é«˜</option>
                                    <option value="4">4 - è‰¯ã„</option>
                                    <option value="3">3 - æ™®é€š</option>
                                    <option value="2">2 - ã„ã¾ã„ã¡</option>
                                    <option value="1">1 - æ‚ªã„</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>é£Ÿäº‹</label>
                                <select id="hotelFood">
                                    <option value="">æœªè©•ä¾¡</option>
                                    <option value="5">5 - æœ€é«˜</option>
                                    <option value="4">4 - è‰¯ã„</option>
                                    <option value="3">3 - æ™®é€š</option>
                                    <option value="2">2 - ã„ã¾ã„ã¡</option>
                                    <option value="1">1 - æ‚ªã„</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>ãƒ¡ãƒ¢ï¼ˆè‰¯ã‹ã£ãŸç‚¹ãƒ»æ‚ªã‹ã£ãŸç‚¹ãªã©ï¼‰</label>
                            <textarea id="hotelMemo" rows="2" placeholder="ä¾‹ï¼šæœé£ŸãŒç¾å‘³ã—ã„ã€é§…ã‹ã‚‰è¿‘ã„" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveHotelHistory()">ç™»éŒ²</button>
                    </div>
                </details>
                <div class="history-list" id="hotelHistoryQuick" style="margin-top: 12px;"></div>
            </div>

            <div class="form-section">
                <h2>ğŸ“‹ å®¿æ³Šå±¥æ­´ä¸€è¦§</h2>
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <select id="hotelFilterArea" onchange="renderHotelTable()" style="padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);">
                            <option value="">å…¨ã‚¨ãƒªã‚¢</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="selectAllHotels()" style="font-size: 0.8rem; padding: 6px 12px;">å…¨é¸æŠ</button>
                    <button class="btn btn-secondary" onclick="deselectAllHotels()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠè§£é™¤</button>
                    <button class="btn btn-danger" onclick="deleteSelectedHotels()" style="font-size: 0.8rem; padding: 6px 12px;">é¸æŠå‰Šé™¤</button>
                </div>
                <table class="expense-table">
                    <thead>
                        <tr>
                            <th style="width: 30px;"><input type="checkbox" id="hotelSelectAll" onchange="toggleAllHotelCheckboxes(this)"></th>
                            <th class="sortable" onclick="sortHotelTable('checkin')">æ—¥ä»˜</th>
                            <th class="sortable" onclick="sortHotelTable('name')">ãƒ›ãƒ†ãƒ«å</th>
                            <th class="sortable" onclick="sortHotelTable('area')">ã‚¨ãƒªã‚¢</th>
                            <th class="sortable" onclick="sortHotelTable('nights')">æ³Šæ•°</th>
                            <th class="sortable amount" onclick="sortHotelTable('price')">é‡‘é¡</th>
                            <th class="sortable" onclick="sortHotelTable('rating')">è©•ä¾¡</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="hotelTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="dayModal">
        <div class="modal">
            <h2 id="modalTitle">1æœˆ1æ—¥ã®ç·¨é›†</h2>
            
            <!-- ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ / è©³ç´°ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ -->
            <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem;">
                    <input type="checkbox" id="modalDetailMode" onchange="toggleModalDetailMode()" style="width: 18px; height: 18px;">
                    åˆå‰/åˆå¾Œã‚’åˆ¥ã€…ã«è¨­å®šã™ã‚‹
                </label>
            </div>
            
            <!-- ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¾“æ¥é€šã‚Šï¼‰ -->
            <div id="modalSimpleMode">
                <div class="form-group">
                    <label>å‹¤å‹™ã‚¿ã‚¤ãƒ—</label>
                    <select id="modalWorkType">
                        <option value="">æœªè¨­å®š</option>
                        <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                        <option value="remote">åœ¨å®…</option>
                        <option value="trip">å‡ºå¼µ</option>
                        <option value="paid-leave">æœ‰çµ¦ï¼ˆå…¨ä¼‘ï¼‰</option>
                        <option value="paid-leave-am">æœ‰çµ¦ï¼ˆAMä¼‘ï¼‰</option>
                        <option value="paid-leave-pm">æœ‰çµ¦ï¼ˆPMä¼‘ï¼‰</option>
                        <option value="paid-leave-hour">æœ‰çµ¦ï¼ˆæ™‚é–“ä¼‘ï¼‰</option>
                    </select>
                </div>
                <div class="form-group" id="modalTripDestGroup" style="display: none;">
                    <label>å‡ºå¼µå…ˆ</label>
                    <input type="text" id="modalTripDest" placeholder="ä¾‹:ä»™å°">
                </div>
                <div class="form-group" id="modalHourLeaveGroup" style="display: none;">
                    <label>æ™‚é–“ä¼‘ã®æ™‚é–“æ•°</label>
                    <input type="number" id="modalHourLeave" placeholder="ä¾‹:2" min="1" max="7" style="width: 80px;"> æ™‚é–“
                </div>
            </div>
            
            <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆå‰/åˆå¾Œåˆ¥ï¼‰ -->
            <div id="modalDetailModeSection" style="display: none;">
                <div class="form-group">
                    <label>ğŸŒ… åˆå‰</label>
                    <select id="modalAmType">
                        <option value="">æœªè¨­å®š</option>
                        <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                        <option value="remote">åœ¨å®…</option>
                        <option value="trip">å‡ºå¼µ</option>
                        <option value="paid-leave-am">æœ‰çµ¦ï¼ˆAMä¼‘ï¼‰</option>
                    </select>
                </div>
                <div class="form-group" id="modalAmTripDestGroup" style="display: none;">
                    <label>åˆå‰ã®å‡ºå¼µå…ˆ</label>
                    <input type="text" id="modalAmTripDest" placeholder="ä¾‹:åŸ¼ç‰æ”¯åº—">
                </div>
                
                <div class="form-group" style="margin-top: 16px;">
                    <label>ğŸŒ‡ åˆå¾Œ</label>
                    <select id="modalPmType">
                        <option value="">æœªè¨­å®š</option>
                        <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                        <option value="remote">åœ¨å®…</option>
                        <option value="trip">å‡ºå¼µ</option>
                        <option value="paid-leave-pm">æœ‰çµ¦ï¼ˆPMä¼‘ï¼‰</option>
                    </select>
                </div>
                <div class="form-group" id="modalPmTripDestGroup" style="display: none;">
                    <label>åˆå¾Œã®å‡ºå¼µå…ˆ</label>
                    <input type="text" id="modalPmTripDest" placeholder="ä¾‹:æ±äº¬æ”¯åº—">
                </div>
            </div>
            
            <!-- ã‚³ãƒ”ãƒ¼ãƒ»è¤‡è£½æ©Ÿèƒ½ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰ -->
            <div id="modalCopySection" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 12px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼ãƒ»è¤‡è£½</div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="copyToNextDay()" style="font-size: 0.8rem; padding: 8px 12px;">
                        â¡ï¸ ç¿Œæ—¥ã«ã‚³ãƒ”ãƒ¼
                    </button>
                    <button class="btn btn-secondary" onclick="copyToPrevDay()" style="font-size: 0.8rem; padding: 8px 12px;">
                        â¬…ï¸ å‰æ—¥ã«ã‚³ãƒ”ãƒ¼
                    </button>
                    <button class="btn btn-secondary" onclick="openCopyToDateModal()" style="font-size: 0.8rem; padding: 8px 12px;">
                        ğŸ“… æ—¥ä»˜ã‚’æŒ‡å®š
                    </button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" onclick="deleteWorkDay()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="saveModalWorkDay()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ—¥ä»˜æŒ‡å®šã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="copyToDateModal">
        <div class="modal" style="max-width: 400px;">
            <h2>ğŸ“… æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ã‚³ãƒ”ãƒ¼</h2>
            <div class="form-group">
                <label>ã‚³ãƒ”ãƒ¼å…ˆã®æ—¥ä»˜</label>
                <input type="date" id="copyTargetDate">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="copyMultipleDays" onchange="toggleCopyEndDate()" style="width: 18px; height: 18px;">
                    è¤‡æ•°æ—¥ã«ã‚³ãƒ”ãƒ¼
                </label>
            </div>
            <div class="form-group" id="copyEndDateGroup" style="display: none;">
                <label>çµ‚äº†æ—¥</label>
                <input type="date" id="copyEndDate">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeCopyToDateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="executeCopyToDate()">ã‚³ãƒ”ãƒ¼å®Ÿè¡Œ</button>
            </div>
        </div>
    </div>
    
    <!-- å®¿æ³Šå±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="hotelDetailModal">
        <div class="modal" style="max-width: 600px;">
            <h2>ğŸ¨ å®¿æ³Šå±¥æ­´è©³ç´°</h2>
            <input type="hidden" id="hotelDetailIndex">
            <div class="form-row">
                <div class="form-group">
                    <label>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥</label>
                    <input type="date" id="hotelDetailCheckin">
                </div>
                <div class="form-group">
                    <label>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥</label>
                    <input type="date" id="hotelDetailCheckout">
                </div>
            </div>
            <div class="form-group">
                <label>ãƒ›ãƒ†ãƒ«å</label>
                <input type="text" id="hotelDetailName">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ã‚¨ãƒªã‚¢</label>
                    <input type="text" id="hotelDetailArea">
                </div>
                <div class="form-group">
                    <label>æ–™é‡‘</label>
                    <input type="number" id="hotelDetailPrice">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>ã‚¢ã‚¯ã‚»ã‚¹</label>
                    <select id="hotelDetailAccess">
                        <option value="">æœªè©•ä¾¡</option>
                        <option value="5">5 - æœ€é«˜</option>
                        <option value="4">4 - è‰¯ã„</option>
                        <option value="3">3 - æ™®é€š</option>
                        <option value="2">2 - ã„ã¾ã„ã¡</option>
                        <option value="1">1 - æ‚ªã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>éƒ¨å±‹</label>
                    <select id="hotelDetailRoom">
                        <option value="">æœªè©•ä¾¡</option>
                        <option value="5">5 - æœ€é«˜</option>
                        <option value="4">4 - è‰¯ã„</option>
                        <option value="3">3 - æ™®é€š</option>
                        <option value="2">2 - ã„ã¾ã„ã¡</option>
                        <option value="1">1 - æ‚ªã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é£Ÿäº‹</label>
                    <select id="hotelDetailFood">
                        <option value="">æœªè©•ä¾¡</option>
                        <option value="5">5 - æœ€é«˜</option>
                        <option value="4">4 - è‰¯ã„</option>
                        <option value="3">3 - æ™®é€š</option>
                        <option value="2">2 - ã„ã¾ã„ã¡</option>
                        <option value="1">1 - æ‚ªã„</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ãƒ¡ãƒ¢</label>
                <textarea id="hotelDetailMemo" rows="3" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeHotelDetailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-secondary" onclick="duplicateHotelStay()">ğŸ“‹ è¤‡è£½</button>
                <button class="btn btn-danger" onclick="deleteHotelStayFromModal()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="saveHotelDetail()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-overlay" id="eventDetailModal">
        <div class="modal" style="max-width: 500px;">
            <h2>ğŸ“… ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°</h2>
            <input type="hidden" id="eventDetailIndex">
            <div class="form-row">
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="eventDetailDate">
                </div>
                <div class="form-group">
                    <label>ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥</label>
                    <select id="eventDetailType">
                        <option value="meeting">ä¼šè­°</option>
                        <option value="training">ç ”ä¿®</option>
                        <option value="ceremony">å¼å…¸</option>
                        <option value="party">æ‡‡è¦ªä¼š</option>
                        <option value="other">ãã®ä»–</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                <input type="text" id="eventDetailName">
            </div>
            <div class="form-group">
                <label>å ´æ‰€</label>
                <input type="text" id="eventDetailLocation">
            </div>
            <div class="form-group">
                <label>ãƒ¡ãƒ¢</label>
                <textarea id="eventDetailMemo" rows="3" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEventDetailModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-secondary" onclick="duplicateEventFromModal()">ğŸ“‹ è¤‡è£½</button>
                <button class="btn btn-danger" onclick="deleteEventFromModal()">å‰Šé™¤</button>
                <button class="btn btn-primary" onclick="saveEventDetail()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="copyToNextDay()">
            ğŸ“‹ ç¿Œæ—¥ã«ã‚³ãƒ”ãƒ¼
        </div>
        <div class="context-menu-item" onclick="copyToNextWeek()">
            ğŸ“… ç¿Œé€±ã«ã‚³ãƒ”ãƒ¼
        </div>
        <div class="context-menu-item" onclick="copyToMultipleDays()">
            ğŸ“† è¤‡æ•°æ—¥ã«ã‚³ãƒ”ãƒ¼...
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="editFromContextMenu()">
            âœï¸ ç·¨é›†
        </div>
        <div class="context-menu-item" onclick="deleteFromContextMenu()">
            ğŸ—‘ï¸ å‰Šé™¤
        </div>
    </div>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        let currentYear = 2026;
        let currentMonth = 1;
        let selectedDate = null;
        let draggedDate = null;
        let contextMenuDate = null;
        let isCopyMode = false;
        
        // ã‚½ãƒ¼ãƒˆçŠ¶æ…‹
        let sortState = {
            expense: { key: 'date', order: 'asc' },
            event: { key: 'date', order: 'asc' },
            hotel: { key: 'checkin', order: 'desc' }
        };
        
        // æ³•äººã‚«ãƒ¼ãƒ‰ç· ã‚æœŸé–“ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆ0=ä»Šæœˆ16æ—¥ã€œç¿Œæœˆ15æ—¥ï¼‰
        let corporatePeriodOffset = 0;
        
        // 2025å¹´ã®ç¥æ—¥ãƒ‡ãƒ¼ã‚¿
        const holidays2025 = {
            '2025-01-01': 'å…ƒæ—¥',
            '2025-01-13': 'æˆäººã®æ—¥',
            '2025-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2025-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2025-02-24': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2025-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2025-04-29': 'æ˜­å’Œã®æ—¥',
            '2025-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2025-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2025-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2025-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2025-07-21': 'æµ·ã®æ—¥',
            '2025-08-11': 'å±±ã®æ—¥',
            '2025-09-15': 'æ•¬è€ã®æ—¥',
            '2025-09-23': 'ç§‹åˆ†ã®æ—¥',
            '2025-10-13': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2025-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2025-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥',
            '2025-11-24': 'æŒ¯æ›¿ä¼‘æ—¥'
        };
        
        // 2026å¹´ã®ç¥æ—¥ãƒ‡ãƒ¼ã‚¿
        const holidays2026 = {
            '2026-01-01': 'å…ƒæ—¥',
            '2026-01-12': 'æˆäººã®æ—¥',
            '2026-02-11': 'å»ºå›½è¨˜å¿µã®æ—¥',
            '2026-02-23': 'å¤©çš‡èª•ç”Ÿæ—¥',
            '2026-03-20': 'æ˜¥åˆ†ã®æ—¥',
            '2026-04-29': 'æ˜­å’Œã®æ—¥',
            '2026-05-03': 'æ†²æ³•è¨˜å¿µæ—¥',
            '2026-05-04': 'ã¿ã©ã‚Šã®æ—¥',
            '2026-05-05': 'ã“ã©ã‚‚ã®æ—¥',
            '2026-05-06': 'æŒ¯æ›¿ä¼‘æ—¥',
            '2026-07-20': 'æµ·ã®æ—¥',
            '2026-08-11': 'å±±ã®æ—¥',
            '2026-09-21': 'æ•¬è€ã®æ—¥',
            '2026-09-22': 'å›½æ°‘ã®ä¼‘æ—¥',
            '2026-09-23': 'ç§‹åˆ†ã®æ—¥',
            '2026-10-12': 'ã‚¹ãƒãƒ¼ãƒ„ã®æ—¥',
            '2026-11-03': 'æ–‡åŒ–ã®æ—¥',
            '2026-11-23': 'å‹¤åŠ´æ„Ÿè¬ã®æ—¥'
        };
        
        // ç¥æ—¥åˆ¤å®š
        function isHoliday(dateStr) {
            return holidays2025[dateStr] || holidays2026[dateStr] || null;
        }
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        let data = {
            workDays: {},    // { "2026-01-15": { type: "office", dest: "" } }
            expenses: [],    // [{ date, category, desc, amount }]
            transHistory: [],
            hotelHistory: [],
            events: [],      // [{ date, type, name, location, memo }]
            hotelStays: [],  // [{ checkin, checkout, name, area, price, rating, memo }]
            templates: []    // [{ name, days: [{ type, dest }] }]
        };
        
        // å¹´é–“ã‚µãƒãƒªãƒ¼ç”¨ã®å¹´
        let annualYear = 2026;
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderAll();
            setupEventListeners();
        });
        
        // Google Apps Script APIã®URL
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyXPUu9Azv4YwU-N0YLaEuaNv9MvorQKDzn6TvkdGzCnGba_v_A1gNcj-2K8qU05vdaxA/exec';
        
        // åŒæœŸçŠ¶æ…‹
        let isSyncing = false;
        let lastSyncTime = null;
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« â†’ ã‚¯ãƒ©ã‚¦ãƒ‰ã®é †ï¼‰
        function loadData() {
            // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
            const saved = localStorage.getItem('workTrackerData');
            if (saved) {
                const loaded = JSON.parse(saved);
                data = {
                    workDays: loaded.workDays || {},
                    expenses: loaded.expenses || [],
                    transHistory: loaded.transHistory || [],
                    hotelHistory: loaded.hotelHistory || [],
                    events: loaded.events || [],
                    hotelStays: loaded.hotelStays || [],
                    templates: loaded.templates || []
                };
            }
            // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ã‚‚èª­ã¿è¾¼ã¿ï¼ˆéåŒæœŸï¼‰
            loadFromCloud();
        }
        
        // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadFromCloud() {
            try {
                updateSyncStatus('syncing', 'åŒæœŸä¸­...');
                const response = await fetch(`${GAS_URL}?action=load`);
                const result = await response.json();
                
                if (result.success && result.data && result.data !== '{}') {
                    const cloudData = JSON.parse(result.data);
                    
                    // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ã‚’å„ªå…ˆï¼‰
                    data = {
                        workDays: cloudData.workDays || data.workDays || {},
                        expenses: cloudData.expenses || data.expenses || [],
                        transHistory: cloudData.transHistory || data.transHistory || [],
                        hotelHistory: cloudData.hotelHistory || data.hotelHistory || [],
                        events: cloudData.events || data.events || [],
                        hotelStays: cloudData.hotelStays || data.hotelStays || [],
                        templates: cloudData.templates || data.templates || []
                    };
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚‚ä¿å­˜
                    localStorage.setItem('workTrackerData', JSON.stringify(data));
                    renderAll();
                    lastSyncTime = new Date();
                    updateSyncStatus('success', 'åŒæœŸå®Œäº†');
                } else {
                    // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    if (localStorage.getItem('workTrackerData')) {
                        await saveToCloud();
                    }
                    updateSyncStatus('success', 'åŒæœŸå®Œäº†');
                }
            } catch (error) {
                console.error('Cloud load error:', error);
                updateSyncStatus('error', 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰');
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼†ã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰
        function saveData() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
            localStorage.setItem('workTrackerData', JSON.stringify(data));
            // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
            debouncedSaveToCloud();
        }
        
        // ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨ï¼‰
        let saveTimeout = null;
        function debouncedSaveToCloud() {
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveToCloud();
            }, 2000); // 2ç§’å¾Œã«ä¿å­˜
        }
        
        // ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        async function saveToCloud() {
            if (isSyncing) return;
            isSyncing = true;
            
            try {
                updateSyncStatus('syncing', 'ä¿å­˜ä¸­...');
                const formData = new URLSearchParams();
                formData.append('action', 'save');
                formData.append('data', JSON.stringify(data));
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (result.success) {
                    lastSyncTime = new Date();
                    updateSyncStatus('success', 'ä¿å­˜å®Œäº†');
                } else {
                    updateSyncStatus('error', 'ä¿å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('Cloud save error:', error);
                updateSyncStatus('error', 'ä¿å­˜å¤±æ•—');
            } finally {
                isSyncing = false;
            }
        }
        
        // æ‰‹å‹•åŒæœŸ
        async function manualSync() {
            await loadFromCloud();
        }
        
        // åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºæ›´æ–°
        function updateSyncStatus(status, message) {
            const statusEl = document.getElementById('syncStatus');
            const iconEl = document.getElementById('syncIcon');
            const textEl = document.getElementById('syncText');
            
            if (!statusEl) return;
            
            textEl.textContent = message;
            
            if (status === 'syncing') {
                iconEl.textContent = 'ğŸ”„';
                iconEl.classList.add('spinning');
            } else if (status === 'success') {
                iconEl.textContent = 'â˜ï¸';
                iconEl.classList.remove('spinning');
            } else if (status === 'error') {
                iconEl.textContent = 'âš ï¸';
                iconEl.classList.remove('spinning');
            }
        }
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            document.getElementById('workType').addEventListener('change', (e) => {
                document.getElementById('tripDestGroup').style.display =
                    e.target.value === 'trip' ? 'block' : 'none';
            });
            document.getElementById('modalWorkType').addEventListener('change', (e) => {
                const val = e.target.value;
                document.getElementById('modalTripDestGroup').style.display =
                    val === 'trip' ? 'block' : 'none';
                document.getElementById('modalHourLeaveGroup').style.display =
                    val === 'paid-leave-hour' ? 'block' : 'none';
            });
            // åˆå‰/åˆå¾Œã®å‡ºå¼µå…ˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('modalAmType').addEventListener('change', updateAmPmTripDestVisibility);
            document.getElementById('modalPmType').addEventListener('change', updateAmPmTripDestVisibility);
            // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('dayModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeModal();
                }
            });
            // å®¿æ³Šå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('hotelDetailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeHotelDetailModal();
                }
            });
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('eventDetailModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeEventDetailModal();
                }
            });
            // æ—¥ä»˜æŒ‡å®šã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('copyToDateModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeCopyToDateModal();
                }
            });
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu')) {
                    closeContextMenu();
                }
            });
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ(Alt/Optionã‚­ãƒ¼æ¤œå‡º)
            document.addEventListener('keydown', (e) => {
                if (e.altKey && draggedDate) {
                    isCopyMode = true;
                }
            });
            document.addEventListener('keyup', (e) => {
                if (!e.altKey) {
                    isCopyMode = false;
                }
            });
            // å®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å‡ºå¼µå…ˆè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('recurringWorkType').addEventListener('change', (e) => {
                document.getElementById('recurringTripDestGroup').style.display =
                    e.target.value === 'trip' ? 'block' : 'none';
            });
        }
        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // ç‰¹å®šã®ã‚¿ãƒ–ã§è¿½åŠ ã®æç”»
            if (tabId === 'annual') {
                renderAnnualSummary();
            } else if (tabId === 'settings') {
                renderTemplateList();
                // å®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’è¨­å®š
                const today = new Date();
                const threeMonthsLater = new Date(today);
                threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
                document.getElementById('recurringStartDate').value = toDateStr(today);
                document.getElementById('recurringEndDate').value = toDateStr(threeMonthsLater);
            }
        }
        // æœˆå¤‰æ›´
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            } else if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            renderAll();
        }
        // å…¨ä½“ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderAll() {
            document.getElementById('currentMonth').textContent = `${currentYear}å¹´${currentMonth}æœˆ`;
            renderCalendar();
            renderSummary();
            renderExpenseTable();
            renderHistories();
            renderEventTable();
            renderHotelTable();
            
            // æ—¥ä»˜å…¥åŠ›ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä»Šæ—¥ã«
            const today = toDateStr(new Date());
            document.getElementById('workDate').value = today;
            document.getElementById('transDate').value = today;
            document.getElementById('hotelDate').value = today;
            document.getElementById('allowanceDate').value = today;
            document.getElementById('eventDate').value = today;
            document.getElementById('hotelCheckin').value = today;
            document.getElementById('hotelCheckout').value = today;
        }
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            // ç©ºç™½ã‚»ãƒ«
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                grid.appendChild(emptyCell);
            }
            // æ—¥ä»˜ã‚»ãƒ«
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = data.workDays[dateStr];
                const dateObj = new Date(currentYear, currentMonth - 1, day);
                const dayOfWeek = dateObj.getDay();
                const holidayName = isHoliday(dateStr);
                
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                if (dateStr === todayStr) {
                    cell.classList.add('today');
                }
                
                // åœŸæ—¥ç¥ã®åˆ¤å®š
                if (dayOfWeek === 0) {
                    cell.classList.add('sunday');
                } else if (dayOfWeek === 6) {
                    cell.classList.add('saturday');
                }
                if (holidayName) {
                    cell.classList.add('holiday');
                    cell.title = holidayName;
                }
                
                if (dayData) {
                    if (dayData.type === 'split') {
                        cell.classList.add('split');
                    } else {
                        cell.classList.add(dayData.type);
                    }
                }
                
                // ã“ã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                const dayEvents = (data.events || []).filter(e => e.date === dateStr);
                const eventHtml = dayEvents.length > 0 
                    ? `<span class="event-badge" title="${dayEvents.map(e => e.name).join(', ')}">${dayEvents[0].name.substring(0, 6)}${dayEvents.length > 1 ? '...' : ''}</span>`
                    : '';
                
                // è¡¨ç¤ºå†…å®¹ã‚’ç”Ÿæˆ
                let badgeHtml = '';
                let destHtml = '';
                
                if (dayData) {
                    if (dayData.type === 'split') {
                        // åˆå‰/åˆå¾Œåˆ¥è¡¨ç¤º
                        const amLabel = dayData.amType ? getTypeLabel(dayData.amType) : '';
                        const pmLabel = dayData.pmType ? getTypeLabel(dayData.pmType) : '';
                        badgeHtml = `<span class="type-badge split-badge">${amLabel}/${pmLabel}</span>`;
                        
                        // å‡ºå¼µå…ˆãŒã‚ã‚Œã°è¡¨ç¤º
                        const dests = [];
                        if (dayData.amDest) dests.push(dayData.amDest);
                        if (dayData.pmDest) dests.push(dayData.pmDest);
                        if (dests.length > 0) {
                            destHtml = `<span class="dest-label">${dests.join('â†’')}</span>`;
                        }
                    } else {
                        // å¾“æ¥ã®è¡¨ç¤º
                        badgeHtml = `<span class="type-badge">${getTypeLabel(dayData.type)}${dayData.type === 'paid-leave-hour' && dayData.hours ? `(${dayData.hours}h)` : ''}</span>`;
                        if (dayData.dest) {
                            destHtml = `<span class="dest-label">${dayData.dest}</span>`;
                        }
                    }
                }
                
                cell.innerHTML = `
                    <span class="date">${day}</span>
                    ${badgeHtml}
                    ${destHtml}
                    ${eventHtml}
                `;
                // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—è¨­å®š
                if (dayData) {
                    cell.draggable = true;
                    cell.addEventListener('dragstart', (e) => handleDragStart(e, dateStr));
                    cell.addEventListener('dragend', handleDragEnd);
                }
                cell.addEventListener('dragover', handleDragOver);
                cell.addEventListener('dragleave', handleDragLeave);
                cell.addEventListener('drop', (e) => handleDrop(e, dateStr));
                // å·¦ã‚¯ãƒªãƒƒã‚¯(ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«)
                cell.addEventListener('click', (e) => {
                    if (e.button === 0 && !e.ctrlKey && !e.metaKey) {
                        openDayModal(dateStr, day);
                    }
                });
                // å³ã‚¯ãƒªãƒƒã‚¯(ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼)
                cell.addEventListener('contextmenu', (e) => {
                    if (dayData) {
                        e.preventDefault();
                        showContextMenu(e, dateStr);
                    }
                });
                grid.appendChild(cell);
            }
        }
        // å‹¤å‹™ã‚¿ã‚¤ãƒ—ã®ãƒ©ãƒ™ãƒ«å–å¾—
        function getTypeLabel(type) {
            const labels = {
                'office': 'å‡ºç¤¾',
                'remote': 'åœ¨å®…',
                'trip': 'å‡ºå¼µ',
                'paid-leave': 'æœ‰çµ¦',
                'paid-leave-am': 'AMä¼‘',
                'paid-leave-pm': 'PMä¼‘',
                'paid-leave-hour': 'æ™‚é–“ä¼‘'
            };
            return labels[type] || '';
        }
        
        // æœ‰çµ¦ç³»ã‹ã©ã†ã‹åˆ¤å®š
        function isPaidLeaveType(type) {
            return type && type.startsWith('paid-leave');
        }
        // ã‚µãƒãƒªãƒ¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderSummary() {
            const monthPrefix = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            
            let counts = { office: 0, remote: 0, trip: 0, paidLeave: 0 };
            
            Object.entries(data.workDays).forEach(([date, info]) => {
                if (date.startsWith(monthPrefix)) {
                    if (info.type === 'split') {
                        // åˆå‰/åˆå¾Œåˆ¥ã®å ´åˆã€å„ã‚¿ã‚¤ãƒ—ã‚’0.5æ—¥ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
                        if (info.amType === 'office') counts.office += 0.5;
                        else if (info.amType === 'remote') counts.remote += 0.5;
                        else if (info.amType === 'trip') counts.trip += 0.5;
                        else if (isPaidLeaveType(info.amType)) counts.paidLeave += 0.5;
                        
                        if (info.pmType === 'office') counts.office += 0.5;
                        else if (info.pmType === 'remote') counts.remote += 0.5;
                        else if (info.pmType === 'trip') counts.trip += 0.5;
                        else if (isPaidLeaveType(info.pmType)) counts.paidLeave += 0.5;
                    } else {
                        if (info.type === 'office') counts.office++;
                        else if (info.type === 'remote') counts.remote++;
                        else if (info.type === 'trip') counts.trip++;
                        else if (isPaidLeaveType(info.type)) counts.paidLeave++;
                    }
                }
            });
            const workDays = counts.office + counts.remote + counts.trip;
            
            document.getElementById('sumWorkDays').textContent = workDays;
            document.getElementById('sumRemote').textContent = counts.remote;
            document.getElementById('sumOffice').textContent = counts.office;
            document.getElementById('sumTrip').textContent = counts.trip;
            document.getElementById('sumPaidLeave').textContent = counts.paidLeave;
            // çµŒè²»åˆè¨ˆ(å€‹äººç«‹æ›¿)
            const monthExpenses = data.expenses.filter(e => e.date.startsWith(monthPrefix));
            
            const personalTotal = monthExpenses
                .filter(e => e.paymentType !== 'æ³•äººã‚«ãƒ¼ãƒ‰')
                .reduce((sum, e) => sum + e.amount, 0);
            
            document.getElementById('sumPersonal').textContent = personalTotal.toLocaleString();
            
            // æ³•äººã‚«ãƒ¼ãƒ‰ç· ã‚æœŸé–“åˆ¥è¡¨ç¤ºã‚’æ›´æ–°
            renderCorporatePeriod();
        }
        
        // æ³•äººã‚«ãƒ¼ãƒ‰ç· ã‚æœŸé–“åˆ¥è¡¨ç¤º
        function renderCorporatePeriod() {
            // ç· ã‚æœŸé–“ã‚’è¨ˆç®—ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆä»˜ãï¼‰
            let targetYear = currentYear;
            let targetMonth = currentMonth + corporatePeriodOffset;
            
            // æœˆã®èª¿æ•´
            while (targetMonth > 12) {
                targetMonth -= 12;
                targetYear++;
            }
            while (targetMonth < 1) {
                targetMonth += 12;
                targetYear--;
            }
            
            // é–‹å§‹æ—¥: å½“æœˆ16æ—¥
            const startDate = `${targetYear}-${String(targetMonth).padStart(2, '0')}-16`;
            
            // çµ‚äº†æ—¥: ç¿Œæœˆ15æ—¥
            let endMonth = targetMonth + 1;
            let endYear = targetYear;
            if (endMonth > 12) {
                endMonth = 1;
                endYear++;
            }
            const endDate = `${endYear}-${String(endMonth).padStart(2, '0')}-15`;
            
            // æœŸé–“ãƒ©ãƒ™ãƒ«
            const periodLabel = `${targetMonth}/16 ã€œ ${endMonth}/15`;
            document.getElementById('corporatePeriodRange').textContent = periodLabel;
            
            // æ³•äººã‚«ãƒ¼ãƒ‰ã®çµŒè²»ã‚’é›†è¨ˆ
            const corporateExpenses = data.expenses.filter(e => {
                return e.paymentType === 'æ³•äººã‚«ãƒ¼ãƒ‰' && e.date >= startDate && e.date <= endDate;
            });
            
            const total = corporateExpenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('sumCorporatePeriod').textContent = total.toLocaleString();
            document.getElementById('sumCorporateCount').textContent = corporateExpenses.length;
        }
        
        // æ³•äººã‚«ãƒ¼ãƒ‰ç· ã‚æœŸé–“ã‚’å¤‰æ›´
        function changeCorporatePeriod(delta) {
            corporatePeriodOffset += delta;
            renderCorporatePeriod();
        }
        // çµŒè²»ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆç· ã‚æ—¥å¯¾å¿œç‰ˆï¼‰
        function renderExpenseTable() {
            const viewType = document.getElementById('expenseViewType').value;
            const tbody = document.getElementById('expenseTableBody');
            
            // ç· ã‚æœŸé–“ã‚’è¨ˆç®—
            let startDate, endDate, periodLabel;
            
            if (viewType === 'personal') {
                // å€‹äººç«‹æ›¿: å½“æœˆ1æ—¥ã€œå½“æœˆæœ«æ—¥
                startDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-01`;
                const lastDay = new Date(currentYear, currentMonth, 0).getDate();
                endDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
                periodLabel = `${currentMonth}/1 ã€œ ${currentMonth}/${lastDay}`;
            } else {
                // æ³•äººã‚«ãƒ¼ãƒ‰: å½“æœˆ16æ—¥ã€œç¿Œæœˆ15æ—¥
                startDate = `${currentYear}-${String(currentMonth).padStart(2, '0')}-16`;
                let nextMonth = currentMonth + 1;
                let nextYear = currentYear;
                if (nextMonth > 12) {
                    nextMonth = 1;
                    nextYear++;
                }
                endDate = `${nextYear}-${String(nextMonth).padStart(2, '0')}-15`;
                periodLabel = `${currentMonth}/16 ã€œ ${nextMonth}/15`;
            }
            
            document.getElementById('expensePeriodLabel').textContent = `å¯¾è±¡æœŸé–“: ${periodLabel}`;
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredExpenses = data.expenses
                .filter(e => {
                    const matchDate = e.date >= startDate && e.date <= endDate;
                    const matchType = viewType === 'personal' 
                        ? (e.paymentType !== 'æ³•äººã‚«ãƒ¼ãƒ‰')
                        : (e.paymentType === 'æ³•äººã‚«ãƒ¼ãƒ‰');
                    return matchDate && matchType;
                });
            
            // ã‚½ãƒ¼ãƒˆ
            const { key, order } = sortState.expense;
            filteredExpenses.sort((a, b) => {
                let valA = a[key] || '';
                let valB = b[key] || '';
                if (key === 'amount') {
                    valA = Number(valA);
                    valB = Number(valB);
                }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
            updateSortHeaders('expense', key, order);
            
            if (filteredExpenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">çµŒè²»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                document.getElementById('expenseSummary').textContent = '';
                return;
            }
            
            tbody.innerHTML = filteredExpenses.map((e) => {
                const globalIndex = data.expenses.indexOf(e);
                return `
                <tr data-index="${globalIndex}">
                    <td><input type="checkbox" class="expense-checkbox" data-index="${globalIndex}"></td>
                    <td>${getCategoryLabel(e.category)}</td>
                    <td>${formatDate(e.date)}</td>
                    <td>${e.desc}</td>
                    <td class="amount">Â¥${e.amount.toLocaleString()}</td>
                    <td><span style="font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: ${e.paymentType === 'æ³•äººã‚«ãƒ¼ãƒ‰' ? 'var(--accent-purple)' : 'var(--accent-blue)'};">${e.paymentType || 'å€‹äººç«‹æ›¿'}</span></td>
                    <td><button class="delete-btn" onclick="deleteExpense(${globalIndex})">âœ•</button></td>
                </tr>
            `}).join('');
            
            // åˆè¨ˆè¡¨ç¤º
            const total = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            document.getElementById('expenseSummary').innerHTML = `
                <strong>åˆè¨ˆ: Â¥${total.toLocaleString()}</strong>ï¼ˆ${filteredExpenses.length}ä»¶ï¼‰
            `;
        }
        
        // çµŒè²»ãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
        function sortExpenseTable(key) {
            if (sortState.expense.key === key) {
                sortState.expense.order = sortState.expense.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.expense.key = key;
                sortState.expense.order = 'asc';
            }
            renderExpenseTable();
        }
        
        // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
        function updateSortHeaders(tableType, activeKey, order) {
            const tableMap = {
                'expense': '#dashboard .expense-table',
                'event': '#events .expense-table',
                'hotel': '#hotels .expense-table'
            };
            const table = document.querySelector(tableMap[tableType]);
            if (!table) return;
            
            table.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });
            
            const keyMap = {
                'expense': { 'category': 1, 'date': 2, 'desc': 3, 'amount': 4, 'paymentType': 5 },
                'event': { 'date': 1, 'type': 2, 'name': 3, 'location': 4 },
                'hotel': { 'checkin': 1, 'name': 2, 'area': 3, 'nights': 4, 'price': 5, 'rating': 6 }
            };
            
            const colIndex = keyMap[tableType][activeKey];
            if (colIndex !== undefined) {
                const th = table.querySelector(`thead tr th:nth-child(${colIndex + 1})`);
                if (th) th.classList.add(order);
            }
        }
        
        // å…¨é¸æŠ
        function selectAllExpenses() {
            document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('expenseSelectAll').checked = true;
        }
        
        // é¸æŠè§£é™¤
        function deselectAllExpenses() {
            document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('expenseSelectAll').checked = false;
        }
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§å…¨åˆ‡ã‚Šæ›¿ãˆ
        function toggleAllExpenseCheckboxes(headerCheckbox) {
            document.querySelectorAll('.expense-checkbox').forEach(cb => cb.checked = headerCheckbox.checked);
        }
        
        // é¸æŠã—ãŸçµŒè²»ã‚’å‰Šé™¤
        function deleteSelectedExpenses() {
            const checkedBoxes = document.querySelectorAll('.expense-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!confirm(`${checkedBoxes.length}ä»¶ã®çµŒè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆå¾Œã‚ã‹ã‚‰å‰Šé™¤ã—ãªã„ã¨ã‚ºãƒ¬ã‚‹ï¼‰
            const indices = Array.from(checkedBoxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            
            indices.forEach(idx => {
                data.expenses.splice(idx, 1);
            });
            
            saveData();
            renderAll();
            alert(`${checkedBoxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        
        // è¡¨ç¤ºä¸­ã®çµŒè²»ã‚’å…¨å‰Šé™¤
        function deleteAllDisplayedExpenses() {
            const checkboxes = document.querySelectorAll('.expense-checkbox');
            if (checkboxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const viewType = document.getElementById('expenseViewType').value;
            const typeName = viewType === 'personal' ? 'å€‹äººç«‹æ›¿' : 'æ³•äººã‚«ãƒ¼ãƒ‰';
            
            if (!confirm(`è¡¨ç¤ºä¸­ã®${typeName}ãƒ‡ãƒ¼ã‚¿ï¼ˆ${checkboxes.length}ä»¶ï¼‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é™é †ã§ã‚½ãƒ¼ãƒˆ
            const indices = Array.from(checkboxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            
            indices.forEach(idx => {
                data.expenses.splice(idx, 1);
            });
            
            saveData();
            renderAll();
            alert(`${checkboxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        // ã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ™ãƒ«
        function getCategoryLabel(category) {
            const labels = {
                'transport': 'ğŸšƒ äº¤é€šè²»',
                'hotel': 'ğŸ¨ å®¿æ³Šè²»',
                'allowance': 'ğŸ’¼ å‡ºå¼µæ‰‹å½“',
                'entertainment': 'ğŸ» äº¤éš›è²»',
                'other': 'ğŸ“ ãã®ä»–'
            };
            return labels[category] || category;
        }
        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return `${parseInt(m)}/${parseInt(d)}`;
        }
        // å±¥æ­´ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderHistories() {
            const transHistory = document.getElementById('transHistory');
            const hotelHistory = document.getElementById('hotelHistory');
            transHistory.innerHTML = data.transHistory.map(h => 
                `<div class="history-item" onclick="fillTransport('${h.route}', ${h.amount})">${h.route} - Â¥${h.amount.toLocaleString()}</div>`
            ).join('');
            hotelHistory.innerHTML = data.hotelHistory.map(h => 
                `<div class="history-item" onclick="fillHotel('${h.name}', ${h.amount})">${h.name} - Â¥${h.amount.toLocaleString()}</div>`
            ).join('');
        }
        // å±¥æ­´ã‹ã‚‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
        function fillTransport(route, amount) {
            document.getElementById('transRoute').value = route;
            document.getElementById('transAmount').value = amount;
        }
        function fillHotel(name, amount) {
            document.getElementById('hotelName').value = name;
            document.getElementById('hotelAmount').value = amount;
        }
        // å‹¤å‹™æ—¥ä¿å­˜
        function saveWorkDay() {
            const date = document.getElementById('workDate').value;
            const type = document.getElementById('workType').value;
            const dest = document.getElementById('tripDest').value;
            if (!date || !type) {
                alert('æ—¥ä»˜ã¨å‹¤å‹™ã‚¿ã‚¤ãƒ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.workDays[date] = { type, dest };
            saveData();
            renderAll();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('workType').value = '';
            document.getElementById('tripDest').value = '';
            document.getElementById('tripDestGroup').style.display = 'none';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // äº¤é€šè²»ä¿å­˜
        function saveTransport() {
            const date = document.getElementById('transDate').value;
            const route = document.getElementById('transRoute').value;
            const amount = parseInt(document.getElementById('transAmount').value);
            if (!date || !route || !amount) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.expenses.push({ date, category: 'transport', desc: route, amount });
            
            // å±¥æ­´ã«è¿½åŠ (é‡è¤‡æ’é™¤ã€æœ€å¤§10ä»¶)
            const historyKey = `${route}-${amount}`;
            data.transHistory = data.transHistory.filter(h => `${h.route}-${h.amount}` !== historyKey);
            data.transHistory.unshift({ route, amount });
            data.transHistory = data.transHistory.slice(0, 10);
            saveData();
            renderAll();
            document.getElementById('transRoute').value = '';
            document.getElementById('transAmount').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // å®¿æ³Šè²»ä¿å­˜
        function saveHotel() {
            const date = document.getElementById('hotelDate').value;
            const name = document.getElementById('hotelName').value;
            const amount = parseInt(document.getElementById('hotelAmount').value);
            if (!date || !name || !amount) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.expenses.push({ date, category: 'hotel', desc: name, amount });
            
            // å±¥æ­´ã«è¿½åŠ 
            const historyKey = `${name}-${amount}`;
            data.hotelHistory = data.hotelHistory.filter(h => `${h.name}-${h.amount}` !== historyKey);
            data.hotelHistory.unshift({ name, amount });
            data.hotelHistory = data.hotelHistory.slice(0, 10);
            saveData();
            renderAll();
            document.getElementById('hotelName').value = '';
            document.getElementById('hotelAmount').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // å‡ºå¼µæ‰‹å½“ä¿å­˜
        function saveAllowance() {
            const date = document.getElementById('allowanceDate').value;
            const amount = 3000;
            if (!date) {
                alert('æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            data.expenses.push({ date, category: 'allowance', desc: 'å‡ºå¼µæ‰‹å½“', amount });
            saveData();
            renderAll();
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }
        // çµŒè²»å‰Šé™¤
        function deleteExpense(index) {
            if (confirm('ã“ã®çµŒè²»ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                data.expenses.splice(index, 1);
                saveData();
                renderAll();
            }
        }
        // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
        function openDayModal(dateStr, day) {
            selectedDate = dateStr;
            const dayData = data.workDays[dateStr];
            document.getElementById('modalTitle').textContent = `${currentMonth}æœˆ${day}æ—¥ã®ç·¨é›†`;
            
            // è©³ç´°ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆå‰/åˆå¾Œåˆ¥ï¼‰ã‹ã©ã†ã‹ã‚’åˆ¤å®š
            const isDetailMode = dayData?.amType || dayData?.pmType;
            document.getElementById('modalDetailMode').checked = isDetailMode;
            toggleModalDetailMode();
            
            if (isDetailMode) {
                // è©³ç´°ãƒ¢ãƒ¼ãƒ‰ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
                document.getElementById('modalAmType').value = dayData?.amType || '';
                document.getElementById('modalAmTripDest').value = dayData?.amDest || '';
                document.getElementById('modalPmType').value = dayData?.pmType || '';
                document.getElementById('modalPmTripDest').value = dayData?.pmDest || '';
                updateAmPmTripDestVisibility();
            } else {
                // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
                document.getElementById('modalWorkType').value = dayData?.type || '';
                document.getElementById('modalTripDest').value = dayData?.dest || '';
                document.getElementById('modalHourLeave').value = dayData?.hours || '';
                document.getElementById('modalTripDestGroup').style.display = 
                    dayData?.type === 'trip' ? 'block' : 'none';
                document.getElementById('modalHourLeaveGroup').style.display = 
                    dayData?.type === 'paid-leave-hour' ? 'block' : 'none';
            }
            
            // ã‚³ãƒ”ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
            document.getElementById('modalCopySection').style.display = dayData ? 'block' : 'none';
            
            document.getElementById('dayModal').classList.add('active');
        }
        
        function toggleModalDetailMode() {
            const isDetail = document.getElementById('modalDetailMode').checked;
            document.getElementById('modalSimpleMode').style.display = isDetail ? 'none' : 'block';
            document.getElementById('modalDetailModeSection').style.display = isDetail ? 'block' : 'none';
        }
        
        function updateAmPmTripDestVisibility() {
            document.getElementById('modalAmTripDestGroup').style.display = 
                document.getElementById('modalAmType').value === 'trip' ? 'block' : 'none';
            document.getElementById('modalPmTripDestGroup').style.display = 
                document.getElementById('modalPmType').value === 'trip' ? 'block' : 'none';
        }
        
        function closeModal() {
            document.getElementById('dayModal').classList.remove('active');
            selectedDate = null;
        }
        
        function saveModalWorkDay() {
            const isDetailMode = document.getElementById('modalDetailMode').checked;
            
            if (isDetailMode) {
                // è©³ç´°ãƒ¢ãƒ¼ãƒ‰ï¼ˆåˆå‰/åˆå¾Œåˆ¥ï¼‰
                const amType = document.getElementById('modalAmType').value;
                const amDest = document.getElementById('modalAmTripDest').value;
                const pmType = document.getElementById('modalPmType').value;
                const pmDest = document.getElementById('modalPmTripDest').value;
                
                if (!amType && !pmType) {
                    delete data.workDays[selectedDate];
                } else {
                    const workDayData = { 
                        type: 'split',  // åˆ†å‰²å‹¤å‹™ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
                        amType: amType || '',
                        pmType: pmType || ''
                    };
                    if (amType === 'trip' && amDest) {
                        workDayData.amDest = amDest;
                    }
                    if (pmType === 'trip' && pmDest) {
                        workDayData.pmDest = pmDest;
                    }
                    data.workDays[selectedDate] = workDayData;
                }
            } else {
                // ã‚·ãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰
                const type = document.getElementById('modalWorkType').value;
                const dest = document.getElementById('modalTripDest').value;
                const hours = document.getElementById('modalHourLeave').value;
                
                if (!type) {
                    delete data.workDays[selectedDate];
                } else {
                    const workDayData = { type };
                    if (type === 'trip' && dest) {
                        workDayData.dest = dest;
                    }
                    if (type === 'paid-leave-hour' && hours) {
                        workDayData.hours = parseInt(hours);
                    }
                    data.workDays[selectedDate] = workDayData;
                }
            }
            
            saveData();
            renderAll();
            closeModal();
        }
        
        function deleteWorkDay() {
            if (confirm('ã“ã®æ—¥ã®å‹¤å‹™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                delete data.workDays[selectedDate];
                saveData();
                renderAll();
                closeModal();
            }
        }
        
        // ===== ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ =====
        
        // ç¿Œæ—¥ã«ã‚³ãƒ”ãƒ¼
        function copyToNextDay() {
            const dayData = data.workDays[selectedDate];
            if (!dayData) return;
            
            const currentDate = new Date(selectedDate);
            currentDate.setDate(currentDate.getDate() + 1);
            const nextDateStr = toDateStr(currentDate);
            
            data.workDays[nextDateStr] = JSON.parse(JSON.stringify(dayData));
            saveData();
            renderAll();
            closeModal();
            alert('ç¿Œæ—¥ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }
        
        // å‰æ—¥ã«ã‚³ãƒ”ãƒ¼
        function copyToPrevDay() {
            const dayData = data.workDays[selectedDate];
            if (!dayData) return;
            
            const currentDate = new Date(selectedDate);
            currentDate.setDate(currentDate.getDate() - 1);
            const prevDateStr = toDateStr(currentDate);
            
            data.workDays[prevDateStr] = JSON.parse(JSON.stringify(dayData));
            saveData();
            renderAll();
            closeModal();
            alert('å‰æ—¥ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }
        
        // æ—¥ä»˜æŒ‡å®šã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openCopyToDateModal() {
            // ç¿Œæ—¥ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«
            const currentDate = new Date(selectedDate);
            currentDate.setDate(currentDate.getDate() + 1);
            document.getElementById('copyTargetDate').value = toDateStr(currentDate);
            document.getElementById('copyEndDate').value = '';
            document.getElementById('copyMultipleDays').checked = false;
            document.getElementById('copyEndDateGroup').style.display = 'none';
            
            document.getElementById('copyToDateModal').classList.add('active');
        }
        
        // æ—¥ä»˜æŒ‡å®šã‚³ãƒ”ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCopyToDateModal() {
            document.getElementById('copyToDateModal').classList.remove('active');
        }
        
        // è¤‡æ•°æ—¥ã‚³ãƒ”ãƒ¼ã®çµ‚äº†æ—¥è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleCopyEndDate() {
            const isMultiple = document.getElementById('copyMultipleDays').checked;
            document.getElementById('copyEndDateGroup').style.display = isMultiple ? 'block' : 'none';
        }
        
        // æ—¥ä»˜æŒ‡å®šã‚³ãƒ”ãƒ¼å®Ÿè¡Œ
        function executeCopyToDate() {
            const dayData = data.workDays[selectedDate];
            if (!dayData) return;
            
            const targetDate = document.getElementById('copyTargetDate').value;
            if (!targetDate) {
                alert('ã‚³ãƒ”ãƒ¼å…ˆã®æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const isMultiple = document.getElementById('copyMultipleDays').checked;
            
            if (isMultiple) {
                const endDate = document.getElementById('copyEndDate').value;
                if (!endDate) {
                    alert('çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                // è¤‡æ•°æ—¥ã«ã‚³ãƒ”ãƒ¼
                let current = new Date(targetDate);
                const end = new Date(endDate);
                let count = 0;
                
                while (current <= end) {
                    const dateStr = toDateStr(current);
                    data.workDays[dateStr] = JSON.parse(JSON.stringify(dayData));
                    current.setDate(current.getDate() + 1);
                    count++;
                    
                    // å®‰å…¨ã®ãŸã‚æœ€å¤§365æ—¥ã¾ã§
                    if (count > 365) break;
                }
                
                saveData();
                renderAll();
                closeCopyToDateModal();
                closeModal();
                alert(`${count}æ—¥åˆ†ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
            } else {
                // 1æ—¥ã«ã‚³ãƒ”ãƒ¼
                data.workDays[targetDate] = JSON.parse(JSON.stringify(dayData));
                saveData();
                renderAll();
                closeCopyToDateModal();
                closeModal();
                alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }
        }
        // åˆ¤æ–­ãƒ•ãƒ­ãƒ¼
        let flowAnswers = {};
        function selectFlow(step, answer) {
            flowAnswers[step] = answer;
            
            // é¸æŠçŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
            document.querySelectorAll(`#flowStep${step} .flow-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.classList.add('selected');
            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
            if (step === 1) {
                document.getElementById('flowStep2').style.display = 'block';
            } else if (step === 2) {
                document.getElementById('flowStep3').style.display = 'block';
            } else if (step === 3) {
                showFlowResult();
            }
        }
        function showFlowResult() {
            const { 1: dest, 2: season, 3: officeCount } = flowAnswers;
            
            let recommend = false;
            let reason = '';
            // åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯
            if (dest === 'tohoku' && season === 'winter') {
                recommend = true;
                reason = 'å†¬å­£ã®æ±åŒ—å‡ºå¼µã¯é…å»¶ãƒªã‚¹ã‚¯ãŒé«˜ã„ãŸã‚ã€å‰ä¹—ã‚Šã‚’æ¨å¥¨ã—ã¾ã™ã€‚';
            } else if (dest === 'tohoku' && officeCount === '2plus') {
                recommend = true;
                reason = 'å‡ºç¤¾2å›ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ãŠã‚Šã€å‰ä¹—ã‚Šã®èª¬æ˜ãŒã—ã‚„ã™ã„çŠ¶æ³ã§ã™ã€‚';
            } else if (officeCount === '2plus') {
                recommend = true;
                reason = 'å‡ºç¤¾å›æ•°ãŒç¢ºä¿ã§ãã¦ã„ã‚‹ãŸã‚ã€å‰ä¹—ã‚Šã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚';
            } else if (dest === 'other' && season === 'other' && officeCount !== '2plus') {
                recommend = false;
                reason = 'ç‰¹æ®µã®ãƒªã‚¹ã‚¯è¦å› ãŒãªã„ãŸã‚ã€å½“æ—¥ç§»å‹•ã§ã‚‚å•é¡Œãªã„ã§ã—ã‚‡ã†ã€‚';
            } else {
                recommend = false;
                reason = 'çŠ¶æ³ã«å¿œã˜ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚è¿½åŠ ã‚³ã‚¹ãƒˆã¨ç§»å‹•è² è·ã‚’æ¯”è¼ƒã—ã¾ã—ã‚‡ã†ã€‚';
            }
            const resultDiv = document.getElementById('flowResult');
            resultDiv.style.display = 'block';
            resultDiv.className = `flow-result ${recommend ? 'recommend' : 'not-recommend'}`;
            resultDiv.innerHTML = `
                <h3>${recommend ? 'âœ… å‰ä¹—ã‚Šæ¨å¥¨' : 'âš ï¸ å½“æ—¥ç§»å‹•ã§OK'}</h3>
                <p>${reason}</p>
            `;
        }
        function resetFlow() {
            flowAnswers = {};
            document.querySelectorAll('.flow-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('flowStep2').style.display = 'none';
            document.getElementById('flowStep3').style.display = 'none';
            document.getElementById('flowResult').style.display = 'none';
        }
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
        function handleDragStart(e, dateStr) {
            draggedDate = dateStr;
            isCopyMode = e.altKey;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = isCopyMode ? 'copy' : 'move';
            e.dataTransfer.setData('text/plain', dateStr);
        }
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedDate = null;
            isCopyMode = false;
            // ã™ã¹ã¦ã®drag-overã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.drag-over, .drag-over-copy').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-copy');
            });
        }
        function handleDragOver(e) {
            if (!draggedDate) return;
            e.preventDefault();
            // Altã‚­ãƒ¼ã®çŠ¶æ…‹ã‚’å¸¸ã«ãƒã‚§ãƒƒã‚¯
            isCopyMode = e.altKey;
            e.dataTransfer.dropEffect = isCopyMode ? 'copy' : 'move';
            const cell = e.currentTarget;
            cell.classList.remove('drag-over', 'drag-over-copy');
            cell.classList.add(isCopyMode ? 'drag-over-copy' : 'drag-over');
        }
        function handleDragLeave(e) {
            const cell = e.currentTarget;
            cell.classList.remove('drag-over', 'drag-over-copy');
        }
        function handleDrop(e, targetDateStr) {
            e.preventDefault();
            if (!draggedDate || draggedDate === targetDateStr) return;
            const sourceData = data.workDays[draggedDate];
            if (!sourceData) return;
            if (isCopyMode || e.altKey) {
                // ã‚³ãƒ”ãƒ¼
                data.workDays[targetDateStr] = { ...sourceData };
            } else {
                // ç§»å‹•
                data.workDays[targetDateStr] = sourceData;
                delete data.workDays[draggedDate];
            }
            saveData();
            renderAll();
            // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            document.querySelectorAll('.drag-over, .drag-over-copy').forEach(el => {
                el.classList.remove('drag-over', 'drag-over-copy');
            });
        }
        // å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½
        function showContextMenu(e, dateStr) {
            e.preventDefault();
            contextMenuDate = dateStr;
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            menu.classList.add('active');
        }
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
            contextMenuDate = null;
        }
        function copyToNextDay() {
            if (!contextMenuDate) return;
            const sourceData = data.workDays[contextMenuDate];
            if (!sourceData) return;
            const date = toLocalDate(contextMenuDate);
            date.setDate(date.getDate() + 1);
            const targetDateStr = toDateStr(date);
            data.workDays[targetDateStr] = { ...sourceData };
            saveData();
            renderAll();
            closeContextMenu();
            alert(`ç¿Œæ—¥(${formatDate(targetDateStr)})ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
        }
        function copyToNextWeek() {
            if (!contextMenuDate) return;
            const sourceData = data.workDays[contextMenuDate];
            if (!sourceData) return;
            const date = toLocalDate(contextMenuDate);
            date.setDate(date.getDate() + 7);
            const targetDateStr = toDateStr(date);
            data.workDays[targetDateStr] = { ...sourceData };
            saveData();
            renderAll();
            closeContextMenu();
            alert(`ç¿Œé€±(${formatDate(targetDateStr)})ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
        }
        function copyToMultipleDays() {
            if (!contextMenuDate) return;
            const sourceData = data.workDays[contextMenuDate];
            if (!sourceData) return;
            const days = prompt('ä½•æ—¥åˆ†ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã‹?(ä¾‹:5)');
            const numDays = parseInt(days);
            if (!numDays || numDays < 1 || numDays > 31) {
                alert('1ã€œ31ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            const startDate = toLocalDate(contextMenuDate);
            let copiedCount = 0;
            for (let i = 1; i <= numDays; i++) {
                const targetDate = new Date(startDate);
                targetDate.setDate(targetDate.getDate() + i);
                const targetDateStr = toDateStr(targetDate);
                data.workDays[targetDateStr] = { ...sourceData };
                copiedCount++;
            }
            saveData();
            renderAll();
            closeContextMenu();
            alert(`${copiedCount}æ—¥åˆ†ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
        }
        function editFromContextMenu() {
            if (!contextMenuDate) return;
            const date = new Date(contextMenuDate);
            const day = date.getDate();
            closeContextMenu();
            openDayModal(contextMenuDate, day);
        }
        function deleteFromContextMenu() {
            if (!contextMenuDate) return;
            if (confirm('ã“ã®æ—¥ã®å‹¤å‹™ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                delete data.workDays[contextMenuDate];
                saveData();
                renderAll();
            }
            closeContextMenu();
        }
        // ã‚³ã‚¹ãƒˆæ¯”è¼ƒè¨ˆç®—
        function calcCostCompare() {
            const tokyoCost = parseInt(document.getElementById('costTokyo').value) || 2540;
            const hotelCost = parseInt(document.getElementById('costHotel').value) || 12000;
            // æ¡ˆ1:å½“æ—¥ç§»å‹•
            // æœˆå‡ºç¤¾ + æ°´å‡ºç¤¾ + æœ¨çŸ³å²¡â†’æ±äº¬ + ä»™å°1æ³Š
            const cost1_mon = tokyoCost * 2;  // å¾€å¾©
            const cost1_wed = tokyoCost * 2;  // å¾€å¾©
            const cost1_thu = tokyoCost;      // ç‰‡é“(çŸ³å²¡â†’æ±äº¬)
            const cost1_hotel = hotelCost;    // 1æ³Š
            const cost1_total = cost1_mon + cost1_wed + cost1_thu + cost1_hotel;
            // æ¡ˆ2:å‰ä¹—ã‚Š
            // æœˆå‡ºç¤¾ + æ°´ç‰‡é“ + ä»™å°2æ³Š
            const cost2_mon = tokyoCost * 2;  // å¾€å¾©
            const cost2_wed = tokyoCost;      // ç‰‡é“
            const cost2_hotel = hotelCost * 2; // 2æ³Š
            const cost2_total = cost2_mon + cost2_wed + cost2_hotel;
            document.getElementById('costCompareResult').style.display = 'grid';
            document.getElementById('costDiff').style.display = 'block';
            document.getElementById('cost1Total').textContent = `Â¥${cost1_total.toLocaleString()}`;
            document.getElementById('cost1Breakdown').innerHTML = `
                æœˆå‡ºç¤¾: Â¥${cost1_mon.toLocaleString()}<br>
                æ°´å‡ºç¤¾: Â¥${cost1_wed.toLocaleString()}<br>
                æœ¨ç§»å‹•: Â¥${cost1_thu.toLocaleString()}<br>
                å®¿æ³Š1æ³Š: Â¥${cost1_hotel.toLocaleString()}
            `;
            document.getElementById('cost2Total').textContent = `Â¥${cost2_total.toLocaleString()}`;
            document.getElementById('cost2Breakdown').innerHTML = `
                æœˆå‡ºç¤¾: Â¥${cost2_mon.toLocaleString()}<br>
                æ°´ç‰‡é“: Â¥${cost2_wed.toLocaleString()}<br>
                å®¿æ³Š2æ³Š: Â¥${cost2_hotel.toLocaleString()}
            `;
            const diff = cost2_total - cost1_total;
            document.getElementById('costDiffValue').textContent = `+Â¥${diff.toLocaleString()}`;
        }
        
        // æ—¥ä»˜æ–‡å­—åˆ—ã®æ­£è¦åŒ–ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function parseDate(raw) {
            if (!raw) return null;
            const s = raw.trim();
            
            // æ­£è¦è¡¨ç¾ã§å¹´æœˆæ—¥ã‚’æŠ½å‡ºï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ï¼‰
            // å¯¾å¿œå½¢å¼: 2026/1/22, 2026-01-22, 2026å¹´1æœˆ22æ—¥
            let match = s.match(/(\d{4})[\/\-å¹´](\d{1,2})[\/\-æœˆ](\d{1,2})æ—¥?/);
            if (!match) return null;
            
            const year = match[1];
            const month = match[2].padStart(2, '0');
            const day = match[3].padStart(2, '0');
            
            // YYYY-MM-DDå½¢å¼ã§è¿”ã™ï¼ˆæ–‡å­—åˆ—æ“ä½œã®ã¿ã€Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä¸ä½¿ç”¨ï¼‰
            return `${year}-${month}-${day}`;
        }
        
        // æ—¥ä»˜æ–‡å­—åˆ—ã‚’ãƒ­ãƒ¼ã‚«ãƒ«Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œå›é¿ï¼‰
        function toLocalDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d); // monthã¯0å§‹ã¾ã‚Š
        }
        
        // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ YYYY-MM-DD æ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§ï¼‰
        function toDateStr(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // å‡ºå¼µäºˆå®šå–ã‚Šè¾¼ã¿ (åˆ—ã‚ºãƒ¬è‡ªå‹•è£œæ­£ç‰ˆãƒ»ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œä¿®æ­£ç‰ˆ)
        function importTripSchedule() {
            const scheduleRaw = document.getElementById('tripScheduleData').value.trim();
            const masterRaw = document.getElementById('officeMasterData').value.trim();
            
            if (!scheduleRaw || !masterRaw) {
                alert('äºˆå®šãƒ‡ãƒ¼ã‚¿ã¨ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¸¡æ–¹ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            // 1. ãƒã‚¹ã‚¿ã®è§£æ (ID -> åå‰)
            const officeMap = {};
            const masterLines = masterRaw.split('\n');
            masterLines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                // ã‚¿ãƒ–ãŒã‚ã‚Œã°ã‚¿ãƒ–å„ªå…ˆã€ãªã‘ã‚Œã°ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
                const cols = trimmed.includes('\t') 
                    ? trimmed.split('\t') 
                    : trimmed.split(/\s+/);
                
                if (cols.length >= 2) {
                    const id = cols[0].trim();
                    // IDä»¥é™ã®æ–‡å­—ã‚’ã™ã¹ã¦åå‰ã¨ã—ã¦çµåˆï¼ˆã‚¹ãƒšãƒ¼ã‚¹å…¥ã‚Šç¤¾åå¯¾ç­–ï¼‰
                    const name = cols.slice(1).join(' ').trim();
                    if (id && name && !isNaN(Number(id))) { // IDãŒæ•°å­—ã®å ´åˆã®ã¿
                        officeMap[id] = name;
                    }
                }
            });
            
            console.log('å–¶æ¥­æ‰€ãƒã‚¹ã‚¿:', officeMap);

            // 2. äºˆå®šã®è§£æã¨åæ˜ 
            const scheduleLines = scheduleRaw.split('\n');
            let addedCount = 0;
            let skippedCount = 0;
            let skippedReasons = [];
            
            scheduleLines.forEach((line, lineIdx) => {
                const trimmed = line.trim();
                if (!trimmed) return;
                
                // ã‚¿ãƒ–ãŒã‚ã‚Œã°ã‚¿ãƒ–å„ªå…ˆã€ãªã‘ã‚Œã°ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²
                const cols = trimmed.includes('\t') 
                    ? trimmed.split('\t').map(c => c.trim())
                    : trimmed.split(/\s+/);
                
                if (cols.length < 3) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: åˆ—æ•°ä¸è¶³ (${cols.length}åˆ—)`);
                    return;
                }

                // åˆ—ã‚ºãƒ¬ã®è‡ªå‹•æ¤œçŸ¥
                let dateIdx, endIdx, officeIdx;

                if (parseDate(cols[0])) {
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³A: æ—¥ä»˜ãŒå…ˆé ­ (Båˆ—, Cåˆ—, Dåˆ— ã®ã¿ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸå ´åˆ)
                    dateIdx = 0;
                    endIdx = 1;
                    officeIdx = 2;
                } else if (parseDate(cols[1])) {
                    // ãƒ‘ã‚¿ãƒ¼ãƒ³B: IDãŒå…ˆé ­ (Aåˆ—, Båˆ—, Cåˆ—, Dåˆ— ã‚’ã‚³ãƒ”ãƒ¼ã—ãŸå ´åˆ)
                    dateIdx = 1;
                    endIdx = 2;
                    officeIdx = 3;
                } else {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚‰ãªã„ (${cols.slice(0, 3).join(', ')})`);
                    return; // æ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚‰ãªã„è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
                }

                // æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹
                const startDateStr = parseDate(cols[dateIdx]);
                const endDateStr = parseDate(cols[endIdx]);
                const officeId = cols[officeIdx]?.trim();

                if (!startDateStr) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: é–‹å§‹æ—¥ãŒç„¡åŠ¹ (${cols[dateIdx]})`);
                    return;
                }
                if (!endDateStr) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: çµ‚äº†æ—¥ãŒç„¡åŠ¹ (${cols[endIdx]})`);
                    return;
                }
                if (!officeId) {
                    skippedCount++;
                    skippedReasons.push(`è¡Œ${lineIdx + 1}: å–¶æ¥­æ‰€IDãŒãªã„`);
                    return;
                }

                const officeName = officeMap[officeId] || 'å‡ºå¼µ';
                
                // æœŸé–“åˆ†ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å•é¡Œã‚’å›é¿ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
                const start = toLocalDate(startDateStr);
                const end = toLocalDate(endDateStr);
                
                // æ—¥ä»˜ãƒ«ãƒ¼ãƒ—
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dateStr = toDateStr(d);
                    data.workDays[dateStr] = {
                        type: 'trip',
                        dest: officeName
                    };
                    addedCount++;
                }
            });

            saveData();
            renderAll();
            
            // çµæœè¡¨ç¤º
            const resultEl = document.getElementById('tripImportResult');
            if (addedCount > 0) {
                let msg = `âœ… ${addedCount}æ—¥åˆ†ã®å‡ºå¼µäºˆå®šã‚’ç™»éŒ²ã—ã¾ã—ãŸ`;
                if (skippedCount > 0) {
                    msg += ` (${skippedCount}è¡Œã‚¹ã‚­ãƒƒãƒ—)`;
                }
                resultEl.textContent = msg;
                resultEl.style.color = 'var(--accent-green)';
            } else {
                resultEl.textContent = `âŒ å–ã‚Šè¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ (${skippedCount}è¡Œã‚¹ã‚­ãƒƒãƒ—)`;
                resultEl.style.color = 'var(--accent-red)';
                if (skippedReasons.length > 0) {
                    console.log('ã‚¹ã‚­ãƒƒãƒ—ç†ç”±:', skippedReasons);
                    alert('å–ã‚Šè¾¼ã¿ã‚¨ãƒ©ãƒ¼:\n' + skippedReasons.slice(0, 5).join('\n') + 
                          (skippedReasons.length > 5 ? `\n... ä»–${skippedReasons.length - 5}ä»¶` : ''));
                }
            }
            
            // å…¥åŠ›æ¬„ã‚¯ãƒªã‚¢
            document.getElementById('tripScheduleData').value = '';
            document.getElementById('officeMasterData').value = '';
        }

        // ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿æ©Ÿèƒ½ (çµŒè²»)
        function importFromClipboard() {
            const rawData = document.getElementById('importData').value.trim();
            if (!rawData) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            const lines = rawData.split('\n');
            if (lines.length < 2) {
                alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }

            const headers = lines[0].split('\t').map(h => h.trim());
            
            const isRawFormat = headers.includes('è²»ç›®') && headers.includes('å†…å®¹ãƒ»åŒºé–“');
            const isProcessedFormat = headers.includes('è³¼å…¥å“');

            if (!isRawFormat && !isProcessedFormat) {
                alert('å¯¾å¿œã—ã¦ã„ã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\nã€Œè²»ç›®/å†…å®¹ãƒ»åŒºé–“ã€ã¾ãŸã¯ã€Œè³¼å…¥å“/æ³¨è¨˜ã€ãŒå«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚');
                return;
            }

            let newRecords = [];
            let duplicateRecords = [];
            let hotelRecords = []; // å®¿æ³Šå±¥æ­´ç”¨
            let skipped = 0;

            const existingKeys = new Set(
                data.expenses.map(e => `${e.date}-${e.amount}-${e.desc}`)
            );
            
            // æ—¢å­˜ã®å®¿æ³Šå±¥æ­´ã‚­ãƒ¼
            const existingHotelKeys = new Set(
                data.hotelStays.map(h => `${h.checkin}-${h.name}`)
            );

            let dateIdx, itemIdx, amountIdx, paymentIdx, noteIdx, categoryIdx, contentIdx;
            let checkinIdx = -1, checkoutIdx = -1;

            if (isRawFormat) {
                dateIdx = headers.indexOf('æ—¥ä»˜');
                categoryIdx = headers.indexOf('è²»ç›®');
                paymentIdx = headers.indexOf('æ”¯æ‰•ç¨®åˆ¥');
                contentIdx = headers.indexOf('å†…å®¹ãƒ»åŒºé–“');
                amountIdx = headers.indexOf('é‡‘é¡');
                // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆåˆ—ã‚’æ¢ã™
                checkinIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³') || h.includes('IN'));
                checkoutIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ') || h.includes('OUT'));
            } else {
                dateIdx = headers.findIndex(h => h.includes('æ—¥ä»˜'));
                itemIdx = headers.findIndex(h => h.includes('è³¼å…¥å“'));
                amountIdx = headers.findIndex(h => h.includes('é‡‘é¡'));
                paymentIdx = headers.findIndex(h => h.includes('ä½¿ç”¨'));
                noteIdx = headers.findIndex(h => h.includes('æ³¨è¨˜'));
                // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆåˆ—ã‚’æ¢ã™
                checkinIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³') || h.includes('IN'));
                checkoutIdx = headers.findIndex(h => h.includes('ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ') || h.includes('OUT'));
            }

            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split('\t');
                if (cols.length < 3) continue;

                const dateRaw = cols[dateIdx]?.trim();
                let dateStr = parseDate(dateRaw);
                if (!dateStr) { skipped++; continue; }

                const amountRaw = cols[amountIdx]?.trim() || '0';
                const amount = parseInt(amountRaw.replace(/[Â¥,]/g, ''));
                if (isNaN(amount) || amount === 0) { skipped++; continue; }

                const paymentRaw = cols[paymentIdx]?.trim() || '';
                const paymentType = paymentRaw.includes('æ³•äºº') ? 'æ³•äººã‚«ãƒ¼ãƒ‰' : 'å€‹äººç«‹æ›¿';

                let category = 'other';
                let desc = '';
                let hotelName = '';

                if (isRawFormat) {
                    const rawContent = cols[contentIdx]?.trim() || '';
                    const rawCategory = cols[categoryIdx]?.trim() || '';

                    if (rawCategory === 'äº¤é€šè²»') category = 'transport';
                    else if (rawCategory === 'å®¿æ³Šè²»') category = 'hotel';
                    else if (rawCategory === 'ä¼šè­°è²»') category = 'entertainment';
                    else category = 'other';

                    if (rawContent.includes('@')) {
                        const parts = rawContent.split('@');
                        const item = parts[0];
                        const note = parts[1];
                        desc = `${item} (${note})`;
                        hotelName = item;
                    } else {
                        desc = rawContent;
                        hotelName = rawContent;
                    }

                } else {
                    const item = cols[itemIdx]?.trim() || '';
                    const note = cols[noteIdx]?.trim() || '';
                    
                    if (item.match(/æ–°å¹¹ç·š|ç‰¹æ€¥|é›»è»Š|ã‚¿ã‚¯ã‚·ãƒ¼|ãƒã‚¹|ãƒ•ãƒ©ã‚¤ãƒˆ|èˆªç©ºåˆ¸/)) category = 'transport';
                    else if (item.match(/ãƒ›ãƒ†ãƒ«|å®¿æ³Š|ã‚¤ãƒ³|ã‚¢ãƒ‘|æ±æ¨ª/)) category = 'hotel';
                    else if (item.match(/æ‰‹å½“|æ—¥å½“/)) category = 'allowance';
                    else if (item.match(/é£²é£Ÿ|ä¼šé£Ÿ|æ˜¼é£Ÿ|å¤•é£Ÿ/)) category = 'entertainment';

                    desc = note ? `${item} (${note})` : item;
                    hotelName = item;
                }

                const record = {
                    date: dateStr,
                    category: category,
                    desc: desc,
                    amount: amount,
                    paymentType: paymentType
                };

                const key = `${dateStr}-${amount}-${desc}`;
                if (existingKeys.has(key)) {
                    duplicateRecords.push(record);
                } else {
                    newRecords.push(record);
                }
                
                // å®¿æ³Šè²»ã®å ´åˆã€å®¿æ³Šå±¥æ­´ã«è¿½åŠ 
                if (category === 'hotel' && hotelName) {
                    let checkinDate = dateStr;
                    let checkoutDate = '';
                    
                    // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ãƒ»ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆåˆ—ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                    if (checkinIdx >= 0 && cols[checkinIdx]) {
                        const parsedCheckin = parseDate(cols[checkinIdx]?.trim());
                        if (parsedCheckin) checkinDate = parsedCheckin;
                    }
                    if (checkoutIdx >= 0 && cols[checkoutIdx]) {
                        const parsedCheckout = parseDate(cols[checkoutIdx]?.trim());
                        if (parsedCheckout) checkoutDate = parsedCheckout;
                    }
                    
                    const hotelKey = `${checkinDate}-${hotelName}`;
                    if (!existingHotelKeys.has(hotelKey)) {
                        const area = guessArea(hotelName);
                        hotelRecords.push({
                            checkin: checkinDate,
                            checkout: checkoutDate,
                            name: hotelName,
                            area: area,
                            price: amount,
                            access: '',
                            room: '',
                            food: '',
                            memo: ''
                        });
                        existingHotelKeys.add(hotelKey);
                    }
                }
            }

            if (newRecords.length === 0 && duplicateRecords.length === 0) {
                document.getElementById('importResult').textContent = `å–ã‚Šè¾¼ã¿å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ(ã‚¹ã‚­ãƒƒãƒ—: ${skipped}ä»¶)`;
                document.getElementById('importResult').style.color = 'var(--accent-orange)';
                return;
            }

            let finalImportList = [...newRecords];
            let msg = `æ–°è¦ãƒ‡ãƒ¼ã‚¿: ${newRecords.length}ä»¶\n`;
            
            if (duplicateRecords.length > 0) {
                if (confirm(`${duplicateRecords.length}ä»¶ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ï¼ˆåŒæ—¥ãƒ»åŒé¡ãƒ»åŒå†…å®¹ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\nã“ã‚Œã‚‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ\n\n[OK] = é‡è¤‡ã¯ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹\n[ã‚­ãƒ£ãƒ³ã‚»ãƒ«] = é‡è¤‡ã‚‚å«ã‚ã¦å…¨ã¦å–ã‚Šè¾¼ã‚€`)) {
                     msg += `é‡è¤‡ã‚¹ã‚­ãƒƒãƒ—: ${duplicateRecords.length}ä»¶`;
                } else {
                    finalImportList = finalImportList.concat(duplicateRecords);
                    msg += `é‡è¤‡å–ã‚Šè¾¼ã¿: ${duplicateRecords.length}ä»¶`;
                }
            }

            finalImportList.forEach(r => data.expenses.push(r));
            
            // å®¿æ³Šå±¥æ­´ã«è¿½åŠ 
            if (hotelRecords.length > 0) {
                hotelRecords.forEach(h => data.hotelStays.push(h));
                data.hotelStays.sort((a, b) => b.checkin.localeCompare(a.checkin));
                msg += `\nå®¿æ³Šå±¥æ­´: ${hotelRecords.length}ä»¶è¿½åŠ `;
            }
            
            saveData();
            renderAll();

            document.getElementById('importResult').textContent = `âœ… å–ã‚Šè¾¼ã¿å®Œäº† (${msg})`;
            document.getElementById('importResult').style.color = 'var(--accent-green)';
            document.getElementById('importData').value = '';
            
            if (finalImportList.length > 0) {
                const preview = finalImportList.slice(0, 5).map(e => 
                    `${e.date} | ${getCategoryLabel(e.category)} | ${e.desc} | Â¥${e.amount.toLocaleString()}`
                ).join('<br>');
                document.getElementById('importPreview').style.display = 'block';
                document.getElementById('importPreviewContent').innerHTML = preview + 
                    (finalImportList.length > 5 ? `<br>... ä»– ${finalImportList.length - 5}ä»¶` : '');
            }
        }

        // ========== ä¼šç¤¾ã‚¤ãƒ™ãƒ³ãƒˆæ©Ÿèƒ½ ==========
        function getEventTypeLabel(type) {
            const labels = {
                'meeting': 'ğŸ—“ï¸ ä¼šè­°',
                'training': 'ğŸ“š ç ”ä¿®',
                'ceremony': 'ğŸ‰ å¼å…¸',
                'party': 'ğŸ» æ‡‡è¦ªä¼š',
                'other': 'ğŸ“ ãã®ä»–'
            };
            return labels[type] || type;
        }

        function saveEvent() {
            const date = document.getElementById('eventDate').value;
            const type = document.getElementById('eventType').value;
            const name = document.getElementById('eventName').value;
            const location = document.getElementById('eventLocation').value;
            const memo = document.getElementById('eventMemo').value;

            if (!date || !name) {
                alert('æ—¥ä»˜ã¨ã‚¤ãƒ™ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            data.events.push({ date, type, name, location, memo });
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('eventName').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventMemo').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        function renderEventTable() {
            const tbody = document.getElementById('eventTableBody');
            if (!data.events || data.events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-muted);">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // ã‚½ãƒ¼ãƒˆ
            const { key, order } = sortState.event;
            const sortedEvents = [...data.events].sort((a, b) => {
                let valA = a[key] || '';
                let valB = b[key] || '';
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
            updateSortHeaders('event', key, order);

            tbody.innerHTML = sortedEvents.map((e) => {
                const globalIndex = data.events.indexOf(e);
                return `
                <tr style="cursor: pointer;" onclick="openEventDetailModal(${globalIndex})">
                    <td onclick="event.stopPropagation();"><input type="checkbox" class="event-checkbox" data-index="${globalIndex}"></td>
                    <td>${formatDate(e.date)}</td>
                    <td>${getEventTypeLabel(e.type)}</td>
                    <td>${e.name}</td>
                    <td>${e.location || '-'}</td>
                    <td>${e.memo || '-'}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="delete-btn" onclick="duplicateEvent(${globalIndex})" title="è¤‡è£½" style="margin-right: 4px;">ğŸ“‹</button>
                        <button class="delete-btn" onclick="deleteEvent(${globalIndex})" title="å‰Šé™¤">âœ•</button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
        function sortEventTable(key) {
            if (sortState.event.key === key) {
                sortState.event.order = sortState.event.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.event.key = key;
                sortState.event.order = 'asc';
            }
            renderEventTable();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEventDetailModal(index) {
            const e = data.events[index];
            if (!e) return;
            
            document.getElementById('eventDetailIndex').value = index;
            document.getElementById('eventDetailDate').value = e.date || '';
            document.getElementById('eventDetailType').value = e.type || 'meeting';
            document.getElementById('eventDetailName').value = e.name || '';
            document.getElementById('eventDetailLocation').value = e.location || '';
            document.getElementById('eventDetailMemo').value = e.memo || '';
            
            document.getElementById('eventDetailModal').classList.add('active');
        }
        
        function closeEventDetailModal() {
            document.getElementById('eventDetailModal').classList.remove('active');
        }
        
        function saveEventDetail() {
            const index = parseInt(document.getElementById('eventDetailIndex').value);
            if (isNaN(index)) return;
            
            data.events[index] = {
                date: document.getElementById('eventDetailDate').value,
                type: document.getElementById('eventDetailType').value,
                name: document.getElementById('eventDetailName').value,
                location: document.getElementById('eventDetailLocation').value,
                memo: document.getElementById('eventDetailMemo').value
            };
            
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();
            renderCalendar();
            closeEventDetailModal();
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        function deleteEventFromModal() {
            const index = parseInt(document.getElementById('eventDetailIndex').value);
            if (isNaN(index)) return;
            
            if (confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.events.splice(index, 1);
                saveData();
                renderEventTable();
                renderCalendar();
                closeEventDetailModal();
            }
        }
        
        function duplicateEventFromModal() {
            const index = parseInt(document.getElementById('eventDetailIndex').value);
            if (isNaN(index)) return;
            
            const original = data.events[index];
            const newEvent = { ...original };
            data.events.push(newEvent);
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();
            renderCalendar();
            closeEventDetailModal();
            alert('è¤‡è£½ã—ã¾ã—ãŸï¼ˆä¸€è¦§ã«è¿½åŠ ï¼‰');
        }

        function deleteEvent(index) {
            if (confirm('ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.events.splice(index, 1);
                saveData();
                renderEventTable();
                renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚æ›´æ–°
            }
        }
        
        function duplicateEvent(index) {
            const original = data.events[index];
            if (!original) return;
            
            const newEvent = { ...original };
            data.events.push(newEvent);
            data.events.sort((a, b) => a.date.localeCompare(b.date));
            saveData();
            renderEventTable();
            renderCalendar();
            alert('è¤‡è£½ã—ã¾ã—ãŸ');
        }

        function selectAllEvents() {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('eventSelectAll').checked = true;
        }

        function deselectAllEvents() {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('eventSelectAll').checked = false;
        }

        function toggleAllEventCheckboxes(headerCheckbox) {
            document.querySelectorAll('.event-checkbox').forEach(cb => cb.checked = headerCheckbox.checked);
        }

        function deleteSelectedEvents() {
            const checkedBoxes = document.querySelectorAll('.event-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!confirm(`${checkedBoxes.length}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            const indices = Array.from(checkedBoxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            indices.forEach(idx => data.events.splice(idx, 1));
            saveData();
            renderEventTable();
            alert(`${checkedBoxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        // ========== å®¿æ³Šå±¥æ­´æ©Ÿèƒ½ ==========
        function saveHotelHistory() {
            const checkin = document.getElementById('hotelCheckin').value;
            const checkout = document.getElementById('hotelCheckout').value;
            const name = document.getElementById('hotelNameInput').value;
            const area = document.getElementById('hotelArea').value;
            const price = parseInt(document.getElementById('hotelPrice').value) || 0;
            const access = document.getElementById('hotelAccess').value;
            const room = document.getElementById('hotelRoom').value;
            const food = document.getElementById('hotelFood').value;
            const memo = document.getElementById('hotelMemo').value;

            if (!checkin || !name) {
                alert('ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ—¥ã¨ãƒ›ãƒ†ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            data.hotelStays.push({ checkin, checkout, name, area, price, access, room, food, memo });
            data.hotelStays.sort((a, b) => b.checkin.localeCompare(a.checkin)); // æ–°ã—ã„é †
            saveData();
            renderHotelTable();

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('hotelNameInput').value = '';
            document.getElementById('hotelArea').value = '';
            document.getElementById('hotelPrice').value = '';
            document.getElementById('hotelAccess').value = '';
            document.getElementById('hotelRoom').value = '';
            document.getElementById('hotelFood').value = '';
            document.getElementById('hotelMemo').value = '';
            alert('ç™»éŒ²ã—ã¾ã—ãŸ');
        }

        // å®¿æ³Šå±¥æ­´ã®ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importHotelHistory() {
            const rawData = document.getElementById('hotelImportData').value.trim();
            if (!rawData) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
                return;
            }

            const lines = rawData.split('\n');
            let imported = 0;
            let skipped = 0;
            let currentHotel = null;
            let currentCheckin = null;

            // é€£ç¶šã™ã‚‹åŒã˜ãƒ›ãƒ†ãƒ«ã‚’ã¾ã¨ã‚ã‚‹å‡¦ç†
            const stays = [];

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;

                // ã‚¿ãƒ–åŒºåˆ‡ã‚Šã¾ãŸã¯ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Š
                const parts = trimmed.includes('\t') ? trimmed.split('\t') : trimmed.split(/\s{2,}/);
                if (parts.length < 1) return;

                // æ—¥ä»˜ã‚’æŠ½å‡º (2024/6/10(æœˆ) ãªã©)
                const dateMatch = parts[0].match(/(\d{4})\/(\d{1,2})\/(\d{1,2})/);
                if (!dateMatch) {
                    skipped++;
                    return;
                }

                const dateStr = `${dateMatch[1]}-${dateMatch[2].padStart(2, '0')}-${dateMatch[3].padStart(2, '0')}`;
                const hotelName = parts[1]?.trim().replace(/^["ã€€]+|["ã€€]+$/g, '') || '';

                if (!hotelName) {
                    // ãƒ›ãƒ†ãƒ«åãŒç©ºã®æ—¥ã¯ã€å‰ã®ãƒ›ãƒ†ãƒ«ãŒãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ãŸã¨ã¿ãªã™
                    if (currentHotel && currentCheckin) {
                        // å‰æ—¥ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ—¥ã¨ã—ã¦ä¿å­˜
                        stays.push({
                            checkin: currentCheckin,
                            checkout: currentCheckin, // å˜æ³Šã®å ´åˆ
                            name: currentHotel,
                            area: guessArea(currentHotel),
                            stayCount: 1
                        });
                        currentHotel = null;
                        currentCheckin = null;
                    }
                    return;
                }

                // æ–°ã—ã„ãƒ›ãƒ†ãƒ«ã¾ãŸã¯é•ã†ãƒ›ãƒ†ãƒ«
                if (currentHotel !== hotelName) {
                    // å‰ã®ãƒ›ãƒ†ãƒ«ã‚’ä¿å­˜
                    if (currentHotel && currentCheckin) {
                        stays.push({
                            checkin: currentCheckin,
                            checkout: dateStr,
                            name: currentHotel,
                            area: guessArea(currentHotel)
                        });
                    }
                    currentHotel = hotelName;
                    currentCheckin = dateStr;
                }
            });

            // æœ€å¾Œã®ãƒ›ãƒ†ãƒ«ã‚’ä¿å­˜
            if (currentHotel && currentCheckin) {
                stays.push({
                    checkin: currentCheckin,
                    checkout: currentCheckin,
                    name: currentHotel,
                    area: guessArea(currentHotel)
                });
            }

            // é€£ç¶šã™ã‚‹åŒã˜ãƒ›ãƒ†ãƒ«ã‚’ãƒãƒ¼ã‚¸
            const mergedStays = [];
            stays.forEach(stay => {
                const last = mergedStays[mergedStays.length - 1];
                if (last && last.name === stay.name && last.checkout === stay.checkin) {
                    last.checkout = stay.checkout;
                } else {
                    mergedStays.push({ ...stay });
                }
            });

            // ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
            mergedStays.forEach(stay => {
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const exists = data.hotelStays.some(h => 
                    h.checkin === stay.checkin && h.name === stay.name
                );
                if (!exists) {
                    data.hotelStays.push(stay);
                    imported++;
                } else {
                    skipped++;
                }
            });

            data.hotelStays.sort((a, b) => b.checkin.localeCompare(a.checkin));
            saveData();
            renderHotelTable();

            const resultEl = document.getElementById('hotelImportResult');
            resultEl.textContent = `âœ… ${imported}ä»¶ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ${skipped > 0 ? `ï¼ˆ${skipped}ä»¶ã‚¹ã‚­ãƒƒãƒ—ï¼‰` : ''}`;
            resultEl.style.color = imported > 0 ? 'var(--accent-green)' : 'var(--accent-orange)';
            document.getElementById('hotelImportData').value = '';
        }

        // ãƒ›ãƒ†ãƒ«åã‹ã‚‰ã‚¨ãƒªã‚¢ã‚’æ¨æ¸¬
        function guessArea(hotelName) {
            const areaMap = {
                'æ¨ªæµœ': 'æ¨ªæµœ', 'æ–°æ¨ªæµœ': 'æ¨ªæµœ', 'æ¡œæœ¨ç”º': 'æ¨ªæµœ', 'é–¢å†…': 'æ¨ªæµœ', 'ã‚»ãƒ³ã‚¿ãƒ¼å—': 'æ¨ªæµœ',
                'ä»™å°': 'ä»™å°',
                'å²¡å±±': 'å²¡å±±',
                'åå¤å±‹': 'åå¤å±‹', 'æ „': 'åå¤å±‹', 'ç´å±‹æ©‹': 'åå¤å±‹',
                'åšå¤š': 'ç¦å²¡', 'ç¦å²¡': 'ç¦å²¡', 'å¤©ç¥': 'ç¦å²¡',
                'å¤§é˜ª': 'å¤§é˜ª', 'æ–°å¤§é˜ª': 'å¤§é˜ª', 'å º': 'å¤§é˜ª',
                'æœ­å¹Œ': 'æœ­å¹Œ',
                'å½¦æ ¹': 'å½¦æ ¹', 'è¿‘æ±Ÿå…«å¹¡': 'æ»‹è³€',
                'å¿—æœ¨': 'åŸ¼ç‰', 'æµ¦å’Œ': 'åŸ¼ç‰',
                'æµå±±': 'åƒè‘‰',
                'ä¸Šé‡': 'æ±äº¬', 'æ—¥æœ¬æ©‹': 'æ±äº¬', 'æ°´é“æ©‹': 'æ±äº¬', 'äººå½¢ç”º': 'æ±äº¬'
            };
            for (const [keyword, area] of Object.entries(areaMap)) {
                if (hotelName.includes(keyword)) return area;
            }
            return '';
        }

        function renderHotelTable() {
            const tbody = document.getElementById('hotelTableBody');
            const filterArea = document.getElementById('hotelFilterArea').value;

            if (!data.hotelStays) data.hotelStays = [];

            // ã‚¨ãƒªã‚¢ãƒ•ã‚£ãƒ«ã‚¿ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
            const areas = [...new Set(data.hotelStays.map(h => h.area).filter(a => a))];
            const filterSelect = document.getElementById('hotelFilterArea');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '<option value="">å…¨ã‚¨ãƒªã‚¢</option>' + 
                areas.map(a => `<option value="${a}"${a === currentFilter ? ' selected' : ''}>${a}</option>`).join('');

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filtered = [...data.hotelStays];
            if (filterArea) {
                filtered = filtered.filter(h => h.area === filterArea);
            }

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted);">å®¿æ³Šå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }
            
            // æ³Šæ•°ã¨è©•ä¾¡ã‚’è¨ˆç®—ã—ã¦è¿½åŠ 
            filtered = filtered.map(h => {
                let nights = 1;
                if (h.checkout && h.checkout !== h.checkin) {
                    const checkinDate = new Date(h.checkin);
                    const checkoutDate = new Date(h.checkout);
                    nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                }
                const ratings = [h.access, h.room, h.food].filter(r => r).map(Number);
                const avgRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length) : 0;
                return { ...h, nights, avgRating };
            });
            
            // ã‚½ãƒ¼ãƒˆ
            const { key, order } = sortState.hotel;
            filtered.sort((a, b) => {
                let valA, valB;
                if (key === 'nights') {
                    valA = a.nights;
                    valB = b.nights;
                } else if (key === 'price') {
                    valA = Number(a.price) || 0;
                    valB = Number(b.price) || 0;
                } else if (key === 'rating') {
                    valA = a.avgRating;
                    valB = b.avgRating;
                } else {
                    valA = a[key] || '';
                    valB = b[key] || '';
                }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });
            
            // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®è¡¨ç¤ºæ›´æ–°
            updateSortHeaders('hotel', key, order);

            tbody.innerHTML = filtered.map((h) => {
                const globalIndex = data.hotelStays.findIndex(orig => 
                    orig.checkin === h.checkin && orig.name === h.name && orig.checkout === h.checkout
                );
                const ratingDisplay = h.avgRating > 0 ? h.avgRating.toFixed(1) : '-';
                
                // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€œãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’è¡¨ç¤º
                const dateLabel = h.checkout && h.checkout !== h.checkin 
                    ? `${formatDate(h.checkin)}ã€œ${formatDate(h.checkout)}`
                    : formatDate(h.checkin);
                
                // é‡‘é¡è¡¨ç¤º
                const priceDisplay = h.price ? `Â¥${Number(h.price).toLocaleString()}` : '-';
                
                return `
                <tr style="cursor: pointer;" onclick="openHotelDetailModal(${globalIndex})">
                    <td onclick="event.stopPropagation();"><input type="checkbox" class="hotel-checkbox" data-index="${globalIndex}"></td>
                    <td>${dateLabel}</td>
                    <td>${h.name}</td>
                    <td>${h.area || '-'}</td>
                    <td style="text-align: center;">${h.nights}æ³Š</td>
                    <td class="amount">${priceDisplay}</td>
                    <td style="text-align: center; color: #fbbf24;">${ratingDisplay}</td>
                    <td onclick="event.stopPropagation();">
                        <button class="delete-btn" onclick="duplicateHotelStayByIndex(${globalIndex})" title="è¤‡è£½" style="margin-right: 4px;">ğŸ“‹</button>
                        <button class="delete-btn" onclick="deleteHotelStay(${globalIndex})" title="å‰Šé™¤">âœ•</button>
                    </td>
                </tr>
            `}).join('');

            // ã‚¯ã‚¤ãƒƒã‚¯å±¥æ­´è¡¨ç¤º
            const quickHistory = document.getElementById('hotelHistoryQuick');
            const uniqueHotels = [...new Map(data.hotelStays.map(h => [h.name, h])).values()].slice(0, 10);
            quickHistory.innerHTML = uniqueHotels.map(h => 
                `<div class="history-item" onclick="fillHotelHistory('${h.name}', '${h.area || ''}')">${h.name}${h.area ? ` (${h.area})` : ''}</div>`
            ).join('');
        }
        
        // å®¿æ³Šãƒ†ãƒ¼ãƒ–ãƒ«ã‚½ãƒ¼ãƒˆ
        function sortHotelTable(key) {
            if (sortState.hotel.key === key) {
                sortState.hotel.order = sortState.hotel.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.hotel.key = key;
                sortState.hotel.order = key === 'checkin' ? 'desc' : 'asc';
            }
            renderHotelTable();
        }

        // å®¿æ³Šå±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openHotelDetailModal(index) {
            const h = data.hotelStays[index];
            if (!h) return;
            
            document.getElementById('hotelDetailIndex').value = index;
            document.getElementById('hotelDetailCheckin').value = h.checkin || '';
            document.getElementById('hotelDetailCheckout').value = h.checkout || '';
            document.getElementById('hotelDetailName').value = h.name || '';
            document.getElementById('hotelDetailArea').value = h.area || '';
            document.getElementById('hotelDetailPrice').value = h.price || '';
            document.getElementById('hotelDetailAccess').value = h.access || '';
            document.getElementById('hotelDetailRoom').value = h.room || '';
            document.getElementById('hotelDetailFood').value = h.food || '';
            document.getElementById('hotelDetailMemo').value = h.memo || '';
            
            document.getElementById('hotelDetailModal').classList.add('active');
        }
        
        function closeHotelDetailModal() {
            document.getElementById('hotelDetailModal').classList.remove('active');
        }
        
        function saveHotelDetail() {
            const index = parseInt(document.getElementById('hotelDetailIndex').value);
            if (isNaN(index)) return;
            
            data.hotelStays[index] = {
                checkin: document.getElementById('hotelDetailCheckin').value,
                checkout: document.getElementById('hotelDetailCheckout').value,
                name: document.getElementById('hotelDetailName').value,
                area: document.getElementById('hotelDetailArea').value,
                price: parseInt(document.getElementById('hotelDetailPrice').value) || 0,
                access: document.getElementById('hotelDetailAccess').value,
                room: document.getElementById('hotelDetailRoom').value,
                food: document.getElementById('hotelDetailFood').value,
                memo: document.getElementById('hotelDetailMemo').value
            };
            
            saveData();
            renderHotelTable();
            closeHotelDetailModal();
            alert('ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        function deleteHotelStayFromModal() {
            const index = parseInt(document.getElementById('hotelDetailIndex').value);
            if (isNaN(index)) return;
            
            if (confirm('ã“ã®å®¿æ³Šå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.hotelStays.splice(index, 1);
                saveData();
                renderHotelTable();
                closeHotelDetailModal();
            }
        }
        
        function duplicateHotelStay() {
            const index = parseInt(document.getElementById('hotelDetailIndex').value);
            if (isNaN(index)) return;
            
            const original = data.hotelStays[index];
            const newStay = { ...original };
            data.hotelStays.unshift(newStay);
            saveData();
            renderHotelTable();
            closeHotelDetailModal();
            alert('è¤‡è£½ã—ã¾ã—ãŸï¼ˆä¸€è¦§ã®å…ˆé ­ã«è¿½åŠ ï¼‰');
        }
        
        function duplicateHotelStayByIndex(index) {
            const original = data.hotelStays[index];
            if (!original) return;
            
            const newStay = { ...original };
            data.hotelStays.unshift(newStay);
            saveData();
            renderHotelTable();
            alert('è¤‡è£½ã—ã¾ã—ãŸ');
        }

        function fillHotelHistory(name, area) {
            document.getElementById('hotelNameInput').value = name;
            document.getElementById('hotelArea').value = area;
        }

        function deleteHotelStay(index) {
            event.stopPropagation();
            if (confirm('ã“ã®å®¿æ³Šå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                data.hotelStays.splice(index, 1);
                saveData();
                renderHotelTable();
            }
        }

        function selectAllHotels() {
            document.querySelectorAll('.hotel-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('hotelSelectAll').checked = true;
        }

        function deselectAllHotels() {
            document.querySelectorAll('.hotel-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('hotelSelectAll').checked = false;
        }

        function toggleAllHotelCheckboxes(headerCheckbox) {
            document.querySelectorAll('.hotel-checkbox').forEach(cb => cb.checked = headerCheckbox.checked);
        }

        function deleteSelectedHotels() {
            const checkedBoxes = document.querySelectorAll('.hotel-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            if (!confirm(`${checkedBoxes.length}ä»¶ã®å®¿æ³Šå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            const indices = Array.from(checkedBoxes)
                .map(cb => parseInt(cb.dataset.index))
                .sort((a, b) => b - a);
            indices.forEach(idx => data.hotelStays.splice(idx, 1));
            saveData();
            renderHotelTable();
            alert(`${checkedBoxes.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }

        // ===== å¹´é–“ã‚µãƒãƒªãƒ¼ =====
        
        function changeAnnualYear(delta) {
            annualYear += delta;
            document.getElementById('annualYear').textContent = `${annualYear}å¹´`;
            renderAnnualSummary();
        }
        
        function renderAnnualSummary() {
            document.getElementById('annualYear').textContent = `${annualYear}å¹´`;
            
            // å¹´é–“é›†è¨ˆ
            let totalWorkDays = 0;
            let totalTripDays = 0;
            let totalPaidLeave = 0;
            let totalExpense = 0;
            
            // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿
            const monthlyWork = Array(12).fill(null).map(() => ({ office: 0, remote: 0, trip: 0, paidLeave: 0 }));
            const monthlyExpense = Array(12).fill(null).map(() => ({ transport: 0, hotel: 0, allowance: 0, entertainment: 0, other: 0 }));
            
            // å‡ºå¼µå…ˆã‚«ã‚¦ãƒ³ãƒˆ
            const tripDestCount = {};
            
            // å‹¤å‹™ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
            Object.entries(data.workDays).forEach(([date, info]) => {
                if (!date.startsWith(String(annualYear))) return;
                const month = parseInt(date.split('-')[1]) - 1;
                
                if (info.type === 'split') {
                    // åˆå‰/åˆå¾Œåˆ¥
                    if (info.amType === 'office') monthlyWork[month].office += 0.5;
                    else if (info.amType === 'remote') monthlyWork[month].remote += 0.5;
                    else if (info.amType === 'trip') { monthlyWork[month].trip += 0.5; if (info.amDest) tripDestCount[info.amDest] = (tripDestCount[info.amDest] || 0) + 0.5; }
                    else if (isPaidLeaveType(info.amType)) monthlyWork[month].paidLeave += 0.5;
                    
                    if (info.pmType === 'office') monthlyWork[month].office += 0.5;
                    else if (info.pmType === 'remote') monthlyWork[month].remote += 0.5;
                    else if (info.pmType === 'trip') { monthlyWork[month].trip += 0.5; if (info.pmDest) tripDestCount[info.pmDest] = (tripDestCount[info.pmDest] || 0) + 0.5; }
                    else if (isPaidLeaveType(info.pmType)) monthlyWork[month].paidLeave += 0.5;
                } else {
                    if (info.type === 'office') monthlyWork[month].office++;
                    else if (info.type === 'remote') monthlyWork[month].remote++;
                    else if (info.type === 'trip') { monthlyWork[month].trip++; if (info.dest) tripDestCount[info.dest] = (tripDestCount[info.dest] || 0) + 1; }
                    else if (isPaidLeaveType(info.type)) monthlyWork[month].paidLeave++;
                }
            });
            
            // çµŒè²»ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
            data.expenses.forEach(e => {
                if (!e.date.startsWith(String(annualYear))) return;
                const month = parseInt(e.date.split('-')[1]) - 1;
                const cat = e.category || 'other';
                monthlyExpense[month][cat] = (monthlyExpense[month][cat] || 0) + e.amount;
                totalExpense += e.amount;
            });
            
            // å¹´é–“åˆè¨ˆ
            monthlyWork.forEach(m => {
                totalWorkDays += m.office + m.remote + m.trip;
                totalTripDays += m.trip;
                totalPaidLeave += m.paidLeave;
            });
            
            // è¡¨ç¤ºæ›´æ–°
            document.getElementById('annualWorkDays').textContent = totalWorkDays;
            document.getElementById('annualTripDays').textContent = totalTripDays;
            document.getElementById('annualPaidLeave').textContent = totalPaidLeave;
            document.getElementById('annualExpense').textContent = totalExpense.toLocaleString();
            
            // æœˆåˆ¥å‹¤å‹™ã‚°ãƒ©ãƒ•
            renderMonthlyWorkChart(monthlyWork);
            
            // æœˆåˆ¥çµŒè²»ã‚°ãƒ©ãƒ•
            renderMonthlyExpenseChart(monthlyExpense);
            
            // çµŒè²»ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚°ãƒ©ãƒ•
            renderCategoryChart(monthlyExpense);
            
            // å‡ºå¼µå…ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°
            renderTripRanking(tripDestCount);
        }
        
        function renderMonthlyWorkChart(monthlyWork) {
            const maxDays = Math.max(...monthlyWork.map(m => m.office + m.remote + m.trip + m.paidLeave), 1);
            const container = document.getElementById('monthlyWorkChart');
            
            let html = '<div class="bar-chart">';
            for (let i = 0; i < 12; i++) {
                const m = monthlyWork[i];
                const total = m.office + m.remote + m.trip + m.paidLeave;
                const scale = 150 / maxDays;
                
                html += `
                    <div class="bar-group">
                        <div class="bar-value">${total}</div>
                        <div class="bar-stack">
                            <div class="bar-segment office" style="height: ${m.office * scale}px;" title="å‡ºç¤¾ ${m.office}æ—¥"></div>
                            <div class="bar-segment remote" style="height: ${m.remote * scale}px;" title="åœ¨å®… ${m.remote}æ—¥"></div>
                            <div class="bar-segment trip" style="height: ${m.trip * scale}px;" title="å‡ºå¼µ ${m.trip}æ—¥"></div>
                            <div class="bar-segment paidLeave" style="height: ${m.paidLeave * scale}px;" title="æœ‰çµ¦ ${m.paidLeave}æ—¥"></div>
                        </div>
                        <div class="bar-label">${i + 1}æœˆ</div>
                    </div>
                `;
            }
            html += '</div>';
            html += `<div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.8rem;">
                <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--accent-blue); border-radius: 2px;"></span> å‡ºç¤¾</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--accent-green); border-radius: 2px;"></span> åœ¨å®…</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--accent-orange); border-radius: 2px;"></span> å‡ºå¼µ</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: var(--accent-purple); border-radius: 2px;"></span> æœ‰çµ¦</span>
            </div>`;
            container.innerHTML = html;
        }
        
        function renderMonthlyExpenseChart(monthlyExpense) {
            const maxAmount = Math.max(...monthlyExpense.map(m => 
                Object.values(m).reduce((a, b) => a + b, 0)
            ), 1);
            const container = document.getElementById('monthlyExpenseChart');
            
            let html = '<div class="bar-chart">';
            for (let i = 0; i < 12; i++) {
                const m = monthlyExpense[i];
                const total = Object.values(m).reduce((a, b) => a + b, 0);
                const scale = 150 / maxAmount;
                
                html += `
                    <div class="bar-group">
                        <div class="bar-value">${total > 0 ? Math.round(total / 1000) + 'k' : ''}</div>
                        <div class="bar-stack">
                            <div class="bar-segment transport" style="height: ${m.transport * scale}px;"></div>
                            <div class="bar-segment hotel" style="height: ${m.hotel * scale}px;"></div>
                            <div class="bar-segment allowance" style="height: ${m.allowance * scale}px;"></div>
                            <div class="bar-segment entertainment" style="height: ${m.entertainment * scale}px;"></div>
                            <div class="bar-segment other" style="height: ${m.other * scale}px;"></div>
                        </div>
                        <div class="bar-label">${i + 1}æœˆ</div>
                    </div>
                `;
            }
            html += '</div>';
            html += `<div style="display: flex; gap: 16px; margin-top: 12px; font-size: 0.8rem; flex-wrap: wrap;">
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></span> äº¤é€šè²»</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></span> å®¿æ³Šè²»</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span> æ‰‹å½“</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #8b5cf6; border-radius: 2px;"></span> äº¤éš›è²»</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background: #6b7280; border-radius: 2px;"></span> ãã®ä»–</span>
            </div>`;
            container.innerHTML = html;
        }
        
        function renderCategoryChart(monthlyExpense) {
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆè¨ˆ
            const totals = { transport: 0, hotel: 0, allowance: 0, entertainment: 0, other: 0 };
            monthlyExpense.forEach(m => {
                Object.keys(totals).forEach(k => totals[k] += m[k]);
            });
            const grandTotal = Object.values(totals).reduce((a, b) => a + b, 0);
            
            const categories = [
                { key: 'transport', label: 'ğŸšƒ äº¤é€šè²»', color: '#3b82f6' },
                { key: 'hotel', label: 'ğŸ¨ å®¿æ³Šè²»', color: '#f59e0b' },
                { key: 'allowance', label: 'ğŸ’¼ å‡ºå¼µæ‰‹å½“', color: '#10b981' },
                { key: 'entertainment', label: 'ğŸ» äº¤éš›è²»', color: '#8b5cf6' },
                { key: 'other', label: 'ğŸ“ ãã®ä»–', color: '#6b7280' }
            ];
            
            // å††ã‚°ãƒ©ãƒ•é¢¨ã®è¡¨ç¤ºï¼ˆCSSå††ã‚°ãƒ©ãƒ•ï¼‰
            let gradientStops = [];
            let currentPercent = 0;
            categories.forEach(cat => {
                const percent = grandTotal > 0 ? (totals[cat.key] / grandTotal * 100) : 0;
                gradientStops.push(`${cat.color} ${currentPercent}% ${currentPercent + percent}%`);
                currentPercent += percent;
            });
            
            document.getElementById('categoryPieChart').innerHTML = `
                <div style="width: 180px; height: 180px; border-radius: 50%; background: conic-gradient(${gradientStops.join(', ')}); margin: 0 auto;"></div>
                <div style="text-align: center; margin-top: 12px; font-size: 1.1rem; font-weight: 600;">åˆè¨ˆ Â¥${grandTotal.toLocaleString()}</div>
            `;
            
            // å‡¡ä¾‹
            let legendHtml = '';
            categories.forEach(cat => {
                const amount = totals[cat.key];
                const percent = grandTotal > 0 ? (amount / grandTotal * 100).toFixed(1) : 0;
                legendHtml += `
                    <div class="pie-legend-item">
                        <div class="pie-legend-color" style="background: ${cat.color};"></div>
                        <div class="pie-legend-label">${cat.label}</div>
                        <div class="pie-legend-value">Â¥${amount.toLocaleString()}</div>
                        <div class="pie-legend-percent">${percent}%</div>
                    </div>
                `;
            });
            document.getElementById('categoryLegend').innerHTML = legendHtml;
        }
        
        function renderTripRanking(tripDestCount) {
            const sorted = Object.entries(tripDestCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (sorted.length === 0) {
                document.getElementById('tripRanking').innerHTML = '<p style="color: var(--text-muted);">å‡ºå¼µãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '';
            sorted.forEach(([dest, count], i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : 'normal';
                html += `
                    <div class="ranking-item">
                        <div class="ranking-rank ${rankClass}">${i + 1}</div>
                        <div class="ranking-dest">${dest}</div>
                        <div class="ranking-count">${count}æ—¥</div>
                    </div>
                `;
            });
            document.getElementById('tripRanking').innerHTML = html;
        }

        // ===== ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ =====
        
        function generateTemplateDayInputs() {
            const days = parseInt(document.getElementById('templateDays').value) || 1;
            const container = document.getElementById('templateDayInputs');
            
            let html = '';
            for (let i = 0; i < days; i++) {
                html += `
                    <div style="margin: 12px 0; padding: 12px; background: var(--bg-card); border-radius: 8px;">
                        <div style="font-weight: 500; margin-bottom: 8px;">${i + 1}æ—¥ç›®</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>å‹¤å‹™ã‚¿ã‚¤ãƒ—</label>
                                <select id="templateDayType${i}">
                                    <option value="office">å‡ºç¤¾(äº¬æ©‹)</option>
                                    <option value="remote">åœ¨å®…</option>
                                    <option value="trip">å‡ºå¼µ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>å‡ºå¼µå…ˆï¼ˆå‡ºå¼µã®å ´åˆï¼‰</label>
                                <input type="text" id="templateDayDest${i}" placeholder="ä¾‹:ä»™å°">
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }
        
        function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            if (!name) {
                alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const days = parseInt(document.getElementById('templateDays').value) || 1;
            const dayData = [];
            
            for (let i = 0; i < days; i++) {
                const typeEl = document.getElementById(`templateDayType${i}`);
                const destEl = document.getElementById(`templateDayDest${i}`);
                if (typeEl) {
                    dayData.push({
                        type: typeEl.value,
                        dest: destEl?.value || ''
                    });
                }
            }
            
            if (dayData.length === 0) {
                alert('å…¥åŠ›æ¬„ã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!data.templates) data.templates = [];
            data.templates.push({ name, days: dayData });
            saveData();
            renderTemplateList();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('templateName').value = '';
            document.getElementById('templateDays').value = '1';
            document.getElementById('templateDayInputs').innerHTML = '';
            
            alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        function renderTemplateList() {
            const container = document.getElementById('templateList');
            if (!data.templates || data.templates.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem;">ä¿å­˜æ¸ˆã¿ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            let html = '';
            data.templates.forEach((t, i) => {
                const badgesHtml = t.days.map((d, j) => {
                    const label = d.type === 'office' ? 'å‡ºç¤¾' : d.type === 'remote' ? 'åœ¨å®…' : d.dest || 'å‡ºå¼µ';
                    const color = d.type === 'office' ? 'var(--accent-blue)' : d.type === 'remote' ? 'var(--accent-green)' : 'var(--accent-orange)';
                    return `<span class="template-day-badge" style="border-left: 3px solid ${color};">${j + 1}æ—¥ç›®: ${label}</span>`;
                }).join('');
                
                html += `
                    <div class="template-card">
                        <div class="template-header">
                            <span class="template-name">${t.name}</span>
                            <button class="btn btn-danger" onclick="deleteTemplate(${i})" style="font-size: 0.75rem; padding: 4px 8px;">å‰Šé™¤</button>
                        </div>
                        <div class="template-days">${badgesHtml}</div>
                        <div style="margin-top: 12px;">
                            <label style="font-size: 0.85rem; color: var(--text-secondary);">é–‹å§‹æ—¥:</label>
                            <input type="date" id="templateStartDate${i}" style="margin: 0 8px;">
                            <button class="btn btn-primary" onclick="applyTemplate(${i})" style="font-size: 0.8rem; padding: 6px 12px;">é©ç”¨</button>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        function applyTemplate(index) {
            const template = data.templates[index];
            const startDateEl = document.getElementById(`templateStartDate${index}`);
            if (!startDateEl.value) {
                alert('é–‹å§‹æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const startDate = new Date(startDateEl.value);
            
            template.days.forEach((d, i) => {
                const date = new Date(startDate);
                date.setDate(date.getDate() + i);
                const dateStr = toDateStr(date);
                
                const workDayData = { type: d.type };
                if (d.type === 'trip' && d.dest) {
                    workDayData.dest = d.dest;
                }
                data.workDays[dateStr] = workDayData;
            });
            
            saveData();
            renderAll();
            alert(`${template.name}ã‚’é©ç”¨ã—ã¾ã—ãŸï¼ˆ${template.days.length}æ—¥åˆ†ï¼‰`);
        }
        
        function deleteTemplate(index) {
            if (!confirm('ã“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            data.templates.splice(index, 1);
            saveData();
            renderTemplateList();
        }

        // ===== å®šæœŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« =====
        
        function applyRecurringSchedule() {
            const dayOfWeek = parseInt(document.getElementById('recurringDayOfWeek').value);
            const workType = document.getElementById('recurringWorkType').value;
            const tripDest = document.getElementById('recurringTripDest').value;
            const startDate = document.getElementById('recurringStartDate').value;
            const endDate = document.getElementById('recurringEndDate').value;
            const skipHolidays = document.getElementById('recurringSkipHolidays').checked;
            
            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            let current = new Date(startDate);
            const end = new Date(endDate);
            let count = 0;
            let skippedCount = 0;
            
            while (current <= end) {
                if (current.getDay() === dayOfWeek) {
                    const dateStr = toDateStr(current);
                    
                    // ç¥æ—¥ãƒã‚§ãƒƒã‚¯
                    if (skipHolidays && isHoliday(dateStr)) {
                        skippedCount++;
                    } else {
                        const workDayData = { type: workType };
                        if (workType === 'trip' && tripDest) {
                            workDayData.dest = tripDest;
                        }
                        data.workDays[dateStr] = workDayData;
                        count++;
                    }
                }
                current.setDate(current.getDate() + 1);
                
                // å®‰å…¨ã®ãŸã‚æœ€å¤§365æ—¥ã¾ã§
                if (count + skippedCount > 365) break;
            }
            
            saveData();
            renderAll();
            
            let msg = `${count}æ—¥åˆ†ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`;
            if (skippedCount > 0) {
                msg += `ï¼ˆç¥æ—¥${skippedCount}æ—¥ã‚¹ã‚­ãƒƒãƒ—ï¼‰`;
            }
            alert(msg);
        }
    </script>
</body>
</html>