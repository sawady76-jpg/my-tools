<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AI OCR for PDF (Tesseract.js + PDF.js)</title>
<style>
:root{--fg:#111;--muted:#6b7280;--accent:#2563eb;--bg:#fff}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;background:#fff;color:var(--fg)}
header{padding:14px 18px;border-bottom:1px solid #eee;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
h1{font-size:18px;margin:0}
main{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:960px){ main{grid-template-columns:1fr} }
.panel{border:1px solid #eee;border-radius:10px;overflow:hidden;background:#fff}
.panel header{border:0;background:#fafafa}
.panel .body{padding:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
select,button,input,progress{font-size:14px}
button{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer}
button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
button:disabled{opacity:.5;cursor:not-allowed}
.muted{color:var(--muted);font-size:12px}
progress{width:100%}
textarea{width:100%;min-height:360px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
.thumbgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.thumb{border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;background:#fff}
.thumb canvas{display:block;width:100%;height:auto}
.kvs{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:13px}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
footer{padding:10px 18px;color:var(--muted);font-size:12px;text-align:center}
.sep{margin:14px 0;border-top:1px dashed #e5e7eb}
</style>
<!-- ライブラリ（ブラウザ実行のみ） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
<script>
  // PDF.js ワーカー設定
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js";
</script>
</head>
<body>
<header>
  <h1>AI OCR for PDF（ブラウザ実行）</h1>
  <span class="muted">PDFを選んで「OCR開始」。複数ページを自動処理します。</span>
</header>

<main>
  <!-- 左：入力 -->
  <section class="panel">
    <header><strong>PDF入力</strong></header>
    <div class="body">
      <div class="row">
        <input id="pdfFile" type="file" accept="application/pdf"/>
        <button id="sampleBtn">サンプル読込</button>
      </div>
      <div class="row" style="margin-top:6px">
        <label>OCR言語：</label>
        <select id="lang">
          <option value="jpn">日本語 (jpn)</option>
          <option value="eng">English (eng)</option>
          <option value="jpn+eng">日本語＋英語 (jpn+eng)</option>
        </select>
        <label>出力形式：</label>
        <select id="format">
          <option value="text">プレーンテキスト（ページ区切り）</option>
          <option value="json">JSON（ページ配列）</option>
        </select>
        <label>画像倍率：</label>
        <select id="scale">
          <option value="1.2">1.2x（標準）</option>
          <option value="1.5">1.5x（高精細）</option>
          <option value="2">2x（より高精細）</option>
          <option value="1">1x（高速）</option>
        </select>
      </div>
      <div class="row" style="margin-top:6px">
        <label>ページ範囲：</label>
        <input id="range" type="text" placeholder="例: 1-3,5（空なら全ページ）" style="width:220px"/>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button id="run" class="primary" disabled>OCR開始</button>
        <button id="cancel" disabled>中止</button>
        <button id="clear" disabled>クリア</button>
      </div>
      <div class="row" style="align-items:center;margin-top:8px">
        <progress id="prog" max="1" value="0"></progress>
        <span id="status" class="muted">待機中</span>
      </div>
      <div class="hint">※ 初回は言語データ読込で数秒かかることがあります。高倍率は精度↑・速度↓。</div>

      <div class="sep"></div>
      <div class="kvs">
        <div>ファイル名</div><div id="fname" class="muted">—</div>
        <div>ページ数</div><div id="pages" class="muted">—</div>
        <div>処理対象</div><div id="targets" class="muted">—</div>
      </div>

      <div class="sep"></div>
      <div class="thumbgrid" id="thumbs" aria-label="ページプレビュー"></div>
    </div>
  </section>

  <!-- 右：結果 -->
  <section class="panel">
    <header><strong>結果</strong></header>
    <div class="body">
      <textarea id="out" placeholder="ここにOCR結果が表示されます"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="dlTxt">TXT保存</button>
        <button id="dlJson">JSON保存</button>
        <button id="copy">コピー</button>
      </div>
      <div class="hint">
        出力はページ区切り（<code>--- Page n ---</code>）付き。<br>
        JSONは <code>{ pages: [ {page, text} ] }</code> の配列形式で保存されます。
      </div>
    </div>
  </section>
</main>

<footer>© 2025 — Tesseract.js + PDF.js client-side PDF OCR</footer>

<script>
(()=> {
  const $=id=>document.getElementById(id);
  const pdfFile=$('pdfFile'), runBtn=$('run'), cancelBtn=$('cancel'), clearBtn=$('clear');
  const langSel=$('lang'), fmtSel=$('format'), scaleSel=$('scale'), rangeInput=$('range');
  const prog=$('prog'), status=$('status'), out=$('out'), thumbs=$('thumbs');
  const fname=$('fname'), pages=$('pages'), targets=$('targets');
  const dlTxt=$('dlTxt'), dlJson=$('dlJson'), copyBtn=$('copy'), sampleBtn=$('sampleBtn');

  let pdfDoc=null, pdfBlob=null, pageCount=0, cancelFlag=false;

  function reset(hard=false){
    status.textContent='待機中'; prog.value=0; runBtn.disabled=!pdfDoc; cancelBtn.disabled=true; clearBtn.disabled=!pdfDoc;
    if(hard){
      pdfDoc=null; pdfBlob=null; pageCount=0;
      fname.textContent='—'; pages.textContent='—'; targets.textContent='—';
      out.value='';
      thumbs.innerHTML='';
      runBtn.disabled=true; clearBtn.disabled=true;
    }
  }

  function parseRange(rangeStr, total){
    if(!rangeStr || !rangeStr.trim()) return Array.from({length:total},(_,i)=>i+1);
    const set=new Set();
    rangeStr.split(',').forEach(part=>{
      const m=part.trim().match(/^(\d+)(?:-(\d+))?$/);
      if(!m) return;
      let a=parseInt(m[1],10), b=m[2]?parseInt(m[2],10):a;
      if(a>b) [a,b]=[b,a];
      a=Math.max(1,Math.min(total,a)); b=Math.max(1,Math.min(total,b));
      for(let i=a;i<=b;i++) set.add(i);
    });
    return Array.from(set).sort((x,y)=>x-y);
  }

  async function loadPdfFromBlob(blob){
    pdfBlob=blob;
    const arr = await blob.arrayBuffer();
    pdfDoc = await pdfjsLib.getDocument({ data: arr }).promise;
    pageCount = pdfDoc.numPages;
    pages.textContent = String(pageCount);
    fname.textContent = (blob.name || 'document.pdf');
    targets.textContent = '—';
    thumbs.innerHTML='';
    // サムネ生成（1列目だけ＆軽量）
    const maxThumbs = Math.min(12, pageCount);
    for(let p=1; p<=maxThumbs; p++){
      const page = await pdfDoc.getPage(p);
      const viewport = page.getViewport({ scale: 0.2 });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width; canvas.height = viewport.height;
      const ctx = canvas.getContext('2d', { willReadFrequently:true });
      await page.render({ canvasContext: ctx, viewport }).promise;
      const card = document.createElement('div');
      card.className='thumb';
      card.title = `Page ${p}`;
      card.appendChild(canvas);
      thumbs.appendChild(card);
    }
    runBtn.disabled=false; clearBtn.disabled=false;
  }

  pdfFile.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    if(f.type !== 'application/pdf'){ alert('PDFファイルを選択してください。'); return; }
    await loadPdfFromBlob(f);
    reset();
  });

  // サンプル：小さな1ページPDFをJSで生成（オフライン動作用）
  sampleBtn.addEventListener('click', async ()=>{
    const blob = await makeTinyPdfBlob("令和7年10月23日\n請求金額：¥12,345\n宛先：KMネクスト 様\n品目：軽天材 50本");
    await loadPdfFromBlob(blob);
    reset();
  });

  // OCR実行
  runBtn.addEventListener('click', async ()=>{
    if(!pdfDoc) return;
    cancelFlag=false; cancelBtn.disabled=false; runBtn.disabled=true; clearBtn.disabled=true;
    out.value='';
    const scale = parseFloat(scaleSel.value || '1.2');
    const lang = langSel.value || 'jpn';
    const format = fmtSel.value || 'text';

    const targetPages = parseRange(rangeInput.value, pageCount);
    targets.textContent = `${targetPages.join(', ')}（計${targetPages.length}ページ）`;

    const results = [];
    let processed = 0;

    for(const p of targetPages){
      if(cancelFlag) break;
      status.textContent = `ページ ${p} をレンダリング中…`;
      const page = await pdfDoc.getPage(p);
      // 高精細レンダリング
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      const ctx = canvas.getContext('2d', { willReadFrequently:true });
      await page.render({ canvasContext: ctx, viewport }).promise;

      // OCR
      status.textContent = `ページ ${p} をOCR中…`;
      prog.value = processed / targetPages.length;
      let data;
      try{
        const res = await Tesseract.recognize(canvas, lang, {
          logger: m=>{
            if(m.status){
              status.textContent = `ページ ${p}: ` + m.status.replace(/_/g,' ') + (m.progress ? ` ${Math.round(m.progress*100)}%` : '');
            }
          }
        });
        data = res.data;
      }catch(e){
        console.error(e);
        data = { text: `(Page ${p}) OCRエラー: ${e?.message||e}` };
      }

      // 格納
      results.push({ page: p, text: data.text || '' });
      processed++;
      prog.value = processed / targetPages.length;
    }

    // 出力整形
    if(format === 'json'){
      out.value = JSON.stringify({ file: fname.textContent, pages: results }, null, 2);
    }else{
      const joined = results.map(r => `--- Page ${r.page} ---\n${r.text.trim()}\n`).join('\n');
      out.value = joined.trim();
    }

    status.textContent = cancelFlag ? '中止しました' : '完了';
    cancelBtn.disabled=true; runBtn.disabled=false; clearBtn.disabled=false;
  });

  cancelBtn.addEventListener('click', ()=>{ cancelFlag=true; cancelBtn.disabled=true; status.textContent='中止要求…'; });

  clearBtn.addEventListener('click', ()=>{ reset(true); pdfFile.value=''; });

  copyBtn.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(out.value||''); copyBtn.textContent='コピー済み'; setTimeout(()=>copyBtn.textContent='コピー',800); }
    catch(e){ alert('コピーに失敗しました'); }
  });

  dlTxt.addEventListener('click', ()=>{
    const blob = new Blob([out.value||''], {type:'text/plain;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = (fname.textContent || 'ocr') + '.txt'; a.click(); URL.revokeObjectURL(a.href);
  });
  dlJson.addEventListener('click', ()=>{
    let payload;
    try{
      // 既にJSONならそれを使う、テキストなら包む
      payload = out.value.trim().startsWith('{') ? out.value :
        JSON.stringify({ file: fname.textContent, pages: splitTextToPages(out.value) }, null, 2);
    }catch{ payload = JSON.stringify({ file: fname.textContent, pages: splitTextToPages(out.value) }, null, 2); }
    const blob = new Blob([payload], {type:'application/json;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download = (fname.textContent || 'ocr') + '.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  function splitTextToPages(txt){
    const arr = []; const re=/--- Page (\d+) ---\n([\s\S]*?)(?=\n--- Page \d+ ---|$)/g;
    let m; while((m=re.exec(txt))){ arr.push({ page: Number(m[1]), text: m[2].trim() }); }
    if(arr.length===0) arr.push({ page: 1, text: txt });
    return arr;
  }

  // 極小サンプルPDFを生成（テキストのみ）: 依存ライブラリ不要の超簡易版
  async function makeTinyPdfBlob(text){
    // PDF最小限バイナリ（1ページ・文字列1個）を簡易生成（日本語はレンダラ依存で見栄え簡素）
    const esc = s => s.replace(/\\/g,'\\\\').replace(/\(/g,'\\(').replace(/\)/g,'\\)');
    const lines = esc(text).split('\n').map((l,i)=>`BT /F1 12 Tf 50 ${760 - i*16} Td (${l}) Tj ET`).join('\n');
    const pdf = `%PDF-1.4
1 0 obj<</Type/Catalog/Pages 2 0 R>>endobj
2 0 obj<</Type/Pages/Kids[3 0 R]/Count 1>>endobj
3 0 obj<</Type/Page/Parent 2 0 R/MediaBox[0 0 595 842]/Contents 4 0 R/Resources<</Font<</F1 5 0 R>>>>>>endobj
4 0 obj<</Length ${lines.length+100}>>stream
${lines}
endstream endobj
5 0 obj<</Type/Font/Subtype/Type1/BaseFont/Helvetica>>endobj
xref
0 6
0000000000 65535 f 
0000000010 00000 n 
0000000062 00000 n 
0000000114 00000 n 
0000000309 00000 n 
0000000531 00000 n 
trailer<</Root 1 0 R/Size 6>>
startxref
650
%%EOF`;
    return new Blob([pdf], {type:'application/pdf'});
  }
})();
</script>

<!-- 拡張メモ：
  - PDF 内の画像が小さい場合は scale を上げると精度UP。A4日本語なら 1.2～1.5 が目安。
  - 縦書きや表は Tesseract の得手不得手があるため、後段の正規表現/LLM整形で補強が有効。
  - PDFの各ページを画像として保存したい場合：canvas.toDataURL('image/png') を利用。
  - ページごとにTSV/hOCRやバウンディングボックスが欲しい場合は format を増やして data.tsv / data.hocr / data.blocks を格納してください。
-->
</body>
</html>
