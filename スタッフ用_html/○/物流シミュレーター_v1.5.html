<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‰©æµã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v1.5 (å˜ç‹¬æ¤œè¨¼ç‰ˆ)</title>
<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; color: #333; padding: 20px; display: flex; justify-content: center; }
    .container { width: 100%; max-width: 800px; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 6px solid #0056b3; }
    
    h1 { text-align: center; color: #0056b3; margin-top: 0; font-size: 1.6rem; }
    h2 { font-size: 1.1rem; color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 30px; margin-bottom: 15px; }

    /* CSVã‚¨ãƒªã‚¢ */
    .csv-area { background: #f8f9fa; border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; transition: 0.3s; }
    .csv-area.dragover { background: #e3f2fd; border-color: #0056b3; }
    .csv-btn-group { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
    button { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-main { background: #0056b3; color: white; }
    .btn-main:hover { opacity: 0.9; }
    .btn-sub { background: #fff; border: 1px solid #aaa; color: #555; }
    .btn-sub:hover { background: #eee; }
    .btn-danger { background: #fff; border: 1px solid #d32f2f; color: #d32f2f; }
    .btn-danger:hover { background: #ffebee; }

    /* ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
    .sim-box { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end; }
    .input-group { flex: 1; min-width: 250px; }
    label { display: block; font-weight: bold; margin-bottom: 5px; color: #444; }
    select, input[type="text"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
    
    /* çµæœè¡¨ç¤º */
    .result-box { background: #e8f5e9; border: 2px solid #a5d6a7; padding: 20px; border-radius: 8px; margin-top: 20px; display: none; }
    .result-box.active { display: block; animation: fadeIn 0.3s ease; }
    .res-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ccc; padding: 8px 0; font-size: 1.1rem; }
    .res-row:last-child { border-bottom: none; }
    .res-val { font-weight: bold; color: #2e7d32; font-size: 1.3rem; }
    
    /* è£œè¶³æƒ…å ± */
    .spec-info { font-size: 0.85em; color: #666; margin-top: 5px; min-height: 1.2em; }
    .note-text { font-size: 0.75em; color: #d32f2f; display: block; }
    .pallet-note { font-size: 0.7em; color: #ef6c00; }

    /* ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« */
    .preview-table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 10px; }
    .preview-table th, .preview-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    .preview-table th { background: #eee; }
    .preview-wrapper { max-height: 200px; overflow-y: auto; border: 1px solid #ddd; margin-top: 10px; display: none; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="container">
    <h1>ğŸšš ç‰©æµã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ v1.5</h1>
    <p style="text-align:center; font-size:0.9em; color:#666;">CSVãƒ‡ãƒ¼ã‚¿ã®å½¢å¼æ¤œè¨¼ç”¨ãƒ»å˜ç‹¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³</p>

    <h2>â‘  ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (CSV)</h2>
    <div id="dropZone" class="csv-area">
        <div id="csvMessage">ã“ã“ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</div>
        <div class="csv-btn-group">
            <button class="btn-sub" onclick="downloadTemplate()">ğŸ“¥ å½¢å¼è¦‹æœ¬(CSV)ã‚’DL</button>
            <input type="file" id="fileInput" accept=".csv" style="display:none" onchange="handleFileSelect(event)">
            <button class="btn-main" onclick="document.getElementById('fileInput').click()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            <button class="btn-danger" onclick="resetData()">ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <div id="previewWrapper" class="preview-wrapper">
        <table class="preview-table">
            <thead>
                <tr><th>No</th><th>å•†å“å</th><th>å…¥æ•°</th><th>é‡é‡(kg)</th><th>PLç©è¼‰æ•°</th><th>é•·å°º</th></tr>
            </thead>
            <tbody id="previewBody"></tbody>
        </table>
    </div>

    <h2>â‘¡ è¨ˆç®—å®Ÿè¡Œ</h2>
    <div class="sim-box">
        <div class="input-group">
            <label>å•†å“æ¤œç´¢ãƒ»é¸æŠ</label>
            <input type="text" id="filterInput" placeholder="å“åã§çµã‚Šè¾¼ã¿..." oninput="filterList()" style="margin-bottom:5px;">
            <select id="productSelect" size="5" style="height:100px;" onchange="calc()">
                <option value="">(ãƒ‡ãƒ¼ã‚¿ãªã—)</option>
            </select>
            <div id="specInfo" class="spec-info"></div>
        </div>
        <div class="input-group" style="flex:0 0 150px;">
            <label>æ•°é‡ (ãƒãƒ©)</label>
            <input type="number" id="inputQty" placeholder="0" oninput="calc()">
        </div>
    </div>

    <div id="resultBox" class="result-box">
        <div class="res-row">
            <span>ğŸ“¦ è·å§¿</span>
            <span id="resCase" class="res-val">-</span>
        </div>
        <div class="res-row">
            <span>âš–ï¸ ç·é‡é‡</span>
            <span id="resWeight" class="res-val">-</span>
        </div>
        <div class="res-row">
            <span>ğŸ—ï¸ ãƒ‘ãƒ¬ãƒƒãƒˆ</span>
            <span id="resPallet" class="res-val">-</span>
        </div>
    </div>

</div>

<script>
    // --- åˆæœŸãƒ‡ãƒ¼ã‚¿ (CSVãŒãªã„å ´åˆç”¨) ---
    const defaultData = [
        { name: "ã€ã‚µãƒ³ãƒ—ãƒ«ã€‘ã‚¢ãƒ³ã‚«ãƒ¼ãƒœãƒ«ãƒˆ M12Ã—400", perCase: 50, weight: 16.25, perPallet: 48, isLong: false },
        { name: "ã€ã‚µãƒ³ãƒ—ãƒ«ã€‘ãƒ—ãƒ©ãƒ™ãƒ‹ãƒ¤ 2.5mm", perCase: 20, weight: 10.0, perPallet: 42, isLong: true },
        { name: "ã€ã‚µãƒ³ãƒ—ãƒ«ã€‘ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆã‚µã‚¤ã‚³ãƒ­", perCase: 200, weight: 21.6, perPallet: 40, isLong: false }
    ];
    let appData = [...defaultData];

    // --- åˆæœŸåŒ– ---
    window.onload = function() {
        // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
        const stored = localStorage.getItem('logisim_v1.5_data');
        if (stored) {
            appData = JSON.parse(stored);
            document.getElementById('csvMessage').textContent = `âœ… ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­ (${appData.length}ä»¶)`;
            showPreview(appData);
        }
        renderSelect(appData);

        // D&Dã‚¤ãƒ™ãƒ³ãƒˆ
        const zone = document.getElementById('dropZone');
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', e => { e.preventDefault(); zone.classList.remove('dragover'); });
        zone.addEventListener('drop', handleDrop);
    };

    // --- CSVå‡¦ç† ---
    function downloadTemplate() {
        // Excelã§é–‹ãã‚„ã™ã„BOMä»˜ãUTF-8 CSV
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const csvContent = "å•†å“å,å…¥æ•°(å€‹/ç®±),ã‚±ãƒ¼ã‚¹é‡é‡(kg),ãƒ‘ãƒ¬ãƒƒãƒˆç©è¼‰æ•°(ç®±),é•·å°ºãƒ•ãƒ©ã‚°(1=é•·å°º)\nã‚µãƒ³ãƒ—ãƒ«A,10,15.5,50,0\nã‚µãƒ³ãƒ—ãƒ«é•·å°ºB,20,10.0,40,1";
        const blob = new Blob([bom, csvContent], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = "ç‰©æµã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ç”¨ãƒ‡ãƒ¼ã‚¿é››å½¢.csv";
        link.click();
    }

    function handleFileSelect(e) { processFile(e.target.files[0]); }
    function handleDrop(e) {
        e.preventDefault();
        document.getElementById('dropZone').classList.remove('dragover');
        processFile(e.dataTransfer.files[0]);
    }

    function processFile(file) {
        if (!file || !file.name.toLowerCase().endsWith('.csv')) { alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
        
        const reader = new FileReader();
        reader.onload = e => {
            const text = e.target.result;
            const lines = text.split(/\r\n|\n/);
            const newData = [];
            
            // 1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ã‚¹ã‚­ãƒƒãƒ—
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼ˆç°¡æ˜“ãƒ‘ãƒ¼ã‚¹ï¼‰
                const cols = line.split(',');
                if (cols.length < 3) continue; // æœ€ä½é™ã®åˆ—ãƒã‚§ãƒƒã‚¯

                // ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚° (åˆ—é †åºã®ä»®å®š: 0:å, 1:å…¥æ•°, 2:é‡é‡, 3:PLæ•°, 4:é•·å°º)
                const item = {
                    name: cols[0],
                    perCase: parseFloat(cols[1]) || 1,
                    weight: parseFloat(cols[2]) || 0,
                    perPallet: parseFloat(cols[3]) || 0,
                    isLong: (cols[4] && cols[4].trim() === "1") ? true : false
                };
                if (item.name) newData.push(item);
            }

            if (newData.length > 0) {
                appData = newData;
                localStorage.setItem('logisim_v1.5_data', JSON.stringify(appData));
                renderSelect(appData);
                showPreview(appData);
                document.getElementById('csvMessage').textContent = `âœ… ${newData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
                document.getElementById('filterInput').value = '';
                document.getElementById('resultBox').classList.remove('active');
            } else {
                alert("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        };
        reader.readAsText(file);
    }

    function resetData() {
        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('logisim_v1.5_data');
            appData = [...defaultData];
            renderSelect(appData);
            document.getElementById('previewWrapper').style.display = 'none';
            document.getElementById('csvMessage').textContent = "ã“ã“ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—";
        }
    }

    // --- UIè¡¨ç¤ºç³» ---
    function showPreview(data) {
        const tbody = document.getElementById('previewBody');
        tbody.innerHTML = "";
        // å…¨ä»¶è¡¨ç¤ºã¯é‡ã„ã®ã§å…ˆé ­50ä»¶ã®ã¿
        data.slice(0, 50).forEach((d, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i+1}</td><td>${d.name}</td><td>${d.perCase}</td><td>${d.weight}</td><td>${d.perPallet}</td><td>${d.isLong?'ã€‡':'-'}</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('previewWrapper').style.display = 'block';
    }

    function renderSelect(list) {
        const select = document.getElementById('productSelect');
        select.innerHTML = "";
        if (list.length === 0) {
            const opt = document.createElement('option');
            opt.text = "è©²å½“ãªã—";
            select.appendChild(opt);
            return;
        }
        list.forEach((d) => {
            const opt = document.createElement('option');
            // ãƒ‡ãƒ¼ã‚¿é…åˆ—å†…ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’valueã«ã™ã‚‹ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ™‚ã¯å†æ¤œç´¢ãŒå¿…è¦ï¼‰
            opt.value = appData.indexOf(d); 
            opt.text = d.name;
            select.appendChild(opt);
        });
    }

    function filterList() {
        const key = document.getElementById('filterInput').value.toLowerCase();
        const filtered = appData.filter(d => d.name.toLowerCase().includes(key));
        renderSelect(filtered);
        document.getElementById('resultBox').classList.remove('active');
        document.getElementById('specInfo').textContent = "";
    }

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    function calc() {
        const idx = document.getElementById('productSelect').value;
        const qty = parseInt(document.getElementById('inputQty').value);
        const resBox = document.getElementById('resultBox');
        
        if (idx === "" || isNaN(qty) || qty < 0) {
            resBox.classList.remove('active');
            return;
        }

        const item = appData[idx]; // å…ƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
        
        // ã‚¹ãƒšãƒƒã‚¯è¡¨ç¤º
        let spec = `å…¥æ•°:${item.perCase} / é‡é‡:${item.weight}kg`;
        if (item.perPallet > 0) spec += ` / PL:${item.perPallet}ç®±`;
        document.getElementById('specInfo').textContent = spec;

        // è¨ˆç®—
        const cases = Math.floor(qty / item.perCase);
        const mod = qty % item.perCase;
        
        // è·å§¿
        let caseStr = "";
        if (item.perCase === 1) caseStr = `${qty} å€‹(æš/æœ¬)`;
        else caseStr = `${cases} ã‚±ãƒ¼ã‚¹` + (mod > 0 ? ` + ãƒãƒ© ${mod}` : "");
        if (qty === 0) caseStr = "0";

        // é‡é‡
        const unitWeight = item.weight / item.perCase;
        const totalW = qty * unitWeight;
        
        // ãƒ‘ãƒ¬ãƒƒãƒˆ
        let plStr = "";
        let plType = item.isLong ? "é•·å°º(900Ã—1800)" : "é€šå¸¸(1100Ã—1100)";
        
        if (item.perPallet > 0) {
            // ãƒ‘ãƒ¬ãƒƒãƒˆã«ä¹—ã›ã‚‹ç®±æ•°ï¼ˆãƒãƒ©ãŒå‡ºãŸã‚‰1ç®±åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ã¨ã¿ãªã™ï¼‰
            let loadCount = (item.perCase === 1) ? qty : (cases + (mod > 0 ? 1 : 0));
            
            const plNum = Math.floor(loadCount / item.perPallet);
            const plMod = loadCount % item.perPallet;
            const plRatio = (loadCount / item.perPallet).toFixed(2);

            if (parseFloat(plRatio) === 0.00) {
                plStr = "0 PL";
            } else if (plNum === 0) {
                plStr = `0 PL <span class="note-text">â€»ãƒ‘ãƒ¬ãƒƒãƒˆæœªæº€</span><span class="pallet-note">(${plType} ç´„${plRatio}æšåˆ†)</span>`;
            } else {
                plStr = `${plNum} PL` + (plMod > 0 ? ` + ${plMod} ç®±` : "");
                plStr += `<span class="pallet-note"><br>(${plType} ç´„${plRatio}æšåˆ†)</span>`;
            }
        } else {
            plStr = `0 PL <span class="note-text">â€»ç©è¼‰ãƒ‡ãƒ¼ã‚¿ãªã—</span>`;
        }

        document.getElementById('resCase').textContent = caseStr;
        document.getElementById('resWeight').textContent = `ç´„ ${totalW.toFixed(1)} kg`;
        document.getElementById('resPallet').innerHTML = plStr;
        resBox.classList.add('active');
    }
</script>

</body>
</html>